<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Diagnostic Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-good { color: #00AC18; }
        .status-bad { color: #EE4D3D; }
        .status-warning { color: #F59E0B; }
        .log-entry { font-family: monospace; font-size: 12px; padding: 4px 8px; border-bottom: 1px solid #e5e5e5; }
        .log-success { background: #f0fdf4; }
        .log-error { background: #fef2f2; }
        .log-warning { background: #fffbeb; }
        .log-info { background: #f0f9ff; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Supabase Diagnostic Tool</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Connection Status</h2>
            <div id="connection-status" class="text-lg font-semibold">Checking...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Data Size Analysis</h2>
            <div id="data-size-info" class="space-y-2">Not tested yet</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Performance Test</h2>
            <div class="flex gap-4 mb-4">
                <button onclick="testReadSpeed()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Test Read Speed</button>
                <button onclick="testWriteSpeed()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Test Write Speed</button>
                <button onclick="testNetworkLatency()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Test Network Latency</button>
            </div>
            <div id="performance-results" class="text-sm"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Error Log</h2>
            <button onclick="clearLog()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mb-2">Clear Log</button>
            <div id="log-container" class="max-h-96 overflow-y-auto border rounded"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Recommended Fixes</h2>
            <div id="recommendations" class="space-y-3 text-sm"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Configuration from the original file
        const supabaseUrl = 'https://lgovvztkuqnpsshdrwyu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnb3Z2enRrdXFucHNzaGRyd3l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTY0OTgsImV4cCI6MjA4NTU5MjQ5OH0.0gks6pz9g8JCP6LMiKEGQj3J-M27ljGPLwv-umyoPVA';
        
        let supabase;

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        window.clearLog = () => {
            document.getElementById('log-container').innerHTML = '';
        };

        async function checkConnection() {
            log('Testing Supabase connection...', 'info');
            
            try {
                supabase = createClient(supabaseUrl, supabaseKey);
                
                const startTime = Date.now();
                const { data, error } = await supabase
                    .from('app_data')
                    .select('id')
                    .limit(1);
                
                const endTime = Date.now();
                const latency = endTime - startTime;

                if (error) {
                    log(`Connection failed: ${error.message}`, 'error');
                    log(`Error code: ${error.code}`, 'error');
                    log(`Error details: ${JSON.stringify(error)}`, 'error');
                    document.getElementById('connection-status').innerHTML = 
                        '<span class="status-bad">Failed to connect</span>';
                    return false;
                }

                log(`Connection successful! Latency: ${latency}ms`, 'success');
                document.getElementById('connection-status').innerHTML = 
                    `<span class="status-good">Connected (${latency}ms)</span>`;
                return true;
            } catch (e) {
                log(`Exception during connection: ${e.message}`, 'error');
                document.getElementById('connection-status').innerHTML = 
                    '<span class="status-bad">Connection error</span>';
                return false;
            }
        }

        async function checkDataSize() {
            log('Checking data size...', 'info');
            
            try {
                const startTime = Date.now();
                const { data, error } = await supabase
                    .from('app_data')
                    .select('data')
                    .eq('id', 'master_record')
                    .single();
                
                const endTime = Date.now();

                if (error) {
                    log(`Failed to fetch data: ${error.message}`, 'error');
                    document.getElementById('data-size-info').innerHTML = 
                        '<span class="status-bad">Failed to check data size</span>';
                    return;
                }

                const dataSize = JSON.stringify(data).length;
                const dataSizeKB = (dataSize / 1024).toFixed(2);
                const fetchTime = endTime - startTime;

                log(`Data size: ${dataSizeKB} KB`, 'info');
                log(`Fetch time: ${fetchTime}ms`, 'info');

                const sizeInfo = document.getElementById('data-size-info');
                sizeInfo.innerHTML = `
                    <div class="flex justify-between"><span>Total Data Size:</span><span class="${dataSize > 1000 ? 'status-warning' : 'status-good'}">${dataSizeKB} KB</span></div>
                    <div class="flex justify-between"><span>Fetch Time:</span><span>${fetchTime}ms</span></div>
                    <div class="flex justify-between"><span>Data Keys:</span><span>${Object.keys(data.data || {}).length}</span></div>
                `;

                // Check if data is too large
                if (dataSize > 1000) {
                    log('WARNING: Data size exceeds 1MB - this may cause performance issues', 'warning');
                    addRecommendation('Data size is large. Consider archiving old data or splitting into multiple tables.', 'warning');
                }

            } catch (e) {
                log(`Exception checking data size: ${e.message}`, 'error');
            }
        }

        window.testReadSpeed = async () => {
            log('Testing read speed (5 consecutive reads)...', 'info');
            
            const results = [];
            for (let i = 0; i < 5; i++) {
                const start = Date.now();
                const { error } = await supabase
                    .from('app_data')
                    .select('data')
                    .eq('id', 'master_record')
                    .single();
                const end = Date.now();
                const duration = end - start;
                results.push(duration);
                
                if (error) {
                    log(`Read ${i+1} failed: ${error.message}`, 'error');
                } else {
                    log(`Read ${i+1}: ${duration}ms`, 'success');
                }
            }

            const avg = (results.reduce((a, b) => a + b, 0) / results.length).toFixed(2);
            const max = Math.max(...results);
            
            const perfDiv = document.getElementById('performance-results');
            perfDiv.innerHTML += `<div class="mt-2"><strong>Read Results:</strong> Average: ${avg}ms, Max: ${max}ms</div>`;

            if (avg > 2000) {
                addRecommendation('Read speed is slow (>2s average). This indicates network issues or large data size.', 'warning');
            }
        };

        window.testWriteSpeed = async () => {
            log('Testing write speed (3 consecutive writes)...', 'info');
            
            const results = [];
            for (let i = 0; i < 3; i++) {
                const start = Date.now();
                const testData = { test: true, timestamp: new Date().toISOString() };
                const { error } = await supabase
                    .from('app_data')
                    .upsert({
                        id: `test_write_${Date.now()}`,
                        data: testData,
                        updated_at: new Date().toISOString()
                    });
                const end = Date.now();
                const duration = end - start;
                results.push(duration);
                
                if (error) {
                    log(`Write ${i+1} failed: ${error.message}`, 'error');
                } else {
                    log(`Write ${i+1}: ${duration}ms`, 'success');
                }
            }

            const avg = (results.reduce((a, b) => a + b, 0) / results.length).toFixed(2);
            const max = Math.max(...results);
            
            const perfDiv = document.getElementById('performance-results');
            perfDiv.innerHTML += `<div class="mt-2"><strong>Write Results:</strong> Average: ${avg}ms, Max: ${max}ms</div>`;

            if (avg > 5000) {
                addRecommendation('Write speed is very slow (>5s average). Check network connectivity and Supabase project status.', 'error');
            }
        };

        window.testNetworkLatency = async () => {
            log('Testing network latency...', 'info');
            
            const pings = [];
            for (let i = 0; i < 10; i++) {
                const start = Date.now();
                try {
                    await fetch(supabaseUrl, { mode: 'no-cors' });
                } catch (e) {
                    // no-cors mode will throw, but we still get timing
                }
                const end = Date.now();
                pings.push(end - start);
                log(`Ping ${i+1}: ${end - start}ms`, 'info');
                await new Promise(r => setTimeout(r, 100));
            }

            const avg = (pings.reduce((a, b) => a + b, 0) / pings.length).toFixed(2);
            const max = Math.max(...pings);
            const min = Math.min(...pings);
            
            const perfDiv = document.getElementById('performance-results');
            perfDiv.innerHTML += `<div class="mt-2"><strong>Network Latency:</strong> Min: ${min}ms, Avg: ${avg}ms, Max: ${max}ms</div>`;

            if (avg > 500) {
                addRecommendation('Network latency is high (>500ms average). This may cause slow sync performance.', 'warning');
            }
        };

        function addRecommendation(message, type) {
            const container = document.getElementById('recommendations');
            const div = document.createElement('div');
            div.className = `p-3 rounded ${type === 'error' ? 'bg-red-50 border border-red-200' : type === 'warning' ? 'bg-yellow-50 border border-yellow-200' : 'bg-blue-50 border border-blue-200'}`;
            div.innerHTML = `<span class="${type === 'error' ? 'status-bad' : type === 'warning' ? 'status-warning' : 'status-good'} font-bold">${type.toUpperCase()}:</span> ${message}`;
            container.appendChild(div);
        }

        // Run initial checks
        async function runDiagnostics() {
            log('=== Starting Supabase Diagnostics ===', 'info');
            
            const connected = await checkConnection();
            if (connected) {
                await checkDataSize();
            }
            
            // Add initial recommendations
            addRecommendation('Ensure your Supabase project is active and not paused', 'info');
            addRecommendation('Check Row Level Security (RLS) policies allow public access', 'info');
            addRecommendation('Verify your API key has not expired', 'info');
            addRecommendation('Consider implementing retry logic for failed operations', 'info');
            addRecommendation('Add timeout configuration to Supabase client', 'info');
        }

        // Start diagnostics
        runDiagnostics();
    </script>
</body>
</html>