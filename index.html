<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduTrack LMS | Firebase Connected</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { 
                            base: '#2D3B45', 
                            primary: '#0e1e24', 
                            accent: '#0374B5', 
                            danger: '#EE4D3D', 
                            success: '#00AC18',
                            light: '#F5F5F5'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F5; color: #2D3B45; }
        
        /* Global Nav */
        #global-nav { width: 84px; flex-shrink: 0; background-color: #2D3B45; display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; }
        .nav-item { color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; }
        .nav-item:hover { background-color: #fff; color: #2D3B45; }
        .nav-item.active { background-color: #fff; color: #0374B5; border-left: 4px solid #0374B5; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }

        /* Course Cards */
        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .course-header { height: 140px; background-size: cover; background-position: center; position: relative; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #E2E8F0; border: 1px solid #E2E8F0; }
        .cal-cell { background: white; min-height: 120px; padding: 0.5rem; position: relative; }
        .cal-cell.today { background: #F0F9FF; }
        .event-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; items-center; gap: 4px; transition: transform 0.1s; font-weight: 700; }
        .event-pill:hover { transform: scale(1.02); z-index: 10; }
        
        /* Feed */
        .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; margin-top: 10px; } 
        .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #global-nav { width: 100%; height: 60px; flex-direction: row; padding: 0; justify-content: space-around; position: fixed; bottom: 0; }
            .nav-item { padding: 0.5rem; }
            .nav-label { display: none; }
            #content-area { padding-bottom: 80px; }
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .cal-cell { min-height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
            .cal-header-row { display: none; }
        }
        
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; items-center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; items-center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        
        /* Tables */
        .grade-table th { white-space: nowrap; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin text-4xl"></i>
        <p class="font-bold tracking-widest">CONNECTING TO DATABASE...</p>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved to Firebase</div>

    <!-- Main App -->
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <!-- Modal Portal -->
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- FIREBASE CONFIGURATION ---
let firebaseConfig;
const userConfig = {
    apiKey: "AIzaSyAZhN6M2AOAi_9NGgHw-lU-vZDDBGyIEAY",
    authDomain: "schoollms-475c9.firebaseapp.com",
    projectId: "schoollms-475c9",
    storageBucket: "schoollms-475c9.firebasestorage.app",
    messagingSenderId: "123401573481",
    appId: "1:123401573481:web:ca5179b069919236797ef8"
};

let appId = 'schoollms-v1'; 

if (typeof __firebase_config !== 'undefined') {
    firebaseConfig = JSON.parse(__firebase_config);
    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
} else {
    firebaseConfig = userConfig;
}

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const dbStore = getFirestore(app);

// Data Path: Single Master Record for easy syncing
const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data/school_system`;
const MASTER_DOC_ID = 'master_record';

/**
 * ------------------------------------------------------------------
 * DATA STORE & STATE
 * ------------------------------------------------------------------
 */
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u3', name: 'Maria Santos', role: 'student', username: 'student2', password: '123', avatar: 'MS' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '0916Saidee', avatar: 'AD' } 
    ],
    subjects: [
        { 
            id: 's1', 
            name: 'Introduction to Physics', 
            code: 'PHYS-101', 
            teacherId: 'u1', 
            students: ['u2', 'u3'], 
            color: '#0374B5', 
            img: 'https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=600&q=80',
            introTitle: 'Welcome to Physics',
            introBody: 'Check the feed for daily updates.',
            gradingWeights: { ww: 40, pt: 40, qa: 20 }
        }
    ],
    posts: [
        { 
            id: 'p1', courseId: 's1', authorId: 'u1', authorName: 'Mrs. Anderson', date: '2023-10-24T09:00',
            content: 'Please review this video on Newton\'s Laws.',
            mediaType: 'video', mediaUrl: 'https://www.youtube.com/embed/kKKM8Y-u7ds',
            isPinned: false
        }
    ],
    globalPosts: [],
    // Manual Activities (Performance Tasks, Manual Written Work)
    activities: {
        's1': [
            { id: 'a1', title: 'Lab Report #1', maxScore: 50, category: 'pt', date: '2023-10-28', allowSubmission: false, isLocked: false }
        ]
    },
    // Grades for Manual Activities
    activitySubmissions: {
        // Structure: 'a1': { 'u2': { score: 45, text: "My Report...", date: "..." } }
    },
    exams: {
        's1': [
            { 
                id: 'e1', title: 'Forces Quiz', openDate: '2023-10-25T08:00', dueDate: '2025-12-31T23:59', 
                timeLimit: 30, attempts: 1, category: 'ww', isLocked: false,
                questions: [{q:'F=ma?', type:'mc', options:['Yes','No'], ans:0}] 
            }
        ]
    },
    examSubmissions: {
        'e1': { 'u2': { score: 100, answers: [0], attemptsTaken: 1 } }
    }
};

// Global State
let db = defaultData; 
let currentUser = null;
let currentView = 'login'; 
let currentCourseId = null;
let activeExamId = null;
let activeActivityId = null;
let currentTab = 'home';
let calendarDate = new Date();
let importedText = ''; 
let tempPostImage = null; 
let tempTeacherImage = null;
let adminCourseFilter = 'all';
let selectedLoginRole = null; 
let firebaseUser = null; 

// Builder State
let builderQuestions = [];

// --- FIREBASE SYNC LOGIC ---

async function initFirebase() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                firebaseUser = user;
                const docRef = doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID);
                
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        db = docSnap.data();
                        // Migration Check
                        if(!db.activities) db.activities = {};
                        if(!db.activitySubmissions) db.activitySubmissions = {};
                        db.subjects.forEach(s => {
                             if(!s.gradingWeights) s.gradingWeights = { ww: 40, pt: 40, qa: 20 };
                        });
                        if (currentUser) render(); 
                    } else {
                        setDoc(docRef, defaultData);
                        db = defaultData;
                    }
                    const loader = document.getElementById('loading-screen');
                    if(loader) {
                        loader.style.opacity = 0;
                        setTimeout(() => loader.remove(), 500);
                        document.getElementById('app').classList.remove('opacity-0');
                    }
                    if(!currentUser) render(); 
                }, (error) => {
                     console.error("Firestore Read Error:", error);
                     showToast("Database Access Denied: " + error.message, "error");
                });
            }
        });
    } catch (e) {
        console.error("Firebase Init Error:", e);
        showToast("Firebase Connection Failed: " + e.message, "error");
    }
}

async function saveDB() {
    if (!firebaseUser) return;
    const status = document.getElementById('sync-status');
    if(status) status.style.opacity = 1;
    
    try {
        const docRef = doc(dbStore, PUBLIC_DATA_PATH, MASTER_DOC_ID);
        await setDoc(docRef, db);
        if(status) setTimeout(() => status.style.opacity = 0, 1000);
    } catch (e) {
        console.error("Save Error:", e);
        showToast("Error saving data: " + e.message, "error");
    }
}

initFirebase();

// --- APP HELPERS ---
const $ = (id) => document.getElementById(id);
window.$ = $; 

const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const showToast = (msg, type='info') => {
    const box = document.createElement('div');
    box.className = `px-4 py-3 rounded shadow-lg text-white font-bold transform transition-all duration-300 translate-y-4 pointer-events-auto ${type==='error'?'bg-canvas-danger':'bg-canvas-accent'}`;
    box.innerText = msg;
    $('toast-container').appendChild(box);
    setTimeout(()=>box.remove(), 3000);
};

const showConfirm = (message, onYes) => {
    const id = 'confirm-modal';
    const html = `
        <div class="space-y-4">
            <p class="text-gray-700 font-bold">${message}</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('${id}')" class="px-4 py-2 rounded border hover:bg-gray-100 font-bold text-gray-500">Cancel</button>
                <button id="confirm-yes-btn" class="px-4 py-2 rounded bg-canvas-danger text-white font-bold hover:bg-red-600">Confirm</button>
            </div>
        </div>
    `;
    renderModal(id, 'Confirmation', html);
    setTimeout(() => {
        const btn = document.getElementById('confirm-yes-btn');
        if(btn) btn.onclick = () => { onYes(); closeModal(id); };
    }, 50);
};

// --- QUIZ PARSER (For Import only now) ---
window.parseQuizText = (text) => {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let currQ = null;
    let currPassage = '';
    let tempBuffer = '';

    if (lines.some(l => l.includes('|')) && !lines.some(l => l.match(/^\d+[\.\)]/))) {
         lines.forEach(l => { 
             const p = l.replace(/^\d+[\.)]\s*/, '').split('|'); 
             if(p.length>=3) questions.push({ q:p[0].trim(), type:'mc', options:p[1].split(',').map(x=>x.trim()), ans:parseInt(p[2].trim()) }); 
         });
    } else {
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const ansMatch = line.match(/^(?:Answer|Ans|Key)[\s:\-\.]*([A-Z])/i) || line.match(/^\*([A-Z])/i);
            if (ansMatch && currQ) {
                let code = ansMatch[1].toUpperCase().charCodeAt(0) - 65;
                if(code >= 0 && code < 26) currQ.ans = code;
                continue;
            }
            const optMatch = line.match(/^[\(\s]*([A-Z])[\.\)\s]\s*(.*)/i);
            if (optMatch && currQ) {
                currQ.options.push(optMatch[2].trim());
                continue;
            }
            const qMatch = line.match(/^(\d+)[\.\)\s]\s*(.*)/);
            if (qMatch) {
                if (currQ) { if(currQ.options.length > 0) questions.push(currQ); }
                if (tempBuffer) { currPassage = tempBuffer.trim(); tempBuffer = ''; }
                let qText = qMatch[2].trim();
                currQ = { q: qText, type: 'mc', options: [], ans: 0, passage: currPassage };
                continue;
            }
            if (line.length < 2 && !line.match(/[a-z]/i)) continue;
            if (tempBuffer) tempBuffer += '\n';
            tempBuffer += line;
        }
        if (currQ && currQ.options.length > 0) questions.push(currQ);
    }
    return questions;
};

// --- ROUTER & LAYOUT ---
function render() {
    const app = $('app');
    if (!app) return;
    app.innerHTML = '';
    
    if(currentView === 'login') {
        renderLogin(app);
    } else {
        app.innerHTML = `
            <div id="main-layout" class="flex w-full h-full bg-[#F5F5F5]">
                <nav id="global-nav">
                    <div class="mb-6 hidden md:block"><i class="fas fa-shapes text-3xl text-white"></i></div>
                    <div class="nav-item ${currentView==='dashboard'?'active':''}" onclick="goDashboard()">
                        <i class="fas fa-tachometer-alt nav-icon"></i><span class="nav-label">Dashboard</span>
                    </div>
                    
                    ${currentUser.role === 'admin' ? `
                    <div class="nav-item ${currentView==='teachers_list'?'active':''}" onclick="goTeachersList()">
                        <i class="fas fa-chalkboard-teacher nav-icon"></i><span class="nav-label">Teachers</span>
                    </div>
                    ` : ''}

                    <div class="nav-item ${currentView==='courses_list' || currentView==='course'?'active':''}" onclick="goCoursesList()"> 
                        <i class="fas fa-book nav-icon"></i><span class="nav-label">Courses</span>
                    </div>
                    <div class="nav-item ${currentView==='calendar'?'active':''}" onclick="goCalendar()">
                        <i class="fas fa-calendar-alt nav-icon"></i><span class="nav-label">Calendar</span>
                    </div>
                    <div class="nav-item ${currentView==='settings'?'active':''}" onclick="goSettings()">
                        <i class="fas fa-cog nav-icon"></i><span class="nav-label">Settings</span>
                    </div>
                    <div class="mt-auto mb-4 nav-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt nav-icon text-gray-400"></i><span class="nav-label text-gray-400">Logout</span>
                    </div>
                </nav>
                <main id="content-area" class="flex-1 overflow-y-auto relative">
                    <header class="bg-white border-b border-gray-300 h-16 flex items-center justify-between px-6 sticky top-0 z-40">
                        <div class="flex items-center gap-2 text-canvas-base">
                            <h2 class="font-bold text-lg uppercase tracking-wide" id="page-title">Dashboard</h2>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-gray-600">${currentUser.name}</span>
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs font-bold text-gray-600">${currentUser.avatar}</div>
                        </div>
                    </header>
                    <div id="page-content" class="p-6 md:p-8 max-w-7xl mx-auto"></div>
                </main>
            </div>
        `;
        const c = $('page-content');
        if(currentView === 'dashboard') renderDashboard(c);
        if(currentView === 'teachers_list') renderTeachersList(c);
        if(currentView === 'courses_list') renderCoursesList(c);
        if(currentView === 'calendar') renderCalendar(c);
        if(currentView === 'course') renderCourse(c);
        if(currentView === 'exam-take') renderExamTake(c);
        if(currentView === 'exam-review') renderExamReview(c);
        if(currentView === 'activity-do') renderActivityDo(c);
        if(currentView === 'settings') renderSettings(c);
    }
}

// Global Nav Handlers
window.goDashboard = () => { currentView = 'dashboard'; render(); }
window.goTeachersList = () => { currentView = 'teachers_list'; render(); }
window.goCoursesList = () => { currentView = 'courses_list'; render(); }
window.goCalendar = () => { currentView = 'calendar'; render(); }
window.goSettings = () => { currentView = 'settings'; render(); }
window.logout = () => { currentUser = null; currentView = 'login'; selectedLoginRole = null; render(); }
window.render = render; 

// Auth & Login (Same as previous)
function renderLogin(c) {
    c.innerHTML = `
        <div class="flex h-screen w-full bg-[#2D3B45] items-center justify-center">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <i class="fas fa-shapes text-5xl text-canvas-accent mb-6 inline-block"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EduTrack LMS</h1>
                <p class="text-gray-500 mb-8" id="login-subtext">Select your portal to continue</p>
                <div id="role-selector" class="space-y-4 animate-fade-in">
                    <button onclick="showLoginForm('teacher')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition text-lg"><i class="fas fa-chalkboard-teacher"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Teacher Login</span><span class="text-xs text-gray-400">Faculty access & management</span></div>
                    </button>
                    <button onclick="showLoginForm('student')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-green-100 text-green-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition text-lg"><i class="fas fa-user-graduate"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Student Login</span><span class="text-xs text-gray-400">Access courses</span></div>
                    </button>
                    <button onclick="showLoginForm('admin')" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-200 p-4 rounded-xl hover:border-canvas-accent hover:text-canvas-accent transition group shadow-sm">
                        <div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition text-lg"><i class="fas fa-user-shield"></i></div>
                        <div class="text-left flex-1"><span class="block font-bold text-lg text-gray-700 group-hover:text-canvas-accent">Admin Login</span><span class="text-xs text-gray-400">System config</span></div>
                    </button>
                </div>
                <div id="login-form-box" class="hidden text-left animate-fade-in">
                    <div class="flex items-center mb-6">
                        <button onclick="hideLoginForm()" class="text-gray-400 hover:text-gray-600 mr-3 p-2 rounded-full hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold text-gray-800" id="form-role-title">Login</h2>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Username</label><input id="login-user" type="text" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div>
                        <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label><input id="login-pass" type="password" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-canvas-accent transition"></div>
                        <button onclick="loginAttempt()" class="w-full bg-canvas-accent text-white font-bold py-3.5 rounded-lg hover:bg-blue-700 transition shadow-lg mt-2">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}
window.showLoginForm = (role) => { selectedLoginRole = role; $('role-selector').classList.add('hidden'); $('login-subtext').classList.add('hidden'); $('login-form-box').classList.remove('hidden'); $('form-role-title').innerText = {'teacher':'Teacher','student':'Student','admin':'Admin'}[role]; setTimeout(() => $('login-user').focus(), 100); }
window.hideLoginForm = () => { selectedLoginRole = null; $('role-selector').classList.remove('hidden'); $('login-subtext').classList.remove('hidden'); $('login-form-box').classList.add('hidden'); $('login-user').value = ''; $('login-pass').value = ''; }
window.loginAttempt = () => { const u = $('login-user').value.toLowerCase().trim(), p = $('login-pass').value.trim(), user = db.users.find(x => x.username === u); if(user && user.password === p) { if (selectedLoginRole && user.role !== selectedLoginRole) { showToast(`This account is not a ${selectedLoginRole}.`, 'error'); return; } currentUser = user; goDashboard(); } else { showToast('Invalid Username or Password', 'error'); } }

// Dashboard, Teachers, Settings (Minimal changes)
function renderDashboard(c) {
    if(currentUser.role === 'admin') {
        c.innerHTML = `<div class="bg-white p-6 rounded shadow">Admin Dashboard (Manage Teachers/Posts via Nav)</div>`;
    } else {
        c.innerHTML = `<div class="max-w-4xl mx-auto"><h2 class="text-2xl font-bold mb-4">News</h2>${(db.globalPosts||[]).length>0?db.globalPosts.map(p=>`<div class="bg-white p-4 mb-4 rounded shadow border"><b>${p.title}</b><p>${p.content}</p></div>`).join(''):'<div class="bg-white p-12 text-center text-gray-400">No News</div>'}</div>`;
    }
}
function renderTeachersList(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    c.innerHTML = `<h2 class="text-xl font-bold mb-4">Teachers</h2>${db.users.filter(u=>u.role==='teacher').map(t=>`<div class="bg-white p-4 mb-2 rounded border flex justify-between"><span>${t.name} (${t.username})</span><button onclick="deleteUser('${t.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`).join('')}`;
}
window.deleteUser = (uid) => { showConfirm('Delete?', () => { db.users=db.users.filter(u=>u.id!==uid); saveDB(); render(); }); }
function renderSettings(c) {
    c.innerHTML = `<div class="bg-white p-6 rounded shadow max-w-md mx-auto"><h3 class="font-bold mb-4">Settings</h3><input id="new-pw" type="password" class="border p-2 w-full mb-2" placeholder="New Password"><button onclick="updatePw()" class="bg-canvas-accent text-white px-4 py-2 rounded">Update</button></div>`;
}
window.updatePw = () => { const v=$('new-pw').value; if(v){ db.users.find(u=>u.id===currentUser.id).password=v; saveDB(); showToast('Password Updated'); } }
function renderCoursesList(c) {
    let subs = currentUser.role === 'teacher' ? db.subjects.filter(s => s.teacherId === currentUser.id) : (currentUser.role === 'admin' ? db.subjects : db.subjects.filter(s => s.students.includes(currentUser.id)));
    c.innerHTML = `<div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Courses</h2>${currentUser.role==='teacher'||currentUser.role==='admin'?`<button onclick="addCourse()" class="bg-canvas-accent text-white px-3 py-1 rounded">New Course</button>`:''}</div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${subs.map(s=>`<div onclick="openCourse('${s.id}')" class="course-card bg-white rounded shadow cursor-pointer"><div class="course-header" style="background-color:${s.color}"></div><div class="p-4"><h3 class="font-bold">${s.name}</h3><p class="text-xs text-gray-500">${s.code}</p></div></div>`).join('')}</div>`;
}
window.addCourse = () => { const n=prompt('Name:'), c=prompt('Code:'); if(n&&c){ db.subjects.push({id:'s'+Date.now(), name:n, code:c, teacherId:currentUser.id, students:[], color:'#0374B5', introTitle:'Welcome', gradingWeights:{ww:40,pt:40,qa:20}}); saveDB(); render(); } }
window.openCourse = (sid) => { currentCourseId=sid; currentView='course'; currentTab='home'; render(); }

// --- CALENDAR LOGIC (ENHANCED) ---
function renderCalendar(c) {
    $('page-title').innerText = 'Calendar';
    const year=calendarDate.getFullYear(), month=calendarDate.getMonth();
    const firstDay=new Date(year,month,1).getDay(), days=new Date(year,month+1,0).getDate();
    
    let html = `
    <div class="flex flex-col h-full bg-white rounded shadow border">
        <div class="p-4 flex justify-between items-center border-b">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i class="fas fa-chevron-left"></i></button>
            <h2 class="font-bold text-xl">${calendarDate.toLocaleString('default',{month:'long'})} ${year}</h2>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="grid grid-cols-7 border-b bg-gray-50">
            ${['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=>`<div class="p-2 text-center text-xs font-bold text-gray-500">${d}</div>`).join('')}
        </div>
        <div class="flex-1 grid grid-cols-7 auto-rows-fr bg-gray-200 gap-px border-b">
    `;

    // Padding Days
    for(let i=0; i<firstDay; i++) html+=`<div class="bg-white min-h-[100px] opacity-50"></div>`;
    
    // Days
    for(let d=1; d<=days; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        let evts = '';
        const todayClass = (new Date().toDateString() === new Date(year,month,d).toDateString()) ? 'bg-blue-50' : 'bg-white';
        
        db.subjects.forEach(s => {
            // Check enrollment/ownership
            if(currentUser.role==='student' && !s.students.includes(currentUser.id)) return;
            if(currentUser.role==='teacher' && s.teacherId!==currentUser.id && currentUser.role!=='admin') return;

            // Exams
            (db.exams[s.id]||[]).forEach(e => {
                // Parse dates to simple YYYY-MM-DD for matching
                const eDate = e.dueDate.split('T')[0];
                if(eDate === dateStr) {
                    evts += `<div onclick="calendarJump('${s.id}', 'quiz', '${e.id}')" class="event-pill bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-200" title="${e.title} (Quiz)">
                        <i class="fas fa-clock text-[10px] mr-1"></i> ${e.title}
                    </div>`;
                }
            });

            // Activities
            (db.activities[s.id]||[]).forEach(a => {
                if(a.date === dateStr) {
                    const color = a.category === 'pt' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-orange-100 text-orange-700 border-orange-200';
                    evts += `<div onclick="calendarJump('${s.id}', 'activity', '${a.id}')" class="event-pill ${color} hover:brightness-95" title="${a.title} (Task)">
                        <i class="fas fa-pencil-ruler text-[10px] mr-1"></i> ${a.title}
                    </div>`;
                }
            });
        });

        html += `<div class="${todayClass} min-h-[100px] p-1 flex flex-col gap-1 overflow-hidden hover:bg-gray-50 transition-colors">
            <span class="text-xs font-bold text-gray-400 ml-1">${d}</span>
            <div class="flex flex-col gap-1">${evts}</div>
        </div>`;
    }
    
    // Trailing Padding
    const totalCells = firstDay + days;
    const remaining = 7 - (totalCells % 7);
    if(remaining < 7) {
        for(let i=0; i<remaining; i++) html+=`<div class="bg-white min-h-[100px] opacity-50"></div>`;
    }

    html += `</div></div>`;
    c.innerHTML = html;
}
window.changeMonth = (d) => { calendarDate.setMonth(calendarDate.getMonth()+d); render(); }

// --- SMART CALENDAR ROUTER ---
window.calendarJump = (sid, type, itemId) => {
    // 1. Set Course Context
    currentCourseId = sid;
    
    // 2. Route based on Type & Role
    if (type === 'quiz') {
        currentTab = 'quizzes'; // Set tab for context
        if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
            currentView = 'course'; // Teacher goes to list to manage
        } else {
            // Student: Check if they can take it immediately
            const ex = db.exams[sid].find(e => e.id === itemId);
            if (ex && !ex.isLocked) {
                const sub = db.examSubmissions[itemId]?.[currentUser.id];
                const attempts = sub ? (sub.attemptsTaken || 0) : 0;
                if (attempts < (ex.attempts || 1)) {
                    // Go straight to exam
                    activeExamId = itemId;
                    currentView = 'exam-take';
                    render();
                    return;
                }
            }
            // Fallback to list view if locked or done
            currentView = 'course';
        }
    } else if (type === 'activity') {
        currentTab = 'activities';
        if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
            currentView = 'course';
            render();
            // Open grading modal after render
            setTimeout(() => openGradeActivityModal(itemId), 100);
            return;
        } else {
            // Student: Go to submission view
            activeActivityId = itemId;
            currentView = 'activity-do';
            render();
            return;
        }
    }
    
    render();
}

// --- COURSE VIEW ---
function renderCourse(c) {
    const s = db.subjects.find(x => x.id === currentCourseId);
    if(!s) return goDashboard();
    $('page-title').innerHTML = `<span class="cursor-pointer" onclick="goCoursesList()">${s.code}</span> > ${s.name}`;
    c.innerHTML = `
        <div class="flex flex-col md:flex-row gap-6 h-full">
            <nav class="w-full md:w-48 flex-shrink-0 flex md:flex-col gap-1 text-sm font-medium text-canvas-primary border-r border-gray-200 pb-4 md:pr-4">
                <a onclick="switchCourseTab('home')" class="${currentTab==='home'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Home</a>
                <a onclick="switchCourseTab('activities')" class="${currentTab==='activities'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Activities</a>
                <a onclick="switchCourseTab('quizzes')" class="${currentTab==='quizzes'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Quizzes/Exams</a>
                <a onclick="switchCourseTab('grades')" class="${currentTab==='grades'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Grades</a>
                <a onclick="switchCourseTab('people')" class="${currentTab==='people'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">People</a>
            </nav>
            <div id="course-content" class="flex-1"></div>
        </div>
    `;
    renderCourseTab();
}
window.switchCourseTab = (t) => { currentTab=t; render(); }

function renderCourseTab() {
    const c = $('course-content');
    const s = db.subjects.find(x => x.id === currentCourseId);
    const isTeacher = currentUser.role === 'teacher' || currentUser.role === 'admin'; 

    if(currentTab === 'home') {
        c.innerHTML = `<div class="bg-white p-6 rounded shadow border"><b>${s.introTitle}</b><p>${s.introBody || 'No content.'}</p></div>`;
    }

    // --- ACTIVITIES TAB (Enhanced) ---
    if(currentTab === 'activities') {
        const activities = db.activities[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-bold">Class Activities</h2>
            ${isTeacher ? `<button onclick="openActivityModal()" class="bg-canvas-accent text-white px-4 py-2 rounded font-bold text-sm shadow"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}
        </div>`;
        
        if(activities.length === 0) html += `<div class="text-center text-gray-400 py-10">No activities.</div>`;
        else {
            html += `<div class="grid grid-cols-1 gap-4">`;
            activities.forEach(a => {
                const sub = db.activitySubmissions[a.id]?.[currentUser.id]; // Object or Number
                const score = (typeof sub === 'object' ? sub.score : sub) || '-';
                const isSubmitted = !!sub;
                const isLocked = a.isLocked;

                html += `
                <div class="bg-white p-4 rounded border flex justify-between items-center hover:bg-gray-50 transition ${isLocked?'opacity-75 bg-gray-100':''}">
                    <div class="flex items-center gap-4" onclick="${isTeacher ? `openGradeActivityModal('${a.id}')` : (a.allowSubmission ? `openActivityDo('${a.id}')` : '')}" class="cursor-pointer">
                         <div class="w-10 h-10 rounded bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fas fa-pencil-ruler"></i></div>
                         <div class="cursor-pointer">
                            <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                ${a.title} 
                                ${isLocked ? '<i class="fas fa-lock text-xs text-red-500" title="Locked"></i>' : ''}
                            </h4>
                            <div class="flex gap-2 text-xs mt-1 text-gray-500">
                                <span class="uppercase font-bold">${a.category === 'pt' ? 'Perf. Task' : 'Written Work'}</span>
                                <span>Max: ${a.maxScore}</span>
                                <span>Due: ${formatDate(a.date)}</span>
                            </div>
                            ${a.description ? `<p class="text-xs text-gray-400 mt-1 line-clamp-1">${a.description}</p>` : ''}
                         </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${!isTeacher && a.allowSubmission ? (isSubmitted ? '<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded">Submitted</span>' : '<span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded">Pending</span>') : ''}
                        ${!isTeacher ? `<span class="font-bold text-lg text-gray-700 w-12 text-center">${score}</span>` : ''}
                        
                        ${isTeacher ? `
                            <button onclick="toggleLockActivity('${a.id}')" class="text-gray-400 hover:text-gray-600 px-2" title="${a.isLocked ? 'Unlock' : 'Lock'}">
                                <i class="fas ${a.isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                            </button>
                            <button onclick="deleteActivity('${a.id}')" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </div>
                </div>`;
            });
            html += `</div>`;
        }
        c.innerHTML = html;
    }

    // --- QUIZZES TAB (Enhanced with Builder) ---
    if(currentTab === 'quizzes') {
        const exams = db.exams[s.id] || [];
        let html = `
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">Quizzes & Exams</h2>
                ${isTeacher ? `<div class="flex gap-2">
                    <button onclick="openImportModal()" class="bg-white border text-gray-700 px-3 py-1 rounded text-sm font-bold"><i class="fas fa-file-word"></i> Import</button>
                    <button onclick="openQuizBuilder()" class="bg-canvas-accent text-white px-3 py-1 rounded text-sm font-bold shadow"><i class="fas fa-magic mr-2"></i> Quiz Builder</button>
                </div>` : ''}
            </div>
            <div class="space-y-3">
                ${exams.map(e => {
                    const sub = db.examSubmissions[e.id]?.[currentUser.id];
                    const attempts = sub ? (sub.attemptsTaken || 0) : 0;
                    const isLocked = e.isLocked;
                    
                    let actionBtn = '';
                    if(isTeacher) {
                        actionBtn = `<div class="flex gap-2">
                            <button onclick="toggleLockExam('${e.id}')" class="text-gray-400 hover:text-gray-600 px-2" title="${isLocked?'Unlock':'Lock'}"><i class="fas ${isLocked?'fa-lock':'fa-lock-open'}"></i></button>
                            <button onclick="openQuizBuilder('${e.id}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="deleteExam('${e.id}')" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded"><i class="fas fa-trash"></i></button>
                        </div>`;
                    } else {
                        if(isLocked) actionBtn = `<span class="text-xs text-red-500 font-bold border border-red-200 px-3 py-1 rounded"><i class="fas fa-lock"></i> Locked</span>`;
                        else if(attempts >= (e.attempts||1)) actionBtn = `<button onclick="reviewExam('${e.id}')" class="bg-gray-100 px-3 py-1 rounded text-xs font-bold">Results</button>`;
                        else actionBtn = `<button onclick="startExam('${e.id}')" class="bg-canvas-accent text-white px-3 py-1 rounded text-xs font-bold">Start</button>`;
                    }

                    return `
                    <div class="bg-white p-4 border rounded flex justify-between items-center hover:bg-gray-50 transition ${isLocked ? 'opacity-75 bg-gray-100':''}">
                        <div class="flex gap-4 items-center">
                            <div class="text-2xl text-gray-400"><i class="fas fa-rocket"></i></div>
                            <div>
                                <h4 class="font-bold hover:underline cursor-pointer text-canvas-primary">${e.title} ${isLocked?'<i class="fas fa-lock text-xs text-red-500"></i>':''}</h4>
                                <div class="text-xs text-gray-500 flex gap-3 mt-1">
                                    <span>${formatDate(e.dueDate)}</span>
                                    <span>${e.questions.length} Qs</span>
                                    <span>${e.category==='qa'?'Exam':'Quiz'}</span>
                                </div>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                `}).join('')}
            </div>
        `;
        c.innerHTML = html;
    }

    if(currentTab === 'grades') {
        c.innerHTML = '<div class="p-8 text-center text-gray-400">Grades table placeholder (Same logic as before)</div>';
    }
    if(currentTab === 'people') {
        c.innerHTML = '<div class="p-8 text-center text-gray-400">People list placeholder</div>';
    }
}

// --- QUIZ BUILDER (GOOGLE FORM STYLE) ---

window.openQuizBuilder = (examId = null) => {
    // Reset state
    let exam = { title: '', openDate: '', dueDate: '', timeLimit: 30, attempts: 1, category: 'ww' };
    builderQuestions = [];
    let titleText = 'Create Quiz';
    let btnText = 'Publish Quiz';

    if(examId) {
        const e = db.exams[currentCourseId].find(x => x.id === examId);
        if(e) {
            exam = e;
            builderQuestions = JSON.parse(JSON.stringify(e.questions)); // Deep copy
            titleText = 'Edit Quiz';
            btnText = 'Save Changes';
        }
    }

    renderModal('modal-builder', titleText, `
        <div class="flex flex-col h-[80vh]">
            <!-- Settings Header -->
            <div class="bg-gray-50 p-4 rounded border mb-4 space-y-3">
                <input id="b-title" class="w-full text-lg font-bold border-b border-gray-300 bg-transparent p-1 focus:outline-none focus:border-canvas-accent" placeholder="Quiz Title" value="${exam.title}">
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div><label class="font-bold text-gray-500">Open Date</label><input id="b-open" type="datetime-local" class="w-full border p-1 rounded" value="${exam.openDate}"></div>
                    <div><label class="font-bold text-gray-500">Due Date</label><input id="b-due" type="datetime-local" class="w-full border p-1 rounded" value="${exam.dueDate}"></div>
                    <div><label class="font-bold text-gray-500">Time Limit (mins)</label><input id="b-limit" type="number" class="w-full border p-1 rounded" value="${exam.timeLimit}"></div>
                    <div><label class="font-bold text-gray-500">Attempts</label><input id="b-attempts" type="number" class="w-full border p-1 rounded" value="${exam.attempts}"></div>
                    <div><label class="font-bold text-gray-500">Category</label><select id="b-cat" class="w-full border p-1 rounded"><option value="ww" ${exam.category==='ww'?'selected':''}>Written Work</option><option value="qa" ${exam.category==='qa'?'selected':''}>Quarterly Exam</option></select></div>
                </div>
            </div>

            <!-- Questions Area -->
            <div id="builder-questions" class="flex-1 overflow-y-auto space-y-4 pb-4"></div>

            <!-- Footer -->
            <div class="pt-4 border-t flex justify-between">
                <button onclick="addBuilderQuestion()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded border"><i class="fas fa-plus mr-2"></i>Add Question</button>
                <button onclick="saveBuilderQuiz('${examId || ''}')" class="bg-canvas-accent hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow">${btnText}</button>
            </div>
        </div>
    `);

    renderBuilderQuestions();
}

window.renderBuilderQuestions = () => {
    const c = $('builder-questions');
    if(!c) return;
    
    if(builderQuestions.length === 0) {
        c.innerHTML = `<div class="text-center text-gray-400 py-10 border-2 border-dashed rounded">Click "Add Question" to start</div>`;
        return;
    }

    c.innerHTML = builderQuestions.map((q, i) => `
        <div class="bg-white p-4 rounded border border-gray-200 shadow-sm relative group transition hover:shadow-md">
            <div class="flex gap-2 mb-3">
                <input type="text" class="flex-1 border-b border-gray-200 p-2 font-medium focus:border-canvas-accent focus:outline-none" placeholder="Question Text" value="${q.q}" onchange="updateBuilderQ(${i}, 'q', this.value)">
                <select class="border p-2 rounded bg-gray-50 text-sm w-40" onchange="updateBuilderQ(${i}, 'type', this.value)">
                    <option value="mc" ${q.type!=='sa'?'selected':''}>Multiple Choice</option>
                    <option value="sa" ${q.type==='sa'?'selected':''}>Short Answer</option>
                </select>
                <button onclick="removeBuilderQ(${i})" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
            </div>

            ${q.type === 'sa' ? `
                <div class="pl-4 border-l-2 border-blue-200">
                    <input class="w-full border-b border-gray-200 p-2 text-sm" placeholder="Correct Answer Text (Optional for auto-grade)" value="${q.correctText || ''}" onchange="updateBuilderQ(${i}, 'correctText', this.value)">
                    <p class="text-[10px] text-gray-400 mt-1">Leave blank for manual grading. Exact match required for auto-grading.</p>
                </div>
            ` : `
                <div class="space-y-2 pl-4 border-l-2 border-canvas-accent">
                    ${(q.options || []).map((opt, oi) => `
                        <div class="flex items-center gap-2">
                            <input type="radio" name="bq-${i}" ${q.ans===oi ? 'checked' : ''} onclick="updateBuilderQ(${i}, 'ans', ${oi})">
                            <input class="flex-1 border-b border-gray-100 p-1 text-sm focus:border-gray-300 focus:outline-none" value="${opt}" onchange="updateBuilderOption(${i}, ${oi}, this.value)" placeholder="Option ${oi+1}">
                            <button onclick="removeBuilderOption(${i}, ${oi})" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                        </div>
                    `).join('')}
                    <button onclick="addBuilderOption(${i})" class="text-xs text-blue-500 font-bold hover:underline mt-2"><i class="fas fa-plus"></i> Add Option</button>
                </div>
            `}
        </div>
    `).join('');
}

window.addBuilderQuestion = () => { builderQuestions.push({ q:'', type:'mc', options:['Option 1'], ans:0 }); renderBuilderQuestions(); }
window.removeBuilderQ = (i) => { builderQuestions.splice(i, 1); renderBuilderQuestions(); }
window.updateBuilderQ = (i, field, val) => { 
    builderQuestions[i][field] = val; 
    if(field === 'type' && val === 'sa') { delete builderQuestions[i].options; delete builderQuestions[i].ans; }
    if(field === 'type' && val === 'mc') { builderQuestions[i].options = ['Option 1']; builderQuestions[i].ans = 0; }
    renderBuilderQuestions(); 
}
window.addBuilderOption = (i) => { builderQuestions[i].options.push(`Option ${builderQuestions[i].options.length+1}`); renderBuilderQuestions(); }
window.removeBuilderOption = (i, oi) => { if(builderQuestions[i].options.length > 1) { builderQuestions[i].options.splice(oi, 1); if(builderQuestions[i].ans >= builderQuestions[i].options.length) builderQuestions[i].ans = 0; renderBuilderQuestions(); } }
window.updateBuilderOption = (i, oi, val) => { builderQuestions[i].options[oi] = val; }

window.saveBuilderQuiz = (existingId) => {
    const t = $('b-title').value;
    const o = $('b-open').value;
    const d = $('b-due').value;
    if(!t || !o || !d) return showToast('Please fill all settings', 'error');
    if(builderQuestions.length === 0) return showToast('Add at least one question', 'error');

    const newId = existingId || 'e'+Date.now();
    const quizData = {
        id: newId,
        title: t,
        openDate: o,
        dueDate: d,
        timeLimit: parseInt($('b-limit').value) || 30,
        attempts: parseInt($('b-attempts').value) || 1,
        category: $('b-cat').value,
        questions: builderQuestions,
        isLocked: false
    };

    if(!db.exams[currentCourseId]) db.exams[currentCourseId] = [];
    
    if(existingId) {
        const idx = db.exams[currentCourseId].findIndex(e => e.id === existingId);
        if(idx !== -1) db.exams[currentCourseId][idx] = { ...db.exams[currentCourseId][idx], ...quizData };
    } else {
        db.exams[currentCourseId].push(quizData);
    }
    
    saveDB();
    closeModal('modal-builder');
    render();
    showToast('Quiz Saved!');
}

// --- ACTIVITIES (ENHANCED) ---

window.openActivityModal = () => {
    renderModal('modal-activity', 'New Class Activity', `
        <div class="space-y-4">
            <div><label class="block text-xs font-bold text-gray-500 mb-1">Title</label><input id="act-title" class="w-full border p-2 rounded"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">Description/Instructions</label><textarea id="act-desc" class="w-full border p-2 rounded h-20"></textarea></div>
            <div class="grid grid-cols-2 gap-2">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="act-cat" class="w-full border p-2 rounded bg-white"><option value="pt">Performance Task</option><option value="ww">Written Work</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Max Score</label><input id="act-max" type="number" class="w-full border p-2 rounded" value="100"></div>
            </div>
             <div class="grid grid-cols-2 gap-2">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Due Date</label><input id="act-date" type="date" class="w-full border p-2 rounded"></div>
            </div>
            <div class="flex items-center gap-2 mt-2">
                <input type="checkbox" id="act-sub" checked class="w-4 h-4">
                <label for="act-sub" class="text-sm">Allow Text Submission (Student inputs answer)</label>
            </div>
            <button onclick="saveActivity()" class="w-full bg-canvas-accent text-white py-2 font-bold rounded">Create Activity</button>
        </div>
    `);
}

window.saveActivity = () => {
    const title = $('act-title').value;
    if(title) {
        if(!db.activities[currentCourseId]) db.activities[currentCourseId] = [];
        db.activities[currentCourseId].push({
            id: 'a'+Date.now(),
            title, 
            description: $('act-desc').value,
            category: $('act-cat').value, 
            maxScore: parseInt($('act-max').value), 
            date: $('act-date').value,
            allowSubmission: $('act-sub').checked,
            isLocked: false
        });
        saveDB(); closeModal('modal-activity'); render();
    }
}

window.openActivityDo = (aid) => {
    activeActivityId = aid;
    currentView = 'activity-do';
    render();
}

window.renderActivityDo = (c) => {
    const act = db.activities[currentCourseId].find(a => a.id === activeActivityId);
    const sub = db.activitySubmissions[activeActivityId]?.[currentUser.id];
    const prevText = (typeof sub === 'object') ? sub.text : '';
    const score = (typeof sub === 'object' ? sub.score : sub) || null;
    const isLocked = act.isLocked;

    c.innerHTML = `
        <div class="max-w-3xl mx-auto bg-white min-h-screen border-x">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">${act.title}</h1>
                    <p class="text-sm text-gray-500">Max Score: ${act.maxScore}</p>
                </div>
                <button onclick="currentView='course'; render()" class="text-gray-500 font-bold">Back</button>
            </div>
            <div class="p-8">
                <div class="bg-blue-50 p-4 rounded text-gray-700 mb-6 whitespace-pre-line">${act.description || 'No instructions.'}</div>
                
                ${score !== null ? `<div class="mb-6 p-4 bg-green-100 text-green-800 rounded font-bold text-center">Graded: ${score} / ${act.maxScore}</div>` : ''}

                ${isLocked ? `<div class="text-center p-8 text-red-500 bg-red-50 rounded border border-red-100 font-bold mb-4">This activity is locked.</div>` : ''}

                <label class="block font-bold text-gray-700 mb-2">Your Answer / Submission</label>
                <textarea id="act-submission-text" class="w-full border p-4 rounded h-64 font-mono text-sm leading-relaxed mb-4" placeholder="Type your answer here..." ${score!==null || isLocked ? 'disabled' : ''}>${prevText}</textarea>
                
                ${score===null && !isLocked ? `<button onclick="submitActivity()" class="bg-canvas-accent text-white px-8 py-3 rounded font-bold shadow w-full hover:bg-blue-700">Submit Assignment</button>` : ''}
            </div>
        </div>
    `;
}

window.submitActivity = () => {
    const txt = $('act-submission-text').value;
    if(!txt) return showToast('Please type an answer', 'error');
    if(!db.activitySubmissions[activeActivityId]) db.activitySubmissions[activeActivityId] = {};
    
    db.activitySubmissions[activeActivityId][currentUser.id] = {
        text: txt,
        score: null, // Reset score on new submission if any
        date: new Date().toISOString()
    };
    saveDB();
    showToast('Assignment Submitted!');
    currentView = 'course'; render();
}

window.openGradeActivityModal = (aid) => {
    const s = db.subjects.find(x => x.id === currentCourseId);
    const act = db.activities[currentCourseId].find(a => a.id === aid);
    const students = db.users.filter(u => s.students.includes(u.id));
    
    let html = `
        <div class="max-h-[60vh] overflow-y-auto space-y-4">
            ${students.map(stu => {
                const sub = db.activitySubmissions[aid]?.[stu.id];
                const score = (typeof sub === 'object' ? sub.score : sub) || '';
                const text = (typeof sub === 'object' ? sub.text : null);
                
                return `
                <div class="bg-gray-50 p-3 rounded border">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-800">${stu.name}</span>
                        <div class="flex items-center gap-2">
                            <input type="number" class="border p-1 w-16 text-center rounded" placeholder="0" value="${score}" onchange="updateActGrade('${aid}', '${stu.id}', this.value)">
                            <span class="text-gray-400 text-xs">/ ${act.maxScore}</span>
                        </div>
                    </div>
                    ${text ? `<div class="bg-white p-2 rounded border text-sm text-gray-600 whitespace-pre-line max-h-32 overflow-y-auto">${text}</div>` : `<p class="text-xs text-gray-400 italic">No text submission</p>`}
                </div>`;
            }).join('')}
        </div>
    `;
    renderModal('modal-grade', `Grading: ${act.title}`, html);
}
window.updateActGrade = (aid, uid, val) => {
    const prev = db.activitySubmissions[aid][uid];
    if (typeof prev === 'object') {
        db.activitySubmissions[aid][uid].score = parseInt(val);
    } else {
        db.activitySubmissions[aid][uid] = parseInt(val);
    }
    saveDB();
}

// --- LOCK / DELETE LOGIC ---
window.deleteActivity = (aid) => { showConfirm('Delete Activity?', () => { db.activities[currentCourseId] = db.activities[currentCourseId].filter(a=>a.id!==aid); delete db.activitySubmissions[aid]; saveDB(); render(); }); }
window.toggleLockActivity = (aid) => { const a = db.activities[currentCourseId].find(x=>x.id===aid); a.isLocked = !a.isLocked; saveDB(); render(); showToast(a.isLocked?'Locked':'Unlocked'); }
window.deleteExam = (eid) => { showConfirm('Delete Quiz?', () => { db.exams[currentCourseId] = db.exams[currentCourseId].filter(e=>e.id!==eid); delete db.examSubmissions[eid]; saveDB(); render(); }); }
window.toggleLockExam = (eid) => { const e = db.exams[currentCourseId].find(x=>x.id===eid); e.isLocked = !e.isLocked; saveDB(); render(); showToast(e.isLocked?'Locked':'Unlocked'); }

// --- UPDATED EXAM TAKER (SHORT ANSWER SUPPORT) ---
window.renderExamTake = (c) => {
    const ex = db.exams[db.subjects.find(x => x.id === currentCourseId).id].find(e => e.id === activeExamId);
    // Simple Timer
    c.innerHTML = `
        <div class="max-w-4xl mx-auto bg-white min-h-screen border-x">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between z-10">
                <h2 class="font-bold text-xl">${ex.title}</h2>
                <button onclick="submitExam()" class="bg-canvas-accent text-white px-4 py-1 rounded">Submit</button>
            </div>
            <div class="p-8 space-y-8">
                ${ex.questions.map((q, i) => `
                    <div class="bg-gray-50 p-4 rounded border">
                        <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                        ${q.type === 'sa' 
                            ? `<input type="text" name="q${i}" class="w-full border p-2 rounded" placeholder="Type answer here...">`
                            : `<div class="space-y-2">${q.options.map((o, oi) => `<label class="flex items-center p-2 bg-white border rounded cursor-pointer"><input type="radio" name="q${i}" value="${oi}" class="mr-2"> ${o}</label>`).join('')}</div>`
                        }
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

window.submitExam = () => {
    const ex = db.exams[currentCourseId].find(e => e.id === activeExamId);
    let score = 0;
    const ans = [];
    
    ex.questions.forEach((q, i) => {
        if(q.type === 'sa') {
            const val = document.querySelector(`input[name="q${i}"]`).value.trim();
            ans.push(val);
            // Auto-grade exact match (case insensitive) if correctText exists
            if(q.correctText && val.toLowerCase() === q.correctText.toLowerCase()) score++;
        } else {
            const el = document.querySelector(`input[name="q${i}"]:checked`);
            const val = el ? parseInt(el.value) : -1;
            ans.push(val);
            if(val === q.ans) score++;
        }
    });
    
    const pct = Math.round((score / ex.questions.length) * 100);
    if(!db.examSubmissions[activeExamId]) db.examSubmissions[activeExamId] = {};
    const prev = db.examSubmissions[activeExamId][currentUser.id];
    db.examSubmissions[activeExamId][currentUser.id] = { score: pct, answers: ans, attemptsTaken: (prev?.attemptsTaken||0)+1 };
    saveDB();
    showToast(`Submitted. Score: ${pct}%`);
    currentView = 'course'; render();
}

// Helpers
window.toggleModal = (id) => { if($(id)) $(id).remove(); }
window.closeModal = (id) => { if($(id)) $(id).remove(); }
window.renderModal = (id,t,h) => { if($(id)) $(id).remove(); $('modal-portal').innerHTML=`<div id="${id}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-6 rounded w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-fade-in"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">${t}</h3><button onclick="closeModal('${id}')"><i class="fas fa-times"></i></button></div>${h}</div></div>`; }
// Re-bind imports for imports to work
window.openImportModal = () => { renderModal('modal-imp', 'Import', `<input type="file" id="docx-upload" class="border p-2 w-full mb-2"><div id="parse-preview" class="text-xs bg-gray-100 p-2 mb-2"></div><button onclick="processDocxImport()" class="bg-blue-600 text-white w-full py-2 rounded">Import</button>`); }
// Docx Processor reused
document.addEventListener('change', async (e) => { if(e.target.id === 'docx-upload') { const reader = new FileReader(); reader.onload = function(evt) { mammoth.extractRawText({arrayBuffer: evt.target.result}).then(r => { importedText = r.value; $('parse-preview').innerText = importedText.substring(0,100)+'...'; }); }; reader.readAsArrayBuffer(e.target.files[0]); } });
window.processDocxImport = () => { const qs = parseQuizText(importedText); if(qs.length>0){ db.exams[currentCourseId].push({id:'e'+Date.now(), title:'Imported', openDate:new Date().toISOString(), dueDate:new Date().toISOString(), timeLimit:30, attempts:1, category:'ww', questions:qs, isLocked:false}); saveDB(); closeModal('modal-imp'); render(); } }

render();
</script>
</body>
</html>