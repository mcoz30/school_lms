<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas LMS - Exam Builder</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Lato', 'sans-serif'] },
                    colors: {
                        canvas: {
                            nav: '#2D3B45',       // Global Nav Dark
                            primary: '#0374B5',   // Canvas Blue
                            accent: '#F5F5F5',    // Background
                            text: '#2D3B45',
                            border: '#C7CDD1'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 5px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>

    <!-- ICONS & LIBS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
    
    <style>
        /* UI Utilities */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #C7CDD1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #2D3B45; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .global-nav-item:hover .icon-box { color: #0374B5; background-color: white; }
        
        /* Active Tab Styling */
        .nav-tab-btn.active { 
            background-color: #0374B5; 
            color: white; 
            border-color: #0374B5;
        }

        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.8rem; }
        .calendar-day.today { background-color: #0374B5; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-[#F5F5F5] text-[#2D3B45] h-screen flex overflow-hidden font-sans">

    <!-- 1. GLOBAL NAVIGATION (Fixed Left Sidebar) -->
    <nav class="w-[84px] bg-canvas-nav flex flex-col items-center py-4 z-50 shrink-0 text-white shadow-xl h-full">
        <div class="mb-6 w-16 h-16 flex items-center justify-center">
            <i class="fas fa-sun text-3xl text-yellow-500 animate-spin-slow"></i> 
        </div>

        <!-- Sidebar Links -->
        <div id="nav-links" class="hidden space-y-4 w-full flex flex-col items-center">
            <button id="nav-btn-dashboard" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-tachometer-alt text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Dashboard</span>
            </button>

            <button id="nav-btn-courses" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-book text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Courses</span>
            </button>

            <button id="nav-btn-calendar" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-calendar text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Calendar</span>
            </button>
        </div>

        <div class="mt-auto mb-4 w-full flex flex-col items-center">
             <button id="btn-logout" class="hidden global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white bg-red-600/20 group-hover:bg-red-600 group-hover:text-white">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold">Logout</span>
            </button>
        </div>
    </nav>

    <!-- 2. MAIN APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-canvas-border h-16 flex justify-between items-center px-6 shrink-0 z-30 shadow-sm">
            <div class="flex items-center gap-4">
                <button class="text-canvas-primary md:hidden"><i class="fas fa-bars text-xl"></i></button>
                <div>
                    <h1 class="text-canvas-primary font-bold text-lg tracking-wide">Exam Builder <span class="text-slate-400 font-normal">v4.1</span></h1>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span id="header-role">User</span>
                        <span>&gt;</span>
                        <span id="header-context">Dashboard</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button class="bg-canvas-accent text-slate-600 px-3 py-1 rounded border border-canvas-border text-xs font-bold hover:bg-slate-200 transition">
                    <i class="fas fa-glasses mr-1"></i> Student View
                </button>
                 <span class="text-[10px] font-mono font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200" id="status-indicator">Connecting...</span>
            </div>
        </header>

        <!-- NOTIFICATIONS -->
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert">
            <p class="font-bold">Security Alert</p>
            <p>Domain not allowed. Add <span id="current-domain" class="font-mono bg-red-200 px-1"></span> to Firebase Console.</p>
        </div>

        <!-- CONTENT VIEWS -->
        <div class="flex-1 overflow-hidden flex flex-col relative bg-[#F5F5F5]">
            
            <!-- VIEW: LANDING -->
            <div id="view-landing" class="flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2">Select Portal</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <!-- Teacher Card -->
                    <button id="nav-teacher" class="bg-white rounded-lg shadow-card overflow-hidden group hover:shadow-lg transition-all text-left h-64 flex flex-col border border-gray-200">
                        <div class="h-32 bg-canvas-nav relative">
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                            <div class="absolute bottom-3 left-4 text-white font-bold text-shadow">
                                <i class="fas fa-chalkboard-teacher mr-2"></i> TEACHER PORTAL
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-canvas-primary text-lg group-hover:underline">Instructor Access</h3>
                                <p class="text-xs text-slate-500 mt-1">Manage Curriculum, Questions & Grades</p>
                            </div>
                        </div>
                    </button>

                    <!-- Student Card -->
                    <button id="nav-student" class="bg-white rounded-lg shadow-card overflow-hidden group hover:shadow-lg transition-all text-left h-64 flex flex-col border border-gray-200">
                        <div class="h-32 bg-canvas-primary relative">
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                            <div class="absolute bottom-3 left-4 text-white font-bold text-shadow">
                                <i class="fas fa-user-graduate mr-2"></i> STUDENT PORTAL
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-canvas-primary text-lg group-hover:underline">Student Access</h3>
                                <p class="text-xs text-slate-500 mt-1">Take Quizzes & View History</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- VIEW: TEACHER LOGIN -->
            <div id="view-teacher-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
                <div class="max-w-md w-full bg-white shadow-card rounded border border-gray-200 p-8 relative">
                    <button id="close-login" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-16 h-16 bg-canvas-primary rounded-full flex items-center justify-center text-white text-3xl mb-4 shadow-lg">
                            <i class="fas fa-school"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-700">Canvas Login</h2>
                    </div>

                    <div id="form-login">
                        <button id="do-google-login" class="w-full bg-[#4285F4] text-white font-bold py-3 rounded shadow hover:bg-[#357ae8] transition mb-4 flex items-center justify-center gap-3">
                            <i class="fab fa-google bg-white text-[#4285F4] p-1 rounded-full text-xs"></i> Sign in with Google
                        </button>
                        <div class="text-center text-xs text-slate-400 mb-4 border-b border-t py-2 border-slate-100">OR USE CREDENTIALS</div>
                        <div class="space-y-4">
                            <input type="text" id="login-user" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Username">
                            <input type="password" id="login-pass" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Password">
                        </div>
                        <button id="do-login" class="w-full bg-canvas-nav text-white font-bold py-3 rounded mt-6 hover:bg-slate-800 transition">Log In</button>
                        <div class="text-center mt-4 text-sm">
                            <button id="show-register" class="text-canvas-primary hover:underline">Forgot Password? / Register</button>
                        </div>
                    </div>

                    <div id="form-register" class="hidden">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">Create Account</h3>
                        <input type="text" id="reg-name" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm" placeholder="Full Name">
                        <input type="text" id="reg-user" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm" placeholder="Username">
                        <input type="password" id="reg-pass" class="w-full p-2 border border-gray-300 rounded mb-4 text-sm" placeholder="Password">
                        <button id="do-register" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700">Register</button>
                        <button id="cancel-register" class="w-full text-slate-500 text-sm mt-3 hover:text-slate-700">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: TEACHER DASHBOARD -->
            <div id="view-dashboard" class="hidden flex-1 flex flex-col overflow-hidden fade-in bg-white h-full">
                
                <!-- HEADER (Dashboard Info) -->
                <div class="bg-white px-8 py-6 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-end gap-4 shrink-0">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Current Course</div>
                        <h2 class="text-3xl font-light text-canvas-primary" id="dash-name">Teacher's Course</h2>
                        <div class="text-sm text-slate-500 mt-1" id="dash-details">Loading details...</div>
                    </div>
                    <button id="do-sync" class="bg-slate-100 text-slate-600 px-4 py-2 rounded border border-gray-300 hover:bg-slate-200 text-sm font-bold flex items-center gap-2 transition">
                        <i class="fas fa-cloud-upload-alt text-canvas-primary"></i> Sync Data
                    </button>
                </div>

                <!-- NAVIGATION BAR -->
                <div class="bg-gray-50 border-b border-gray-200 px-8 flex gap-2 overflow-x-auto shrink-0">
                    <button id="tab-btn-students" class="nav-tab-btn active px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Students</button>
                    <button id="tab-btn-curriculum" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Curriculum</button>
                    <button id="tab-btn-manage" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Assessments</button>
                    <button id="tab-btn-records" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Grades</button>
                    <button id="tab-btn-settings" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Settings</button>
                </div>

                <!-- MAIN SCROLL AREA -->
                <main class="flex-1 overflow-y-auto custom-scroll p-8 bg-white w-full">
                    
                    <!-- 1. STUDENTS TAB -->
                    <div id="tab-students" class="tab-content h-full">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Roster</h3>
                            <button id="do-add-student" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm"><i class="fas fa-plus"></i> Add Student</button>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded border border-gray-200 mb-6 flex flex-wrap gap-3 items-end shadow-sm">
                            <div class="flex-1 min-w-[200px]">
                                <label class="text-xs font-bold text-slate-600 block mb-1">Student Name</label>
                                <input type="text" id="new-st-name" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Full Name">
                            </div>
                            <div class="w-32">
                                <label class="text-xs font-bold text-slate-600 block mb-1">LRN / ID</label>
                                <input type="text" id="new-st-lrn" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="ID Number">
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="text-xs font-bold text-slate-600 block mb-1">Section</label>
                                <select id="new-st-course" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                            </div>
                        </div>

                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-gray-300 text-slate-600">
                                <tr>
                                    <th class="p-3 border-r border-gray-200 w-1/3">Name</th>
                                    <th class="p-3 border-r border-gray-200">SIS ID / LRN</th>
                                    <th class="p-3 border-r border-gray-200">Section</th>
                                    <th class="p-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="no-students-msg" class="p-8 text-center text-slate-400 bg-slate-50 mt-2 rounded border border-dashed border-gray-300 hidden">No students enrolled.</div>
                    </div>

                    <!-- 2. CURRICULUM TAB -->
                    <div id="tab-curriculum" class="hidden tab-content h-full">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Course Structure</h3>
                            <button id="do-add-course" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm"><i class="fas fa-plus"></i> Create Course</button>
                        </div>

                        <div class="bg-slate-50 border border-gray-200 rounded p-4 mb-6 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 text-sm">Structure Builder</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">1. Grade Level</label>
                                    <div class="flex gap-1 mt-1">
                                        <input id="new-grade" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Grade 10">
                                        <button id="do-add-grade" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-grade" class="mt-2 text-xs space-y-1"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">2. Term/Quarter</label>
                                    <select id="cur-grade-select" class="w-full p-2 text-sm border border-gray-300 rounded mt-1 mb-1"></select>
                                    <div class="flex gap-1">
                                        <input id="new-quarter" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Q1">
                                        <button id="do-add-quarter" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-quarter" class="mt-2 text-xs space-y-1"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">3. Subject</label>
                                    <select id="cur-quarter-select" class="w-full p-2 text-sm border border-gray-300 rounded mt-1 mb-1"></select>
                                    <div class="flex gap-1">
                                        <input id="new-subject" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Math">
                                        <button id="do-add-subject" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-subject" class="mt-2 text-xs space-y-1"></div>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4 mt-2">
                                <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block">4. Finalize Course Section</label>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input id="new-course" class="flex-1 min-w-[200px] p-2 text-sm border border-gray-300 rounded" placeholder="Section Name (e.g. Grade 10 - Newton)">
                                    <input id="new-course-time" type="number" class="w-24 p-2 text-sm border border-gray-300 rounded" placeholder="60 mins">
                                </div>
                                <div id="chk-subjects" class="max-h-32 overflow-y-auto bg-white border border-gray-300 rounded p-2 text-xs grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div id="list-course" class="space-y-4"></div>
                    </div>

                    <!-- 3. QUIZZES TAB -->
                    <div id="tab-manage" class="hidden tab-content h-full flex flex-col">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Question Banks</h3>
                            <div class="flex gap-2">
                                <button id="do-get-template" class="bg-white border border-gray-300 text-slate-600 px-3 py-1 rounded text-sm hover:bg-gray-50"><i class="fas fa-download"></i> Template</button>
                                <input type="file" id="docx-upload" class="hidden" accept=".docx">
                                <button onclick="document.getElementById('docx-upload').click()" class="bg-white border border-gray-300 text-slate-600 px-3 py-1 rounded text-sm hover:bg-gray-50"><i class="fas fa-file-import"></i> Import DOCX</button>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-3 border border-gray-200 rounded flex gap-2 mb-4 text-sm shadow-sm">
                            <select id="sel-grade" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                            <select id="sel-quarter" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                            <select id="sel-subject" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                        </div>

                        <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
                            <!-- Editor -->
                            <div class="w-full lg:w-1/3 flex flex-col">
                                <div class="bg-white border border-gray-300 rounded overflow-hidden flex flex-col h-full shadow-sm">
                                    <div class="bg-gray-50 p-2 border-b border-gray-200 font-bold text-xs text-slate-600">Editor</div>
                                    <div class="p-4 flex-1 overflow-y-auto">
                                        <textarea id="q-text" class="w-full p-3 border border-gray-300 rounded text-sm h-32 mb-3 focus:border-canvas-primary outline-none resize-none" placeholder="Question Text..."></textarea>
                                        <div class="space-y-2 mb-3">
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">A</span><input id="opt-a" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">B</span><input id="opt-b" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">C</span><input id="opt-c" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">D</span><input id="opt-d" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                        </div>
                                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                            <span class="text-xs font-bold">Correct Answer:</span>
                                            <select id="correct-opt" class="p-1 border border-gray-300 rounded text-sm"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                                        </div>
                                    </div>
                                    <div class="p-2 border-t border-gray-200">
                                        <button id="do-save-manual" class="w-full bg-canvas-primary text-white py-2 rounded text-sm font-bold hover:bg-blue-700 transition">Save Question</button>
                                    </div>
                                </div>
                            </div>

                            <!-- List -->
                            <div class="flex-1 border border-gray-300 rounded bg-white overflow-hidden flex flex-col shadow-sm">
                                <div class="bg-gray-50 p-2 border-b border-gray-200 font-bold text-xs text-slate-600 flex justify-between">
                                    <span>Questions</span>
                                    <span>Points: 1 each</span>
                                </div>
                                <div id="q-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                                <div id="q-empty" class="flex-1 flex items-center justify-center text-slate-400 text-sm italic">No questions in selected bank.</div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. RECORDS TAB -->
                    <div id="tab-records" class="hidden tab-content h-full">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Gradebook</h3>
                            <select id="filter-records-grade" class="p-2 border border-gray-300 rounded text-sm bg-white min-w-[200px]"></select>
                        </div>
                        
                        <div class="border border-gray-200 rounded overflow-hidden shadow-sm">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 border-b border-gray-300 text-slate-600 font-bold">
                                    <tr>
                                        <th class="p-3 border-r border-gray-200">Student Name</th>
                                        <th class="p-3 border-r border-gray-200">Grade/Section</th>
                                        <th class="p-3 border-r border-gray-200">Assignment</th>
                                        <th class="p-3 border-r border-gray-200">Score</th>
                                        <th class="p-3 text-right">Date Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="table-records" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 5. SETTINGS TAB -->
                    <div id="tab-settings" class="hidden tab-content h-full max-w-2xl">
                        <h3 class="text-xl font-bold text-slate-700 border-b border-gray-300 pb-4 mb-6">Course Details</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="font-bold text-slate-700 block mb-1">Instructor Name</label>
                                <input id="set-name" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                            </div>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label class="font-bold text-slate-700 block mb-1">Grade Level</label>
                                    <input id="set-grade" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                                </div>
                                <div class="flex-1">
                                    <label class="font-bold text-slate-700 block mb-1">Subject Area</label>
                                    <input id="set-subject" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                            
                            <button id="do-save-profile" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm">Update Details</button>
                            
                            <hr class="border-gray-200 my-4">
                            
                            <div class="bg-red-50 border border-red-200 p-4 rounded">
                                <h4 class="text-red-800 font-bold mb-2">Danger Zone</h4>
                                <p class="text-xs text-red-600 mb-3">Resetting will delete all student data and grades. Content will be preserved.</p>
                                <button id="do-reset-year" class="bg-white border border-red-300 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-50">Reset School Year</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- VIEW: COURSES (SHARED) -->
            <div id="view-courses" class="hidden flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2" id="courses-title">All Courses</h2>
                <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="courses-empty" class="text-center text-slate-400 italic mt-12">No courses available.</div>
            </div>

            <!-- VIEW: CALENDAR (SHARED) -->
            <div id="view-calendar" class="hidden flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2">Academic Calendar</h2>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-1 bg-white p-6 rounded shadow-card border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-lg">Current Month</h3>
                            <span class="text-xs font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded">Today</span>
                        </div>
                        <div class="calendar-grid mb-4 text-center text-xs font-bold text-slate-400 uppercase">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-days" class="calendar-grid">
                            <!-- Days generated by JS -->
                        </div>
                    </div>
                    <div class="w-full lg:w-80">
                        <h3 class="font-bold text-slate-700 mb-4">Upcoming Schedule</h3>
                        <div class="space-y-3" id="calendar-events">
                            <!-- Events generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: STUDENT LOGIN -->
            <div id="view-student-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
                <div class="max-w-md w-full bg-white shadow-card rounded border border-gray-200 p-8 text-center relative">
                    <button id="close-student" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>

                    <div class="w-16 h-16 bg-canvas-primary rounded-full flex items-center justify-center text-white text-3xl mb-6 mx-auto shadow-lg">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 mb-2">Student Access</h2>
                    <p class="text-slate-500 text-sm mb-6">Enter details to access your dashboard.</p>
                    
                    <input type="text" id="st-name" class="w-full p-3 border border-gray-300 rounded mb-3 text-sm focus:border-canvas-primary outline-none" placeholder="Full Name">
                    <input type="text" id="st-lrn" class="w-full p-3 border border-gray-300 rounded mb-4 text-sm focus:border-canvas-primary outline-none" placeholder="LRN / Student ID">
                    
                    <button id="do-student-login" class="w-full bg-canvas-primary text-white font-bold py-3 rounded hover:bg-blue-700 transition">Log In</button>
                </div>
            </div>

            <!-- VIEW: STUDENT DASHBOARD -->
            <div id="view-student-dashboard" class="hidden flex-1 flex flex-col overflow-hidden fade-in bg-[#F5F5F5]">
                <main class="flex-1 overflow-y-auto custom-scroll p-8 max-w-6xl mx-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-light text-slate-700">My Dashboard</h2>
                    </div>

                    <!-- Welcome Card -->
                    <div class="bg-white p-6 rounded shadow-card mb-6 border border-gray-200">
                        <h1 class="text-xl font-bold text-slate-700">Welcome, <span id="dash-st-name" class="text-canvas-primary">Student</span></h1>
                        <p class="text-sm text-slate-500">ID: <span id="dash-st-lrn" class="font-mono">---</span></p>
                    </div>

                    <div class="bg-white p-6 rounded shadow-card border-l-4 border-canvas-primary mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-slate-800 mb-1">To Do</h3>
                            <p class="text-sm text-slate-500">Select an assessment to begin.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <select id="st-course" class="flex-1 p-2 border border-gray-300 rounded text-sm bg-white"></select>
                            <button id="do-start-exam" class="bg-canvas-primary text-white px-4 py-2 rounded font-bold hover:bg-blue-700 text-sm whitespace-nowrap shadow-sm">Take Assessment</button>
                        </div>
                    </div>

                    <h3 class="font-bold text-slate-700 text-lg mb-4 border-b pb-2">Recent Grades</h3>
                    <div class="bg-white rounded shadow-card border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-gray-200 text-slate-600 font-bold">
                                <tr>
                                    <th class="p-4">Subject</th>
                                    <th class="p-4">Score</th>
                                    <th class="p-4 text-right">Date</th>
                                </tr>
                            </thead>
                            <tbody id="student-results-table" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="student-no-results" class="p-6 text-center text-slate-400 italic">No graded items yet.</div>
                    </div>
                </main>
            </div>

            <!-- VIEW: EXAM PORTAL -->
            <div id="view-exam" class="hidden flex-1 flex flex-col bg-white fade-in h-full z-50 absolute inset-0">
                <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shrink-0 shadow-sm">
                    <h1 class="font-bold text-lg text-slate-700">Assessment: <span id="exam-tag" class="font-normal text-slate-500">Subject</span></h1>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-500">Time: <span id="timer" class="font-bold text-red-600 font-mono text-lg">00:00</span></div>
                        <button id="do-exit-exam" class="text-sm text-canvas-primary hover:underline">Submit Assessment</button>
                    </div>
                </header>
                
                <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
                    <div class="flex-1 overflow-y-auto custom-scroll p-8 bg-white flex justify-center">
                        <div class="max-w-3xl w-full">
                            <div class="border border-gray-300 rounded mb-6">
                                <div class="bg-slate-100 p-3 border-b border-gray-300 flex justify-between items-center">
                                    <span class="font-bold text-slate-700" id="exam-progress">Question 1</span>
                                    <span class="text-xs text-slate-500">1 pts</span>
                                </div>
                                <div class="p-6">
                                    <div id="exam-passage" class="hidden bg-slate-50 p-4 border-l-4 border-slate-300 mb-4 text-sm font-serif italic text-slate-700"></div>
                                    <div class="text-lg text-slate-800 mb-6" id="exam-q-text">Loading...</div>
                                    
                                    <div class="space-y-3" id="exam-opts">
                                        <!-- Options will be injected here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-4 border-t border-gray-200">
                                <button id="do-next-q" class="bg-canvas-primary text-white px-6 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm">Next <i class="fas fa-chevron-right ml-1"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="w-64 border-l border-gray-200 bg-slate-50 p-4 overflow-y-auto hidden md:block">
                        <h3 class="font-bold text-sm text-slate-700 mb-4">Questions</h3>
                        <div id="question-grid" class="flex flex-wrap gap-2"></div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- LOGIC MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyA7Sa9kkTFLF_cHS00DPzo8l847awBkBms", 
            authDomain: "ncae-exam.firebaseapp.com", 
            projectId: "ncae-exam", 
            storageBucket: "ncae-exam.firebasestorage.app", 
            messagingSenderId: "560276612754", 
            appId: "1:560276612754:web:29169fa8f0d4752c28284b" 
        };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();
        
        // --- 2. GLOBAL STATE ---
        const statusEl = document.getElementById('status-indicator'); 
        const currentDomain = window.location.hostname;
        
        let state = { 
            user: null, // Firebase User
            userType: 'teacher', // 'teacher' or 'student'
            data: {}, 
            courses: {}, 
            timeLimits: {}, 
            students: [], 
            records: [], 
            session: { q: [], a: {}, idx: 0, student: {} } 
        };

        // --- 3. HELPER FUNCTIONS ---
        const getEl = (id) => document.getElementById(id);
        const setTxt = (id, txt) => { const el = getEl(id); if(el) el.innerText = txt; }
        const setVal = (id, val) => { const el = getEl(id); if(el) el.value = val; }
        const getVal = (id) => { const el = getEl(id); return el ? el.value : ''; }

        // --- 4. AUTHENTICATION LOGIC ---
        async function fetchData() {
            if(!state.user) return;
            try {
                const snap = await getDoc(doc(db,"teachers",state.user.uid));
                if(snap.exists()) {
                    const d = snap.data();
                    state.data = d.examData ? JSON.parse(d.examData) : {};
                    state.courses = d.courses ? JSON.parse(d.courses) : {};
                    state.timeLimits = d.timeLimits ? JSON.parse(d.timeLimits) : {}; 
                    state.records = d.records ? JSON.parse(d.records) : [];
                    state.students = d.students ? JSON.parse(d.students) : []; 
                    
                    setTxt('dash-name', d.fullName || state.user.displayName || "Teacher's Course");
                    setVal('set-name', d.fullName || state.user.displayName);
                    setVal('set-grade', d.gradeHandled || ""); 
                    setVal('set-subject', d.subjectHandled || "");
                    
                    if(d.gradeHandled || d.subjectHandled) {
                        setTxt('dash-details', `${d.gradeHandled||''} â€¢ ${d.subjectHandled||''}`);
                    }

                    refreshCurriculumUI(); 
                    renderManageQuestionsUI(); 
                    renderStudentRegistry();
                    renderCourses(); // Initial render for Courses tab
                    renderCalendar(); // Initial render for Calendar tab
                }
            } catch(e){ console.error("Fetch Error", e); }
        }

        async function syncCloud() { 
            if(!state.user) return; 
            const p = {
                examData: JSON.stringify(state.data), 
                courses: JSON.stringify(state.courses), 
                timeLimits: JSON.stringify(state.timeLimits), 
                records: JSON.stringify(state.records), 
                students: JSON.stringify(state.students), 
                lastSync: new Date().toISOString()
            }; 
            await setDoc(doc(db,"teachers",state.user.uid), p, {merge:true}); 
        }

        async function saveProfile() { 
            if(!state.user) return; 
            try { 
                await setDoc(doc(db,"teachers",state.user.uid), {
                    fullName: getVal('set-name'), 
                    gradeHandled: getVal('set-grade'), 
                    subjectHandled: getVal('set-subject')
                }, {merge:true}); 
                alert("Updated!"); 
                fetchData(); 
            } catch(e){ alert(e.message); } 
        }

        async function resetYear() {
            if(confirm("DANGER: This will DELETE all student records and accounts. Content will be kept. Proceed?")){
                state.records = [];
                state.students = [];
                syncCloud();
                alert("School year reset.");
                location.reload();
            }
        }

        function login() { 
            signInWithEmailAndPassword(auth, getVal('login-user')+"@ncae.com", getVal('login-pass'))
            .then(()=> { state.userType = 'teacher'; setMode('dashboard'); })
            .catch(e=>alert(e.message)); 
        }

        function register() { 
            createUserWithEmailAndPassword(auth, getVal('reg-user')+"@ncae.com", getVal('reg-pass'))
            .then(c=>{ 
                return setDoc(doc(db,"teachers",c.user.uid), {
                    fullName: getVal('reg-name'), 
                    username: getVal('reg-user'), 
                    examData:"{}", courses:"{}", records:"[]"
                }); 
            })
            .then(()=>{ alert("Registered!"); state.userType = 'teacher'; setMode('dashboard'); })
            .catch(e=>alert(e.message)); 
        }

        // --- 5. STUDENT MANAGEMENT ---
        function addStudent() {
            const n = getVal('new-st-name');
            const l = getVal('new-st-lrn');
            const c = getVal('new-st-course');
            if(!n || !l || !c) return alert("Fill all fields");
            state.students.push({ name: n, lrn: l, course: c });
            syncCloud(); renderStudentRegistry();
            setVal('new-st-name', ""); setVal('new-st-lrn', "");
        }
        function delStudent(idx) { if(confirm("Remove student?")) { state.students.splice(idx, 1); syncCloud(); renderStudentRegistry(); } }
        function renderStudentRegistry() {
            const tbody = getEl('student-list-body'); 
            if(!tbody) return;
            tbody.innerHTML = "";
            const sel = getEl('new-st-course'); 
            if(sel) {
                sel.innerHTML = "<option value=''>Select Assigned Course</option>";
                Object.keys(state.courses).forEach(k => sel.innerHTML += `<option value="COURSE:${k}">${k}</option>`);
                Object.keys(state.data).forEach(k => { if(!state.courses[k]) sel.innerHTML += `<option value="GRADE:${k}">${k}</option>`; });
            }

            if(state.students.length === 0) { 
                if(getEl('no-students-msg')) getEl('no-students-msg').classList.remove('hidden'); 
            } else {
                if(getEl('no-students-msg')) getEl('no-students-msg').classList.add('hidden');
                state.students.forEach((s, i) => {
                    const row = document.createElement('tr'); row.className = "hover:bg-slate-50 group";
                    row.innerHTML = `<td class="p-3 border-r border-gray-200 text-slate-700 font-bold"><a href="#" class="text-canvas-primary hover:underline">${s.name}</a></td><td class="p-3 border-r border-gray-200 text-slate-500 font-mono text-xs">${s.lrn}</td><td class="p-3 border-r border-gray-200 text-slate-600">${s.course.split(':')[1]||s.course}</td><td class="p-3 text-right"><button class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>`;
                    row.querySelector('button').onclick = () => delStudent(i);
                    tbody.appendChild(row);
                });
            }
        }

        // --- 6. CURRICULUM MANAGEMENT ---
        function refreshCurriculumUI() { renderGradeList(); updateCurGradeSelect(); renderCourseList(); renderAllSubjectsCheckbox(); updateRecordFilters(); }
        
        function addGrade() { const n=getVal('new-grade'); if(n && !state.data[n]) { state.data[n]={}; syncCloud(); refreshCurriculumUI(); setVal('new-grade',""); } }
        function addQuarter() { const g=getVal('cur-grade-select'), n=getVal('new-quarter'); if(g&&n&&!state.data[g][n]) { state.data[g][n]={}; syncCloud(); renderQuarterList(); updateCurQuarterSelect(); setVal('new-quarter',""); } }
        function addSubject() { const g=getVal('cur-grade-select'), q=getVal('cur-quarter-select'), n=getVal('new-subject'); if(g&&q&&n&&!state.data[g][q][n]) { state.data[g][q][n]=[]; syncCloud(); renderSubjectList(); setVal('new-subject',""); renderAllSubjectsCheckbox(); } }
        
        function delGrade(g) { if(confirm("Delete "+g+"?")) { delete state.data[g]; syncCloud(); refreshCurriculumUI(); } }
        function delQuarter(g,q) { if(confirm("Delete "+q+"?")) { delete state.data[g][q]; syncCloud(); renderQuarterList(); updateCurQuarterSelect(); } }
        function delSubject(g,q,s) { if(confirm("Delete "+s+"?")) { delete state.data[g][q][s]; syncCloud(); renderSubjectList(); renderAllSubjectsCheckbox(); } }

        function renderGradeList() { const d=getEl('list-grade'); if(!d)return; d.innerHTML=""; Object.keys(state.data).forEach(k=>{ const r=document.createElement('div'); r.className="flex justify-between items-center group"; r.innerHTML=`<span class="text-slate-700">${k}</span><button class="text-slate-300 hover:text-red-500 hidden group-hover:block"><i class="fas fa-times"></i></button>`; r.querySelector('button').onclick=()=>delGrade(k); d.appendChild(r); }); }
        function updateCurGradeSelect() { const s=getEl('cur-grade-select'); if(!s)return; s.innerHTML="<option value=''>Select Grade</option>"+Object.keys(state.data).map(k=>`<option value="${k}">${k}</option>`).join(''); s.onchange=()=>{renderQuarterList(); updateCurQuarterSelect();} }
        function renderQuarterList() { const g=getVal('cur-grade-select'), d=getEl('list-quarter'); if(!d)return; d.innerHTML=""; if(g&&state.data[g]) Object.keys(state.data[g]).forEach(k=>{ const r=document.createElement('div'); r.className="flex justify-between items-center group"; r.innerHTML=`<span class="text-slate-700">${k}</span><button class="text-slate-300 hover:text-red-500 hidden group-hover:block"><i class="fas fa-times"></i></button>`; r.querySelector('button').onclick=()=>delQuarter(g,k); d.appendChild(r); }); }
        function updateCurQuarterSelect() { const g=getVal('cur-grade-select'), s=getEl('cur-quarter-select'); if(!s)return; s.innerHTML="<option value=''>Select Quarter</option>"; if(g&&state.data[g]) Object.keys(state.data[g]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`); s.onchange=renderSubjectList; }
        function renderSubjectList() { const g=getVal('cur-grade-select'), q=getVal('cur-quarter-select'), d=getEl('list-subject'); if(!d)return; d.innerHTML=""; if(g&&q&&state.data[g][q]) Object.keys(state.data[g][q]).forEach(k=>{ const r=document.createElement('div'); r.className="flex justify-between items-center group"; r.innerHTML=`<span class="text-slate-700">${k}</span><button class="text-slate-300 hover:text-red-500 hidden group-hover:block"><i class="fas fa-times"></i></button>`; r.querySelector('button').onclick=()=>delSubject(g,q,k); d.appendChild(r); }); }
        function renderAllSubjectsCheckbox() { const c=getEl('chk-subjects'); if(!c)return; c.innerHTML=""; Object.keys(state.data).forEach(g=>{ Object.keys(state.data[g]).forEach(q=>{ Object.keys(state.data[g][q]).forEach(s=>{ const v=`${g} > ${q} > ${s}`; c.innerHTML+=`<label class="flex items-center gap-2 p-1 hover:bg-slate-100"><input type="checkbox" value="${v}" class="c-chk accent-canvas-primary"> <span class="truncate">${g} / ${s}</span></label>`; }); }); }); }
        
        function addCourse() { 
            const n=getVal('new-course'), tm=getVal('new-course-time') || 60;
            if(n){ state.courses[n]=Array.from(document.querySelectorAll('.c-chk:checked')).map(x=>x.value); state.timeLimits[n] = parseInt(tm); syncCloud(); renderCourseList(); setVal('new-course',""); } 
        }
        function renderCourseList() { 
            const d=getEl('list-course'); if(!d)return; d.innerHTML=""; 
            Object.keys(state.courses).forEach(k=>{ 
                const t = state.timeLimits[k] || 60; const r=document.createElement('div'); r.className="p-3 border border-gray-200 rounded bg-white flex justify-between items-center shadow-sm"; 
                r.innerHTML=`<div><div class="font-bold text-canvas-primary text-sm hover:underline cursor-pointer"><i class="fas fa-book mr-1"></i> ${k}</div><div class="text-slate-400 text-xs">${t} mins duration</div></div><button class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>`; 
                r.querySelector('button').onclick=()=>{if(confirm("Delete Course?")){delete state.courses[k]; delete state.timeLimits[k]; syncCloud(); renderCourseList();}}; 
                d.appendChild(r); 
            }); 
            updateRecordFilters();
        }

        // --- 7. QUESTION BANK MANAGEMENT ---
        function renderManageQuestionsUI() { const s=getEl('sel-grade'); if(!s)return; s.innerHTML="<option value=''>Select Grade</option>"+Object.keys(state.data).map(k=>`<option value="${k}">${k}</option>`).join(''); s.onchange=updateManageQuarter; }
        function updateManageQuarter() { const g=getVal('sel-grade'), s=getEl('sel-quarter'); if(!s)return; s.innerHTML="<option value=''>Select Period</option>"; if(g&&state.data[g]) Object.keys(state.data[g]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`); s.onchange=updateManageSubject; }
        function updateManageSubject() { const g=getVal('sel-grade'), q=getVal('sel-quarter'), s=getEl('sel-subject'); if(!s)return; s.innerHTML="<option value=''>Select Subject</option>"; if(g&&q&&state.data[g][q]) Object.keys(state.data[g][q]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`); s.onchange=renderQuestions; }
        
        function saveManualQ() { 
            const g=getVal('sel-grade'), q=getVal('sel-quarter'), s=getVal('sel-subject'); 
            if(!g||!q||!s) return alert("Select Filters"); 
            const t=getVal('q-text'), a=getVal('opt-a'); 
            if(!t||!a) return alert("Fill Q & Opts"); 
            state.data[g][q][s].push({
                text:t, 
                options:{A:a, B:getVal('opt-b'), C:getVal('opt-c'), D:getVal('opt-d')}, 
                correct:getVal('correct-opt')
            }); 
            syncCloud(); renderQuestions(); setVal('q-text',""); 
        }

        function renderQuestions() { 
            const g=getVal('sel-grade'), q=getVal('sel-quarter'), s=getVal('sel-subject'), l=getEl('q-list'); 
            if(!l)return; l.innerHTML=""; 
            if(!g||!q||!s||!state.data[g][q][s]) { 
                if(getEl('q-empty')) getEl('q-empty').classList.remove('hidden'); return; 
            } 
            if(getEl('q-empty')) getEl('q-empty').classList.add('hidden'); 
            state.data[g][q][s].forEach((it,i)=>{ 
                const r=document.createElement('div'); r.className="p-3 border border-gray-200 rounded flex justify-between items-start bg-slate-50"; 
                r.innerHTML=`<div class="text-sm text-slate-700"><span class="font-bold mr-2">Q${i+1}</span> ${it.text}</div><button class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>`; 
                r.querySelector('button').onclick=()=>{if(confirm("Delete Q?")){state.data[g][q][s].splice(i,1); syncCloud(); renderQuestions();}}; 
                l.appendChild(r); 
            }); 
        }

        // --- 8. IMPORT/EXPORT ---
        function downloadTemplate() {
            const t = `FORMAT GUIDE:\n\n1. Who is the national hero?\nA. Andres Bonifacio\nB. Jose Rizal\nC. Mabini\nD. Aguinaldo\nAnswer: B\n\n2. Simple question?\nA. Yes\nB. No\nC. Maybe\nD. Sure\nAnswer: A`;
            const b = new Blob([t],{type:"text/plain"});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download="Exam_Template.txt"; a.click();
        }

        function importDocx(inp) {
            const g = getVal('sel-grade'), q = getVal('sel-quarter'), s = getVal('sel-subject');
            if(!g||!q||!s) return alert("Select Filters First");
            
            mammoth.extractRawText({arrayBuffer: inp.files[0]}).then(r => {
                const questions = parseDocText(r.value);
                if(questions.length === 0) return alert("No questions found.");
                if(!state.data[g][q][s]) state.data[g][q][s] = [];
                state.data[g][q][s].push(...questions); 
                syncCloud(); 
                alert("Imported "+questions.length+" questions!"); 
                renderQuestions();
            });
        }

        function parseDocText(txt) {
            const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(l => l);
            const questions = [];
            let currentQ = null;
            let buffer = "";
            let activePassage = "";
            
            const regex = { qStart: /^(\d+)[\.\)]\s*(.+)/, opt: /^([A-D])[\.\)]\s*(.+)/i, ans: /^(?:Ans|Answer|Key).*([A-D])/i };

            lines.forEach(line => {
                const qMatch = line.match(regex.qStart);
                if (qMatch) {
                    if (currentQ) questions.push(currentQ);
                    if (buffer) { activePassage = buffer; buffer = ""; }
                    currentQ = { text: qMatch[2], options: {}, correct: 'A', passage: activePassage };
                    return;
                }
                const optMatch = line.match(regex.opt);
                if (optMatch && currentQ) { currentQ.options[optMatch[1].toUpperCase()] = optMatch[2]; return; }
                const ansMatch = line.match(regex.ans);
                if (ansMatch && currentQ) { currentQ.correct = ansMatch[1].toUpperCase(); return; }
                if (buffer) buffer += "\n" + line; else buffer = line;
            });
            if (currentQ) questions.push(currentQ);
            return questions;
        }

        // --- 9. STUDENT DASHBOARD & EXAM ---
        function enterStudentDashboard() {
            const n = getVal('st-name').trim();
            const l = getVal('st-lrn').trim();
            if(!n || !l) return alert("Fill Name/LRN");
            const match = state.students.find(s => s.lrn === l && s.name.toLowerCase() === n.toLowerCase());
            if(!match) return alert("Access Denied: Not registered.");
            
            state.userType = 'student'; // Set Mode explicitly
            state.session.student = { name: match.name, lrn: match.lrn, assignedCourse: match.course };
            
            setTxt('dash-st-name', match.name);
            setTxt('dash-st-lrn', match.lrn);
            
            renderStudentResults(match.lrn);
            renderStudentExamDropdown(match.course);
            setMode('student-dashboard');
        }

        function renderStudentResults(lrn) {
            const t = getEl('student-results-table'); if(!t)return; t.innerHTML = "";
            const myRecords = state.records.filter(r => r.lrn === lrn);
            if(myRecords.length === 0) { 
                if(getEl('student-no-results')) getEl('student-no-results').classList.remove('hidden'); 
            } else {
                if(getEl('student-no-results')) getEl('student-no-results').classList.add('hidden');
                myRecords.forEach(r => t.innerHTML += `<tr class="hover:bg-slate-50"><td class="p-4 border-b border-gray-200 text-canvas-primary font-bold"><i class="fas fa-file-alt mr-1"></i> ${r.course}</td><td class="p-4 border-b border-gray-200 font-bold text-slate-700">${r.score}</td><td class="p-4 border-b border-gray-200 text-xs text-slate-500 text-right">${r.date}</td></tr>`);
            }
        }

        function renderStudentExamDropdown(assignedCourse) { 
            const s = getEl('st-course'); if(!s)return; s.innerHTML = "<option value=''>Select Subject to Take</option>"; 
            const [type, val] = assignedCourse.split(':');
            
            if(type === 'COURSE') {
                 const subjects = state.courses[val] || [];
                 const timeLimit = state.timeLimits[val] || 60;
                 subjects.forEach(subjPath => {
                    const parts = subjPath.split(' > ');
                    if(parts.length === 3) {
                        const [g, q, sub] = parts;
                        const opt = document.createElement('option');
                        opt.value = `SUBJECT:${subjPath}::${timeLimit}`; 
                        opt.text = `${sub} (${q}) - ${timeLimit} mins`;
                        s.appendChild(opt);
                    }
                });
            } else if (type === 'GRADE') {
                const gradeData = state.data[val];
                if(gradeData) {
                    Object.keys(gradeData).forEach(quarter => {
                        Object.keys(gradeData[quarter]).forEach(sub => {
                            const opt = document.createElement('option');
                            opt.value = `SUBJECT:${val} > ${quarter} > ${sub}::60`; 
                            opt.text = `${sub} (${quarter})`;
                            s.appendChild(opt);
                        });
                    });
                }
            }
        }
        
        function startExam() {
            const cVal = getVal('st-course');
            if(!cVal) return alert("Select a subject");
            
            const [typePrefix, rest] = cVal.split(':');
            if(typePrefix !== 'SUBJECT') return alert("Invalid Exam Type"); 
            
            const [path, timeStr] = rest.split('::');
            const [g, q, s] = path.split(' > ');
            
            state.session.q = []; state.session.a = {}; state.session.idx = 0;
            state.session.course = `${s} (${q})`; 
            
            if (state.data[g] && state.data[g][q] && state.data[g][q][s]) {
                 state.data[g][q][s].forEach(quest => state.session.q.push({...quest, tag: s}));
            }
            
            if(state.session.q.length===0) return alert("No questions in this subject.");
            
            const limit = parseInt(timeStr) || 60;
            state.session.seconds = limit * 60; 
            
            clearInterval(window.examTimer); 
            window.examTimer = setInterval(updateTimer, 1000);
            setMode('exam'); 
            renderExamQ();
        }

        function updateTimer() {
            state.session.seconds--;
            const m = Math.floor(state.session.seconds / 60), s = state.session.seconds % 60;
            setTxt('timer', `${m}:${s < 10 ? '0'+s : s}`);
            if(state.session.seconds <= 0) { clearInterval(window.examTimer); alert("Time's Up!"); finishExam(true); }
        }

        function renderNavigator() {
            const grid = getEl('question-grid'); if(!grid)return; grid.innerHTML = "";
            state.session.q.forEach((_, i) => {
                const btn = document.createElement('button');
                const isAns = state.session.a[i] !== undefined;
                const isCurr = i === state.session.idx;
                let cls = "w-8 h-8 rounded-sm text-xs font-bold flex items-center justify-center transition ";
                cls += isAns ? "bg-slate-200 text-slate-600 " : "bg-white border border-gray-300 text-slate-500 hover:bg-slate-50 ";
                if (isCurr) cls += "ring-2 ring-canvas-primary border-canvas-primary z-10 ";
                btn.className = cls; btn.innerText = i + 1; btn.onclick = () => window.app.jumpToQ(i);
                grid.appendChild(btn);
            });
        }

        function renderExamQ() { 
            const q=state.session.q[state.session.idx]; 
            setTxt('exam-q-text', q.text); 
            setTxt('exam-tag', q.tag); 
            setTxt('exam-progress', `Question ${state.session.idx+1}`); 
            
            const passBox = getEl('exam-passage');
            if(q.passage) { passBox.innerText = q.passage; passBox.classList.remove('hidden'); } 
            else { passBox.classList.add('hidden'); }

            const nextBtn = getEl('do-next-q');
            if(nextBtn) {
                if(state.session.idx === state.session.q.length - 1) { nextBtn.innerHTML = 'Submit Assessment'; } 
                else { nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ml-1"></i>'; }
            }

            const d=getEl('exam-opts'); if(!d)return; d.innerHTML=""; 
            ['A','B','C','D'].forEach(o=>{ if(q.options[o]){ 
                const isSelected = state.session.a[state.session.idx]===o;
                const baseCls = "w-full text-left p-3 border rounded transition flex items-start gap-2 group relative";
                const selCls = isSelected ? 'bg-slate-100 border-gray-400' : 'bg-white border-gray-300 hover:bg-slate-50';
                
                d.innerHTML+=`<button class="${baseCls} ${selCls}" onclick="window.app.ans('${o}')">
                    <div class="mt-0.5 w-4 h-4 rounded-full border border-gray-400 flex items-center justify-center bg-white ${isSelected ? 'border-[5px] border-canvas-primary' : ''}"></div>
                    <span class="text-sm text-slate-700">${q.options[o]}</span>
                </button>`; 
            }}); 
            renderNavigator();
        }

        function nextQ() { if(state.session.idx<state.session.q.length-1){state.session.idx++;renderExamQ();} else { finishExam(false); } }

        async function finishExam(force = false) {
            if(force || confirm("Submit Assessment?")){ 
                clearInterval(window.examTimer);
                let sc=0; state.session.q.forEach((q,i)=>{if(state.session.a[i]===q.correct)sc++}); 
                state.records.push({name:state.session.student.name, lrn:state.session.student.lrn, course:state.session.course, score:`${sc}/${state.session.q.length}`, date:new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString()}); 
                if(state.user) syncCloud(); 
                if(!force) alert("Assessment Submitted!\nScore: "+sc); 
                renderStudentResults(state.session.student.lrn); setMode('student-dashboard'); 
            }
        }
        
        function updateRecordFilters() {
            const s = getEl('filter-records-grade'); if(!s)return;
            s.innerHTML = "<option value=''>All Grades/Courses</option>";
            Object.keys(state.courses).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
            Object.keys(state.data).forEach(k => { if(!state.courses[k]) s.innerHTML += `<option value="${k}">${k}</option>`; });
        }
        
        function renderRecords() {
            const filter = getVal('filter-records-grade');
            const t = getEl('table-records'); if(!t)return;
            t.innerHTML = "";
            state.records.forEach(r => {
                // Find student for filter check
                const st = state.students.find(s => s.lrn === r.lrn);
                // Extract grade string, handling prefixes like 'COURSE:' or 'GRADE:'
                const stGrade = st ? (st.course.split(':')[1] || st.course) : 'N/A';

                if(filter && stGrade !== filter) return;

                t.innerHTML += `<tr class="hover:bg-slate-50 border-b border-gray-200">
                    <td class="p-3 border-r border-gray-200 text-slate-700 font-bold">${r.name}</td>
                    <td class="p-3 border-r border-gray-200 text-slate-500 text-xs font-mono">${stGrade}</td>
                    <td class="p-3 border-r border-gray-200 text-slate-600">${r.course}</td>
                    <td class="p-3 border-r border-gray-200 font-bold text-slate-700">${r.score}</td>
                    <td class="p-3 text-right text-xs text-slate-500">${r.date}</td>
                </tr>`;
            });
        }

        // --- 10. NEW FUNCTIONS: COURSES & CALENDAR ---

        function renderCourses() {
            const grid = getEl('courses-grid');
            if(!grid) return;
            grid.innerHTML = "";
            let items = [];

            if (state.userType === 'student') {
                getEl('courses-title').innerText = "My Enrolled Courses";
                // Show enrolled course
                const assigned = state.session.student?.assignedCourse;
                if(assigned) items.push(assigned.split(':')[1] || assigned);
            } else {
                getEl('courses-title').innerText = "All Active Courses";
                // Show all created courses
                items = Object.keys(state.courses);
                // Also add raw Grade levels created
                Object.keys(state.data).forEach(grade => {
                    if(!items.includes(grade) && !state.courses[grade]) items.push(grade);
                });
            }

            if(items.length === 0) {
                getEl('courses-empty').classList.remove('hidden');
            } else {
                getEl('courses-empty').classList.add('hidden');
                items.forEach(c => {
                    grid.innerHTML += `
                        <div class="bg-white rounded-lg shadow-card overflow-hidden group hover:shadow-lg transition-all border border-gray-200">
                            <div class="h-24 bg-canvas-primary relative">
                                <div class="absolute bottom-2 left-4 text-white font-bold text-lg text-shadow"><i class="fas fa-book mr-2"></i> ${c}</div>
                            </div>
                            <div class="p-4">
                                <p class="text-xs text-slate-500 mb-4">Active Session</p>
                                <button class="w-full bg-slate-100 text-slate-600 py-2 rounded text-sm font-bold hover:bg-slate-200">View Details</button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        function renderCalendar() {
            const grid = getEl('calendar-days');
            const events = getEl('calendar-events');
            if(!grid || !events) return;
            
            grid.innerHTML = "";
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const startDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();

            // Padding
            for(let i=0; i<startDay; i++) grid.innerHTML += `<div></div>`;
            
            // Days
            for(let i=1; i<=daysInMonth; i++) {
                const isToday = i === today.getDate();
                grid.innerHTML += `<div class="calendar-day ${isToday ? 'today' : 'bg-slate-50 text-slate-600'}">${i}</div>`;
            }

            // Mock Events
            events.innerHTML = "";
            const evtList = [
                { title: "Midterm Assessment", date: "Tomorrow, 10:00 AM" },
                { title: "Quarterly Review", date: "Oct 24, 2:00 PM" },
                { title: "Grade Submission", date: "Oct 30, 5:00 PM" }
            ];
            
            evtList.forEach(e => {
                events.innerHTML += `
                    <div class="flex gap-3 items-center p-3 bg-white rounded border border-gray-200 shadow-sm">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded flex items-center justify-center font-bold text-xs flex-col leading-tight">
                            <span>${today.toLocaleString('default', { month: 'short' })}</span>
                            <span>${Math.floor(Math.random() * 28) + 1}</span>
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${e.title}</div>
                            <div class="text-xs text-slate-500">${e.date}</div>
                        </div>
                    </div>
                `;
            });
        }

        // --- 11. SYSTEM BINDINGS ---
        function setMode(m){
            const view = getEl(`view-${m}`);
            if(!view) return console.error('View not found:', m);
            document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden'));
            view.classList.remove('hidden');
            const ctx = getEl('header-context');
            if(m==='landing') ctx.innerText = 'Dashboard';
            if(m==='dashboard') ctx.innerText = 'Course';
            if(m==='student-dashboard') ctx.innerText = 'My Dashboard';
            if(m==='courses') ctx.innerText = 'All Courses';
            if(m==='calendar') ctx.innerText = 'Calendar';

            // Sidebar Visibility Logic
            const navLinks = getEl('nav-links');
            const logoutBtn = getEl('btn-logout');

            if(navLinks) {
                // Show nav on dashboards, courses, calendar (Teacher OR Student)
                if(['dashboard', 'student-dashboard', 'courses', 'calendar'].includes(m)) {
                    navLinks.classList.remove('hidden');
                    if(logoutBtn) logoutBtn.classList.remove('hidden');
                } else {
                    navLinks.classList.add('hidden');
                    // Hide logout on landing/login screens
                    if(logoutBtn) logoutBtn.classList.add('hidden');
                }
            }
            
            // Re-render shared views based on User Type
            if(m === 'courses') renderCourses();
            if(m === 'calendar') renderCalendar();
        }

        function toggleRegister(s){
            const fl=getEl('form-login'), fr=getEl('form-register');
            if(fl) fl.classList.toggle('hidden',s);
            if(fr) fr.classList.toggle('hidden',!s);
        }

        function setTab(t){
            const tab = getEl(`tab-${t}`);
            if(!tab) return;
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            tab.classList.remove('hidden');
            document.querySelectorAll('.nav-tab-btn').forEach(btn => btn.classList.remove('active'));
            const btn = getEl(`tab-btn-${t}`);
            if(btn) btn.classList.add('active');
            if(t==='records') { updateRecordFilters(); renderRecords(); } 
            if(t==='students') renderStudentRegistry();
        }

        function handleLogout() {
            if (state.userType === 'student') {
                if(confirm("Log out of Student Portal?")) {
                    state.userType = 'teacher'; // Revert context
                    state.session.student = null;
                    setMode('landing');
                }
            } else {
                signOut(auth);
            }
        }

        function navDashboard() {
            if(state.userType === 'student') setMode('student-dashboard');
            else setMode('dashboard');
        }

        // Global Event Listeners
        document.addEventListener('click', e => {
            const el = e.target.closest('[id]');
            const id = el ? el.id : null;
            if(!id) return;
            
            // Auth & Nav
            if(id === 'do-login') login();
            if(id === 'do-register') register();
            if(id === 'btn-logout') handleLogout();
            
            // Sidebar Navigation (SMART LINKS)
            if(id === 'nav-btn-dashboard') navDashboard();
            if(id === 'nav-btn-courses') setMode('courses');
            if(id === 'nav-btn-calendar') setMode('calendar');

            if(id === 'do-google-login') {
                signInWithPopup(auth,googleProvider)
                .then(r=>{ 
                    state.userType = 'teacher';
                    alert("Welcome "+r.user.displayName); 
                    setMode('dashboard'); 
                })
                .catch(err=>{ 
                    if(err.code==='auth/unauthorized-domain'){ 
                        getEl('error-banner').classList.remove('hidden');
                        setTxt('current-domain', currentDomain);
                    } else alert(err.message); 
                });
            }
            if(id === 'nav-teacher') setMode('teacher-login');
            if(id === 'nav-student') setMode('student-login');
            if(id === 'close-login' || id === 'close-student') setMode('landing');
            if(id === 'show-register') toggleRegister(true);
            if(id === 'cancel-register') toggleRegister(false);
            if(id.startsWith('tab-btn-')) setTab(id.replace('tab-btn-',''));
            
            // Actions
            if(id === 'do-sync') syncCloud();
            if(id === 'do-save-profile') saveProfile();
            if(id === 'do-reset-year') resetYear();
            if(id === 'do-add-grade') addGrade();
            if(id === 'do-add-quarter') addQuarter();
            if(id === 'do-add-subject') addSubject();
            if(id === 'do-add-course') addCourse();
            if(id === 'do-save-manual') saveManualQ();
            if(id === 'do-add-student') addStudent();
            if(id === 'do-get-template') downloadTemplate();
            
            // Student Actions
            if(id === 'do-student-login') enterStudentDashboard();
            if(id === 'do-start-exam') startExam();
            if(id === 'do-next-q') nextQ();
            if(id === 'do-exit-exam') finishExam(false);
        });

        document.addEventListener('change', e => {
            if(e.target.id === 'docx-upload') importDocx(e.target);
            if(e.target.id === 'filter-records-grade') renderRecords();
        });

        window.app = {
            setMode,
            navDashboard,
            ans: (o) => { state.session.a[state.session.idx]=o; renderExamQ(); },
            jumpToQ: (i) => { state.session.idx=i; renderExamQ(); }
        };

        onAuthStateChanged(auth, u => {
            state.user = u;
            if(u) { 
                setTxt('status-indicator', "Online"); 
                statusEl.className = "text-[10px] font-mono font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200";
                
                // Set default to teacher, but DON'T force navigate if we are already somewhere else useful
                // This allows 'student mode' to persist slightly better, though strict persistence needs localStorage
                // For this request, we default to teacher dashboard on HARD Reload
                state.userType = 'teacher';
                setMode('dashboard');
                fetchData(); 
            } else { 
                setTxt('status-indicator', "Offline"); 
                state.userType = 'teacher';
                setMode('landing'); 
            }
        });
    </script>
</body>
</html>
