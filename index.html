<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCAE Examination System (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>

    <!-- FIREBASE CONNECTION -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // YOUR KEYS
        const firebaseConfig = {
            apiKey: "AIzaSyA7Sa9kkTFLF_cHS00DPzo8l847awBkBms",
            authDomain: "ncae-exam.firebaseapp.com",
            projectId: "ncae-exam",
            storageBucket: "ncae-exam.firebasestorage.app",
            messagingSenderId: "560276612754",
            appId: "1:560276612754:web:29169fa8f0d4752c28284b"
        };

        // Initialize Cloud Connection
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log("System Online: Cloud Database Active");
    </script>

    <style>
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print {
            body > * { display: none !important; }
            body > #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            #print-area * { visibility: visible !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col font-sans overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col h-full relative">
        
        <!-- HEADER -->
        <header class="bg-blue-900 text-white p-3 shadow-md flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold">
                    <i class="fas fa-book"></i>
                </div>
                <div>
                    <h1 class="font-bold leading-tight">NCAE System</h1>
                    <p class="text-[10px] text-blue-200" id="connection-status">Connecting to Cloud...</p>
                </div>
            </div>
            <button onclick="app.logout()" id="logout-btn" class="hidden text-xs bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-white transition">
                <i class="fas fa-power-off mr-1"></i> Logout
            </button>
        </header>

        <!-- VIEW 1: LANDING -->
        <div id="view-landing" class="flex-1 flex items-center justify-center p-4 fade-in">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8 text-center space-y-6">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-3xl mx-auto">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h2 class="text-xl font-bold">Select Portal</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="app.setMode('student-login')" class="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition">
                        <i class="fas fa-user text-2xl text-blue-500 mb-2"></i>
                        <div class="font-bold text-sm">Student</div>
                    </button>
                    <button onclick="app.setMode('teacher-login')" class="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition">
                        <i class="fas fa-chalkboard-teacher text-2xl text-orange-500 mb-2"></i>
                        <div class="font-bold text-sm">Teacher</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: TEACHER LOGIN -->
        <div id="view-teacher-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
            <div class="max-w-sm w-full bg-white rounded-xl shadow-lg p-6 relative">
                <button onclick="app.setMode('landing')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
                
                <!-- LOGIN FORM -->
                <div id="form-login">
                    <h2 class="text-lg font-bold mb-4">Teacher Login</h2>
                    <input type="text" id="login-user" class="w-full p-3 border rounded mb-3 text-sm" placeholder="Username">
                    <input type="password" id="login-pass" class="w-full p-3 border rounded mb-4 text-sm" placeholder="Password">
                    <button onclick="app.loginTeacher()" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800">Login</button>
                    <div class="text-center mt-4 text-xs">
                        New here? <button onclick="app.toggleRegister(true)" class="text-blue-600 font-bold">Create Account</button>
                    </div>
                </div>

                <!-- REGISTER FORM -->
                <div id="form-register" class="hidden">
                    <h2 class="text-lg font-bold mb-1">Create Account</h2>
                    <p class="text-xs text-slate-500 mb-4">Your data will be saved to the cloud.</p>
                    <input type="text" id="reg-name" class="w-full p-3 border rounded mb-2 text-sm" placeholder="Full Name">
                    <input type="text" id="reg-user" class="w-full p-3 border rounded mb-2 text-sm" placeholder="Username">
                    <input type="password" id="reg-pass" class="w-full p-3 border rounded mb-4 text-sm" placeholder="Password">
                    <button onclick="app.registerTeacher()" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700">Register</button>
                    <div class="text-center mt-4 text-xs">
                        <button onclick="app.toggleRegister(false)" class="text-slate-500">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: DASHBOARD -->
        <div id="view-dashboard" class="hidden flex-1 flex overflow-hidden fade-in bg-slate-50">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r flex flex-col z-10 hidden md:flex">
                <div class="p-4 border-b">
                    <div class="font-bold truncate" id="dash-name">Teacher</div>
                    <div class="text-xs text-green-600 flex items-center gap-1"><i class="fas fa-circle text-[8px]"></i> Online</div>
                </div>
                <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                    <button onclick="app.setTab('manage')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-edit w-6 text-slate-400"></i> Manage Questions</button>
                    <button onclick="app.setTab('curriculum')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-book w-6 text-slate-400"></i> Curriculum</button>
                    <button onclick="app.setTab('records')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-sm font-medium"><i class="fas fa-users w-6 text-slate-400"></i> Student Records</button>
                </nav>
                <div class="p-4 border-t">
                    <button onclick="app.syncCloud()" class="w-full bg-blue-100 text-blue-800 text-xs font-bold py-2 rounded hover:bg-blue-200">
                        <i class="fas fa-cloud-upload-alt mr-1"></i> Force Save
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto custom-scroll p-4 relative">
                <!-- Mobile Menu Button -->
                <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="md:hidden absolute top-4 left-4 z-20 bg-white p-2 rounded shadow text-slate-600">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- TAB: MANAGE QUESTIONS -->
                <div id="tab-manage" class="tab-content max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6 pl-12 md:pl-0">
                        <h2 class="text-xl font-bold">Question Bank</h2>
                        <div class="flex gap-2">
                             <input type="file" id="docx-upload" class="hidden" accept=".docx" onchange="app.importDocx(this)">
                             <button onclick="document.getElementById('docx-upload').click()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded font-bold shadow hover:bg-blue-700"><i class="fas fa-file-word mr-1"></i> Import .DOCX</button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border mb-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-400">Domain</label>
                            <select id="sel-domain" onchange="app.updateSubtests()" class="w-full p-2 border rounded bg-slate-50 text-sm"></select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-400">Subtest</label>
                            <select id="sel-subtest" onchange="app.renderQuestions()" class="w-full p-2 border rounded bg-slate-50 text-sm"></select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden min-h-[300px]">
                        <div id="q-list" class="divide-y">
                            <!-- Questions go here -->
                        </div>
                        <div id="q-empty" class="p-10 text-center text-slate-400 text-sm">
                            No questions selected. <br> Choose a domain/subtest or import a file.
                        </div>
                    </div>
                </div>

                <!-- TAB: CURRICULUM -->
                <div id="tab-curriculum" class="hidden tab-content max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold mb-4 pl-12 md:pl-0">Curriculum Setup</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
                        <h3 class="font-bold text-sm mb-2">Add New Subject</h3>
                        <div class="flex gap-2">
                            <input type="text" id="new-subj" class="flex-1 p-2 border rounded text-sm" placeholder="Subject Name">
                            <button onclick="app.addSubject()" class="bg-blue-600 text-white px-4 rounded text-sm font-bold">Add</button>
                        </div>
                        <div id="list-subj" class="mt-4 flex flex-wrap gap-2"></div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-sm mb-2">Create Grade Level / Course</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-course" class="flex-1 p-2 border rounded text-sm" placeholder="Course Name (e.g. Grade 10)">
                            <button onclick="app.addCourse()" class="bg-green-600 text-white px-4 rounded text-sm font-bold">Save</button>
                        </div>
                        <div id="chk-subj" class="grid grid-cols-2 gap-2 mb-4 text-sm"></div>
                        <div id="list-course" class="space-y-2"></div>
                    </div>
                </div>

                <!-- TAB: RECORDS -->
                <div id="tab-records" class="hidden tab-content max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold mb-4 pl-12 md:pl-0">Student Records</h2>
                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr>
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Score</th>
                                    <th class="p-3">Date</th>
                                </tr>
                            </thead>
                            <tbody id="table-records"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>

        <!-- VIEW 4: STUDENT LOGIN & EXAM -->
        <div id="view-student-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in bg-slate-50">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-6 relative">
                <button onclick="app.setMode('landing')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
                <h2 class="text-lg font-bold mb-4">Student Access</h2>
                <div class="space-y-3">
                    <input type="text" id="st-name" class="w-full p-3 border rounded text-sm" placeholder="Full Name">
                    <input type="text" id="st-lrn" class="w-full p-3 border rounded text-sm" placeholder="LRN Number">
                    <select id="st-course" class="w-full p-3 border rounded text-sm bg-white"></select>
                    <button onclick="app.startExam()" class="w-full bg-blue-600 text-white font-bold py-3 rounded mt-2 hover:bg-blue-700">Start Exam</button>
                </div>
            </div>
        </div>

        <!-- VIEW 5: EXAM PORTAL -->
        <div id="view-exam" class="hidden flex-1 flex flex-col bg-white fade-in">
            <header class="p-4 border-b flex justify-between items-center bg-slate-50">
                <div>
                    <h1 class="font-bold">Exam Portal</h1>
                    <p class="text-xs text-slate-500" id="exam-student-info">--</p>
                </div>
                <div class="font-mono font-bold text-xl" id="timer">00:00</div>
            </header>
            <main class="flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto">
                <div class="max-w-2xl w-full">
                    <div class="mb-6">
                        <span class="text-[10px] font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded" id="exam-tag">SUBJ</span>
                        <h2 class="text-lg font-medium mt-2" id="exam-q-text">Loading...</h2>
                    </div>
                    <div class="space-y-3" id="exam-opts">
                        <!-- Options generated here -->
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <span class="text-xs text-slate-400" id="exam-progress">1 / 10</span>
                        <button onclick="app.nextQ()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Next</button>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        const app = {
            user: null,
            data: {}, // Questions
            courses: {}, // Course Config
            records: [], // Submissions
            
            // Exam State
            session: { q: [], a: {}, idx: 0, student: {} },

            init() {
                // Listen for Cloud Login
                auth.onAuthStateChanged(u => {
                    this.user = u;
                    if (u) {
                        document.getElementById('connection-status').innerText = "Cloud: " + u.email;
                        document.getElementById('logout-btn').classList.remove('hidden');
                        this.fetchData(); // Load data from cloud
                    } else {
                        document.getElementById('connection-status').innerText = "Offline Mode";
                        document.getElementById('logout-btn').classList.add('hidden');
                        this.setMode('landing');
                    }
                });
            },

            // --- CLOUD SYNC ---
            fetchData() {
                if(!this.user) return;
                db.collection('teachers').doc(this.user.uid).get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        this.data = d.examData ? JSON.parse(d.examData) : {};
                        this.courses = d.courses ? JSON.parse(d.courses) : {};
                        this.records = d.records ? JSON.parse(d.records) : [];
                        document.getElementById('dash-name').innerText = d.fullName || "Teacher";
                        // Setup UI
                        this.updateDomainList();
                        this.renderSubjList();
                        this.renderCourseList();
                    }
                });
            },

            syncCloud() {
                if(!this.user) return;
                const payload = {
                    examData: JSON.stringify(this.data),
                    courses: JSON.stringify(this.courses),
                    records: JSON.stringify(this.records),
                    lastSync: new Date().toISOString()
                };
                db.collection('teachers').doc(this.user.uid).update(payload)
                    .then(() => alert("Saved to Cloud!"))
                    .catch(e => alert("Save Error: " + e.message));
            },

            // --- AUTH ---
            loginTeacher() {
                const u = document.getElementById('login-user').value + "@ncae.com";
                const p = document.getElementById('login-pass').value;
                auth.signInWithEmailAndPassword(u, p)
                    .then(() => this.setMode('dashboard'))
                    .catch(e => alert(e.message));
            },

            registerTeacher() {
                const n = document.getElementById('reg-name').value;
                const u = document.getElementById('reg-user').value + "@ncae.com";
                const p = document.getElementById('reg-pass').value;
                if(!n || !p) return alert("Fill all fields");

                auth.createUserWithEmailAndPassword(u, p).then(cred => {
                    return db.collection('teachers').doc(cred.user.uid).set({
                        fullName: n, username: document.getElementById('reg-user').value,
                        examData: "{}", courses: "{}", records: "[]"
                    });
                }).then(() => {
                    alert("Registered! You are now logged in.");
                    this.setMode('dashboard');
                }).catch(e => alert(e.message));
            },

            logout() { auth.signOut(); },

            toggleRegister(show) {
                document.getElementById('form-login').classList.toggle('hidden', show);
                document.getElementById('form-register').classList.toggle('hidden', !show);
            },

            // --- NAVIGATION ---
            setMode(m) {
                document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
                document.getElementById(`view-${m}`).classList.remove('hidden');
                if(m === 'student-login') this.renderStudentDropdown();
            },
            setTab(t) {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
                document.getElementById(`tab-${t}`).classList.remove('hidden');
                if(t === 'records') this.renderRecords();
            },

            // --- DATA LOGIC ---
            addSubject() {
                const n = document.getElementById('new-subj').value;
                if(n && !this.data[n]) {
                    this.data[n] = {};
                    this.syncCloud();
                    this.renderSubjList();
                    document.getElementById('new-subj').value = "";
                }
            },
            renderSubjList() {
                const div = document.getElementById('list-subj');
                const chk = document.getElementById('chk-subj');
                div.innerHTML = ""; chk.innerHTML = "";
                Object.keys(this.data).forEach(k => {
                    div.innerHTML += `<span class="bg-blue-100 px-2 py-1 rounded text-xs font-bold text-blue-800">${k}</span>`;
                    chk.innerHTML += `<label><input type="checkbox" value="${k}" class="c-chk"> ${k}</label>`;
                });
                this.updateDomainList();
            },
            addCourse() {
                const n = document.getElementById('new-course').value;
                if(!n) return;
                const selected = Array.from(document.querySelectorAll('.c-chk:checked')).map(c => c.value);
                this.courses[n] = selected;
                this.syncCloud();
                this.renderCourseList();
                document.getElementById('new-course').value = "";
            },
            renderCourseList() {
                const d = document.getElementById('list-course');
                d.innerHTML = "";
                Object.keys(this.courses).forEach(k => {
                    d.innerHTML += `<div class="p-2 border rounded bg-slate-50 flex justify-between"><span class="font-bold text-sm">${k}</span> <span class="text-xs text-slate-500">${this.courses[k].join(', ')}</span></div>`;
                });
            },

            // --- QUESTIONS ---
            updateDomainList() {
                const s = document.getElementById('sel-domain');
                s.innerHTML = "<option value=''>Select Domain</option>";
                Object.keys(this.data).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
            },
            updateSubtests() {
                const d = document.getElementById('sel-domain').value;
                const s = document.getElementById('sel-subtest');
                s.innerHTML = "<option value=''>Select Subtest</option>";
                if(this.data[d]) {
                    Object.keys(this.data[d]).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
                }
            },
            renderQuestions() {
                const d = document.getElementById('sel-domain').value;
                const s = document.getElementById('sel-subtest').value;
                const div = document.getElementById('q-list');
                const empty = document.getElementById('q-empty');
                div.innerHTML = "";
                
                if(!d || !s || !this.data[d][s]) {
                    empty.classList.remove('hidden'); return;
                }
                empty.classList.add('hidden');
                
                this.data[d][s].forEach((q, i) => {
                    div.innerHTML += `<div class="p-3 hover:bg-slate-50 relative group">
                        <button onclick="app.delQ('${d}','${s}',${i})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
                        <div class="font-bold text-sm text-slate-700">${i+1}. ${q.text}</div>
                        <div class="text-xs text-green-600 font-mono mt-1">Ans: ${q.correct}</div>
                    </div>`;
                });
            },
            delQ(d,s,i) {
                if(confirm("Delete?")) {
                    this.data[d][s].splice(i,1);
                    this.syncCloud();
                    this.renderQuestions();
                }
            },

            // --- IMPORT ---
            importDocx(input) {
                const d = document.getElementById('sel-domain').value;
                const s = document.getElementById('sel-subtest').value;
                if(!d) return alert("Select a Domain first!"); 
                
                // If subtest doesn't exist, create it (General)
                const targetS = s || "General";
                if(!this.data[d][targetS]) this.data[d][targetS] = [];

                mammoth.extractRawText({arrayBuffer: input.files[0]}).then(r => {
                    const parsed = this.parseText(r.value);
                    this.data[d][targetS].push(...parsed);
                    this.syncCloud();
                    // Force refresh selectors if we created a new subtest
                    if(!s) this.updateSubtests(); 
                    alert("Imported " + parsed.length + " questions!");
                    // Select the subtest automatically
                    document.getElementById('sel-subtest').value = targetS;
                    this.renderQuestions();
                });
            },
            parseText(txt) {
                // Simple Parser
                const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
                const qs = [];
                let curr = null;
                lines.forEach(line => {
                    if(line.match(/^(?:Answer|Ans)\s*[:\-]?\s*([A-D])/i)) {
                        if(curr) curr.correct = RegExp.$1.toUpperCase();
                    } else if(line.match(/^(\(?[A-D]\)?|[A-D]\.)\s*(.+)/i)) {
                        if(curr) curr.options[RegExp.$1.replace(/[^A-Z]/gi,'')] = RegExp.$2;
                    } else if(line.match(/^(\d+[\.\)]|Q\d+)\s*(.+)/i)) {
                        if(curr) qs.push(curr);
                        curr = {text: RegExp.$2, options:{}, correct:'A'};
                    } else if(curr) {
                        if(Object.keys(curr.options).length === 0) curr.text += " " + line;
                    }
                });
                if(curr) qs.push(curr);
                return qs;
            },

            // --- EXAM ---
            renderStudentDropdown() {
                const s = document.getElementById('st-course');
                s.innerHTML = "<option value=''>Select Course</option>";
                Object.keys(this.courses).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
            },
            startExam() {
                const n = document.getElementById('st-name').value;
                const c = document.getElementById('st-course').value;
                const l = document.getElementById('st-lrn').value;
                if(!n || !c) return alert("Details required");

                this.session.student = { name: n, course: c, lrn: l };
                this.session.q = [];
                
                // Gather questions
                const subjs = this.courses[c];
                if(subjs) {
                    subjs.forEach(subj => {
                        if(this.data[subj]) {
                            Object.keys(this.data[subj]).forEach(test => {
                                this.data[subj][test].forEach(q => {
                                    this.session.q.push({...q, tag: subj});
                                });
                            });
                        }
                    });
                }
                
                if(this.session.q.length === 0) return alert("No questions for this course yet.");
                
                this.session.idx = 0;
                this.session.a = {};
                this.setMode('exam');
                this.renderExamQ();
            },
            renderExamQ() {
                const q = this.session.q[this.session.idx];
                document.getElementById('exam-student-info').innerText = `${this.session.student.name} | ${this.session.student.course}`;
                document.getElementById('exam-tag').innerText = q.tag;
                document.getElementById('exam-q-text').innerText = q.text;
                document.getElementById('exam-progress').innerText = `${this.session.idx + 1} / ${this.session.q.length}`;
                
                const div = document.getElementById('exam-opts');
                div.innerHTML = "";
                ['A','B','C','D'].forEach(opt => {
                    if(q.options[opt]) {
                        const isSel = this.session.a[this.session.idx] === opt;
                        div.innerHTML += `<button onclick="app.ans('${opt}')" class="w-full text-left p-3 border rounded hover:bg-blue-50 ${isSel ? 'bg-blue-100 border-blue-500' : ''}">
                            <span class="font-bold text-slate-400 mr-2">${opt}</span> ${q.options[opt]}
                        </button>`;
                    }
                });
            },
            ans(opt) {
                this.session.a[this.session.idx] = opt;
                this.renderExamQ();
            },
            nextQ() {
                if(this.session.idx < this.session.q.length - 1) {
                    this.session.idx++;
                    this.renderExamQ();
                } else {
                    if(confirm("Submit Exam?")) this.submitExam();
                }
            },
            submitExam() {
                let score = 0;
                this.session.q.forEach((q, i) => {
                    if(this.session.a[i] === q.correct) score++;
                });
                
                const rec = {
                    name: this.session.student.name,
                    score: `${score}/${this.session.q.length}`,
                    date: new Date().toLocaleDateString()
                };
                
                // Save locally first then try to sync if teacher is logged in (Kiosk Mode)
                this.records.push(rec);
                if(this.user) this.syncCloud();
                
                alert(`Exam Complete!\nScore: ${score} / ${this.session.q.length}`);
                this.setMode('landing');
            },
            renderRecords() {
                const t = document.getElementById('table-records');
                t.innerHTML = "";
                this.records.forEach(r => {
                    t.innerHTML += `<tr class="border-b"><td class="p-3 font-bold">${r.name}</td><td class="p-3 text-blue-600">${r.score}</td><td class="p-3 text-xs text-slate-500">${r.date}</td></tr>`;
                });
            }
        };

        app.init();
    </script>
</body>
</html>