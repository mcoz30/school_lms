<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LearnNovaLMS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { 
                            base: '#2D3B45', 
                            primary: '#0e1e24', 
                            accent: 'var(--accent-color)', 
                            danger: '#EE4D3D', 
                            success: '#00AC18',
                            light: '#F5F5F5'
                        }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        /* Dynamic Theme Variables */
        :root {
            --bg-style: #F5F5F5;
            --glass-bg: #ffffff;
            --glass-border: 1px solid #e2e8f0;
            --glass-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --backdrop-blur: none;
            --text-color: #2D3B45;
            --sidebar-bg: #ffffff;
            --nav-item-active-bg: rgba(3, 116, 181, 0.1);
            
            /* Theme Variables */
            --header-bg: #ffffff;
            --header-text: #2D3B45;
            --header-shadow: none;
            --global-border-color: #e2e8f0;
            --accent-color: #0374B5; 
            --btn-bg: #0374B5; 
        }

        body { 
            background: var(--bg-style); 
            color: var(--text-color); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* Professional Card Style */
        .theme-panel {
            background: var(--glass-bg);
            border: 1px solid var(--global-border-color);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Header Styling */
        header.theme-panel {
            background: var(--header-bg) !important;
            color: var(--header-text) !important;
            border-bottom: 1px solid var(--global-border-color) !important;
            text-shadow: var(--header-shadow);
        }
        
        /* Custom Button Class */
        .btn-theme {
            background: var(--btn-bg);
            color: white;
            border: none;
            transition: all 0.2s;
        }
        .btn-theme:hover { opacity: 0.95; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .text-theme { color: var(--accent-color); }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
        
        .nav-item.active { background: var(--nav-item-active-bg); color: var(--accent-color); border-right: 3px solid var(--accent-color); }

        /* Global Nav */
        #global-nav { 
            width: 84px; flex-shrink: 0; 
            background: var(--sidebar-bg);
            display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; 
            border-right: 1px solid var(--global-border-color);
            backdrop-filter: var(--backdrop-blur);
        }
        .nav-item { color: var(--text-color); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; opacity: 0.8; }
        .nav-item:hover { background-color: rgba(0,0,0,0.05); opacity: 1; }
        .nav-item.active { background-color: rgba(var(--accent-color), 0.1); color: var(--accent-color); border-left: 4px solid var(--accent-color); opacity: 1; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }

        /* Course Cards */
        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .course-header { height: 140px; background-size: cover; background-position: center; position: relative; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.1); }
        .cal-cell { background: var(--glass-bg); min-height: 120px; padding: 0.5rem; position: relative; }
        .cal-cell.today { background: rgba(var(--accent-color), 0.1); border: 1px solid var(--accent-color); }
        .event-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; items-center; gap: 4px; transition: opacity 0.2s; }
        
        /* Feed */
        .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; margin-top: 10px; } 
        .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Module & Activity Builder Styles */
        .module-block { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: rgba(255,255,255,0.8); position: relative; transition: all 0.2s; }
        .module-block:hover { border-color: var(--accent-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .module-block:hover .block-actions { opacity: 1; }
        .rich-toolbar { background: rgba(0,0,0,0.02); padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .rich-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; font-size: 12px; font-weight: bold; color: #475569; display: inline-flex; align-items: center; justify-content: center; height: 28px; min-width: 28px; }
        .rich-btn:hover { background: #e2e8f0; color: #0f172a; }
        .rich-content { min-height: 80px; padding: 10px; outline: none; background: white; color: #334155; }
        
        /* Grade Table Styles */
        .grade-table { border-collapse: collapse; }
        .grade-table th, .grade-table td { padding: 0.75rem; border-right: 1px solid #e5e7eb; }
        .grade-table th { background: #f9fafb; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #6b7280; }
        .grade-table tbody tr:hover { background: #f9fafb; }
        .grade-input { width: 60px; padding: 4px; text-align: center; border: 1px solid #d1d5db; border-radius: 4px; }
        .grade-input:focus { outline: none; border-color: #0374B5; box-shadow: 0 0 0 2px rgba(3, 116, 181, 0.1); }
        
        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #global-nav { width: 100%; height: 60px; flex-direction: row; padding: 0; justify-content: space-around; position: fixed; bottom: 0; }
            .nav-item { padding: 0.5rem; }
            .nav-label { display: none; }
            #content-area { padding-bottom: 80px; }
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .cal-cell { min-height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
            .cal-header-row { display: none; }
        }
        
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; align-items: center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body class="h-screen overflow-hidden text-sm font-sans">

    <div id="loading-screen"><i class="fas fa-circle-notch fa-spin text-4xl"></i><p class="font-bold tracking-widest">CONNECTING...</p></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved</div>
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// --- SUPABASE CONFIGURATION ---
const supabaseUrl = 'https://lgovvztkuqnpsshdrwyu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnb3Z2enRrdXFucHNzaGRyd3l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTY0OTgsImV4cCI6MjA4NTU5MjQ5OH0.0gks6pz9g8JCP6LMiKEGQj3J-M27ljGPLwv-umyoPVA';

const supabase = createClient(supabaseUrl, supabaseKey);

// --- DATA STORE - OPTIMIZED STRUCTURE ---
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u3', name: 'Maria Santos', role: 'student', username: 'student2', password: '123', avatar: 'MS' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '123', avatar: 'AD' } 
    ],
    subjects: [
        { 
            id: 's1', 
            name: 'Introduction to Physics', 
            code: 'PHYS-101', 
            teacherId: 'u1', 
            students: ['u2', 'u3'], 
            color: '#0374B5', 
            img: '', 
            introTitle: 'Welcome to Physics', 
            introBody: 'Check the feed.', 
            gradingWeights: { ww: 40, pt: 40, qa: 20 } 
        }
    ],
    posts: [],
    globalPosts: [],
    activities: [],
    activitySubmissions: {},
    exams: [],
    examSubmissions: {},
    modules: [],
    grades: [], // NEW: Flat structure for manual grades
    globalEvents: [],
    theme: { 
        appName: 'LearnNovaLMS', 
        logoUrl: '', 
        bgType: 'color', 
        bgColor: '#F5F5F5', 
        bgGradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', 
        bgImage: '', 
        glassEffect: false, 
        glassOpacity: 0.95 
    }
};

let db = defaultData, currentUser = null, currentView = 'login', currentCourseId = null, currentTab = 'home', calendarDate = new Date(), importedText = '', tempPostImage = null, adminCourseFilter = 'all', selectedLoginRole = null; 
let builderBlocks = [], editingModuleId = null, editingActivityId = null;

// --- PH HOLIDAYS ---
const phHolidays = [
    {m:0, d:1, t:'New Year\'s Day', c:'red'}, {m:1, d:25, t:'EDSA Revolution', c:'yellow'}, {m:3, d:9, t:'Araw ng Kagitingan', c:'red'}, {m:4, d:1, t:'Labor Day', c:'red'},
    {m:5, d:12, t:'Independence Day', c:'blue'}, {m:7, d:21, t:'Ninoy Aquino Day', c:'yellow'}, {m:7, d:28, t:'National Heroes Day', c:'red'}, {m:10, d:1, t:'All Saints Day', c:'purple'},
    {m:10, d:2, t:'All Souls Day', c:'purple'}, {m:10, d:30, t:'Bonifacio Day', c:'red'}, {m:11, d:8, t:'Feast of Immaculate Conception', c:'blue'}, {m:11, d:25, t:'Christmas Day', c:'green'}, {m:11, d:30, t:'Rizal Day', c:'blue'}
];

// --- OPTIMIZED SUPABASE SYNC (NO REALTIME UPDATES) ---
let saveTimeout = null;
let isSaving = false;

async function initSupabase() {
    console.log("Initializing Supabase...");
    
    try {
        // Load data from Supabase
        const { data: appData, error } = await supabase
            .from('app_data')
            .select('data')
            .eq('id', 'master_record')
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error("Supabase Error:", error);
            console.error("Error details:", error.message, error.hint, error.details);
            // Remove loading screen before showing error
            const l = $('loading-screen');
            if(l) {
                l.style.opacity=0;
                setTimeout(() => l.remove(), 500);
                $('app').classList.remove('opacity-0');
            }
            showDatabaseErrorModal(error.code);
            // Still proceed to login even with error
            if(!currentUser) render();
            return;
        }
        
        if (appData && appData.data) {
            console.log("Data loaded from Supabase successfully");
            db = appData.data;
            // Ensure all required fields exist
            ensureDataStructure();
        } else {
            console.log("No data found, initializing with default data");
            // Try to save initial data, but don't block if it fails
            try {
                await saveDB(); 
            } catch (saveError) {
                console.error("Initial save failed:", saveError);
                // Continue anyway - user can still use the app
            }
        }
        
        applyTheme();
        
        const l = $('loading-screen');
        if(l) {
            l.style.opacity=0;
            setTimeout(() => l.remove(), 500);
            $('app').classList.remove('opacity-0');
        }
        
        if(!currentUser) render();
    } catch (e) {
        console.error("Supabase Init Error:", e);
        console.error("Error stack:", e.stack);
        // Always remove loading screen even if there's an error
        const l = $('loading-screen');
        if(l) {
            l.style.opacity=0;
            setTimeout(() => l.remove(), 500);
            $('app').classList.remove('opacity-0');
        }
        // Show error but still render the app
        showToast('Could not connect to database. Some features may be limited.', 'error');
        if(!currentUser) render();
    }
}

        if(!currentUser) render();
    } catch (e) {
        console.error("Supabase Init Error:", e);
        const l = $('loading-screen');
        if(l) {
            l.style.opacity=0;
            setTimeout(() => l.remove(), 500);
            $('app').classList.remove('opacity-0');
        }
        if(!currentUser) render();
    }
}

function ensureDataStructure() {
    // Ensure all arrays exist
    if(!db.activities) db.activities = [];
    if(!db.activitySubmissions) db.activitySubmissions = {};
    if(!db.exams) db.exams = [];
    if(!db.examSubmissions) db.examSubmissions = {};
    if(!db.modules) db.modules = [];
    if(!db.grades) db.grades = [];
    if(!db.globalEvents) db.globalEvents = [];
    if(!db.theme) db.theme = defaultData.theme;
}

// Optimized Non-Blocking Save with Debouncing
async function saveDB() {
    if(isSaving) {
        console.log("Save already in progress, waiting...");
        return false;
    }
    
    isSaving = true;
    
    // Immediate UI Feedback
    const status = $('sync-status');
    if(status) {
        status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
        status.style.opacity = '1';
    }

    // Debounce to prevent flooding
    if (saveTimeout) clearTimeout(saveTimeout);

    return new Promise((resolve) => {
        saveTimeout = setTimeout(async () => {
            try {
                // Ensure data structure is valid before saving
                ensureDataStructure();
                
                const { error } = await supabase
                    .from('app_data')
                    .upsert({ 
                        id: 'master_record', 
                        data: db,
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'id' 
                    });
                
                if (error) {
                    console.error("Save Error:", error);
                    if (error.code === '42P01' || error.code === '42501') {
                        showDatabaseErrorModal(error.code);
                    } else {
                        showToast('Sync failed: ' + error.message, 'error');
                    }
                    isSaving = false;
                    resolve(false);
                } else {
                    if(status) {
                        status.innerHTML = '<i class="fas fa-check"></i> Saved';
                        setTimeout(() => status.style.opacity = '0', 2000);
                    }
                    isSaving = false;
                    resolve(true);
                }
            } catch (e) {
                console.error("Save Error:", e);
                showToast('Connection failed', 'error');
                isSaving = false;
                resolve(false);
            }
        }, 1000); // 1 second delay for better batching
    });
}

// Helper to show SQL Fix
window.showDatabaseErrorModal = (code) => {
    const title = code === '42P01' ? 'Database Table Missing' : 'Permission Denied (RLS)';
    const msg = code === '42P01' 
        ? 'The "app_data" table does not exist in your Supabase project.' 
        : 'Row Level Security is blocking the save. You need to enable public access.';
    
    renderModal('db-error', title, `
        <div class="space-y-4">
            <div class="bg-red-50 text-red-700 p-4 rounded border border-red-200">
                <p class="font-bold"><i class="fas fa-exclamation-triangle"></i> Data Not Saving</p>
                <p class="text-sm mt-1">${msg}</p>
            </div>
            <p class="text-sm text-gray-600">Please go to the <strong>Supabase SQL Editor</strong> and run this code:</p>
            <div class="relative group">
                <textarea id="sql-code" class="w-full h-32 bg-gray-800 text-green-400 font-mono text-xs p-3 rounded" readonly>create table if not exists app_data (
  id text primary key,
  data jsonb,
  updated_at timestamptz
);
alter table app_data enable row level security;
create policy "Public Access" on app_data for all using (true) with check (true);
                </textarea>
                <button onclick="navigator.clipboard.writeText(document.getElementById('sql-code').value); showToast('SQL Copied!')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/40 text-white px-2 py-1 rounded text-xs">Copy</button>
            </div>
            <button onclick="saveDB(); closeModal('db-error')" class="btn-theme w-full text-white py-2 rounded font-bold">I ran the code, Try Saving Again</button>
        </div>
    `);
}

initSupabase();

// --- THEME ENGINE ---
function applyTheme() {
    const t = db.theme || defaultData.theme;
    document.title = t.appName;
    const root = document.documentElement;
    if (t.bgType === 'image' && t.bgImage) root.style.setProperty('--bg-style', `url('${t.bgImage}')`);
    else if (t.bgType === 'gradient') root.style.setProperty('--bg-style', t.bgGradient);
    else root.style.setProperty('--bg-style', t.bgColor);

    if (t.glassEffect) {
        root.style.setProperty('--glass-bg', `rgba(255, 255, 255, ${t.glassOpacity || 0.8})`);
        root.style.setProperty('--glass-border', '1px solid rgba(255, 255, 255, 0.4)');
        root.style.setProperty('--glass-shadow', '0 8px 32px 0 rgba(31, 38, 135, 0.15)');
        root.style.setProperty('--backdrop-blur', 'blur(16px)');
        root.style.setProperty('--sidebar-bg', `rgba(255, 255, 255, ${Math.max(0.5, (t.glassOpacity || 0.8) - 0.1)})`);
    } else {
        root.style.setProperty('--glass-bg', '#ffffff');
        root.style.setProperty('--glass-border', '1px solid #e2e8f0');
        root.style.setProperty('--glass-shadow', '0 1px 3px 0 rgb(0 0 0 / 0.1)');
        root.style.setProperty('--backdrop-blur', 'none');
        root.style.setProperty('--sidebar-bg', '#ffffff');
    }
    
    root.style.setProperty('--global-border-color', t.borderColor || '#e2e8f0');
    root.style.setProperty('--accent-color', t.accentColor || '#0374B5');
    root.style.setProperty('--nav-item-active-bg', `rgba(${hexToRgb(t.accentColor || '#0374B5')}, 0.1)`);
    
    if (t.headerType === 'gradient') {
        root.style.setProperty('--header-bg', t.headerGradient || 'linear-gradient(to right, #ffffff, #f3f4f6)');
    } else {
        root.style.setProperty('--header-bg', t.headerColor || '#ffffff');
    }
    root.style.setProperty('--header-text', t.headerTextColor || '#2D3B45');
    root.style.setProperty('--header-shadow', t.headerShadow || 'none');

    if (t.btnType === 'gradient') {
        root.style.setProperty('--btn-bg', t.btnGradient || 'linear-gradient(to right, #0374B5, #00C6FF)');
    } else {
        root.style.setProperty('--btn-bg', t.accentColor || '#0374B5');
    }
}

function hexToRgb(hex) {
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) { return r + r + g + g + b + b; });
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '3, 116, 181';
}

// --- HELPERS ---
const $ = (id) => document.getElementById(id);
window.$ = $;
const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const showToast = (msg, type='info') => {
    const b = document.createElement('div');
    b.className = `px-4 py-3 rounded shadow-lg text-white font-bold transform transition-all duration-300 translate-y-4 pointer-events-auto ${type==='error'?'bg-canvas-danger':'bg-canvas-accent'}`;
    b.innerText = msg; $('toast-container').appendChild(b); setTimeout(()=>b.remove(), 3000);
};
const showConfirm = (message, onYes) => {
    const id = 'confirm-modal';
    renderModal(id, 'Confirm', `<div class="space-y-4"><p>${message}</p><div class="flex justify-end gap-2"><button onclick="closeModal('${id}')" class="px-4 py-2 border rounded">Cancel</button><button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded">Confirm</button></div></div>`);
    setTimeout(() => $('confirm-yes').onclick = () => { onYes(); closeModal(id); }, 50);
};
const renderAvatar = (user, size='w-8 h-8', text='text-xs') => {
    if (user?.avatar?.startsWith('data:') || user?.avatar?.startsWith('http')) return `<img src="${user.avatar}" class="${size} rounded-full object-cover border bg-white">`;
    return `<div class="${size} rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ${text} font-bold border border-blue-200">${user?.name?.[0]||'?'}</div>`;
};

// --- ROUTER ---
function render() {
    const app = $('app'); if (!app) return; app.innerHTML = '';
    if(currentView === 'login') { renderLogin(app); } else {
        const logo = db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-20 w-auto max-w-[80px] object-contain">` : '<i class="fas fa-shapes text-5xl text-canvas-accent"></i>';
        app.innerHTML = `
            <div id="main-layout" class="flex w-full h-full">
                <nav id="global-nav">
                    <div class="mb-6 hidden md:block mt-4 transform hover:scale-110 transition-transform duration-300 px-2">${logo}</div>
                    <div class="nav-item ${currentView==='dashboard'?'active':''}" onclick="goDashboard()"><i class="fas fa-tachometer-alt nav-icon"></i><span class="nav-label">Dash</span></div>
                    ${currentUser.role === 'admin' ? `
                    <div class="nav-item ${currentView==='teachers_list'?'active':''}" onclick="goTeachersList()"><i class="fas fa-chalkboard-teacher nav-icon"></i><span class="nav-label">Teachers</span></div>
                    <div class="nav-item ${currentView==='theme_builder'?'active':''}" onclick="goThemeBuilder()"><i class="fas fa-palette nav-icon"></i><span class="nav-label">Design</span></div>
                    ` : ''}
                    <div class="nav-item ${currentView==='courses_list'||currentView==='course'||currentView==='module_builder'?'active':''}" onclick="goCoursesList()"><i class="fas fa-book nav-icon"></i><span class="nav-label">Courses</span></div>
                    <div class="nav-item ${currentView==='calendar'?'active':''}" onclick="goCalendar()"><i class="fas fa-calendar-alt nav-icon"></i><span class="nav-label">Calendar</span></div>
                    <div class="nav-item ${currentView==='settings'?'active':''}" onclick="goSettings()"><i class="fas fa-cog nav-icon"></i><span class="nav-label">Settings</span></div>
                    <div class="mt-auto mb-4 nav-item" onclick="logout()"><i class="fas fa-sign-out-alt nav-icon text-gray-400"></i><span class="nav-label text-gray-400">Logout</span></div>
                </nav>
                <main id="content-area" class="flex-1 overflow-y-auto relative p-6">
                    <header class="theme-panel h-20 flex items-center justify-between px-6 sticky top-0 z-40 rounded-xl mb-6 animate-slide-up">
                        <div class="flex items-center gap-4">
                            ${db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-16 w-auto object-contain">` : ''}
                            <h2 class="font-bold text-xl uppercase tracking-wide" id="page-title">${db.theme.appName}</h2>
                        </div>
                        <div class="flex items-center gap-3"><span class="text-sm font-bold opacity-90">${currentUser.name}</span>${renderAvatar(currentUser, 'w-9 h-9', 'text-sm')}</div>
                    </header>
                    <div id="page-content" class="max-w-7xl mx-auto animate-slide-up" style="animation-delay: 0.1s;"></div>
                </main>
            </div>
        `;
        const c = $('page-content');
        if(currentView === 'dashboard') renderDashboard(c);
        if(currentView === 'teachers_list') renderTeachersList(c);
        if(currentView === 'courses_list') renderCoursesList(c);
        if(currentView === 'calendar') renderCalendar(c);
        if(currentView === 'course') renderCourse(c);
        if(currentView === 'module_builder') renderModuleBuilder(c);
        if(currentView === 'activity_builder') renderActivityBuilder(c);
        if(currentView === 'exam-take') renderExamTake(c);
        if(currentView === 'exam-review') renderExamReview(c);
        if(currentView === 'settings') renderSettings(c);
        if(currentView === 'theme_builder') renderThemeBuilder(c);
    }
}

// Global Nav
window.goDashboard = () => { currentView='dashboard'; render(); }
window.goCoursesList = () => { currentView='courses_list'; render(); }
window.goCalendar = () => { currentView='calendar'; render(); }
window.goSettings = () => { currentView='settings'; render(); }
window.goTeachersList = () => { currentView='teachers_list'; render(); }
window.goThemeBuilder = () => { currentView='theme_builder'; render(); }
window.logout = () => { currentUser=null; currentView='login'; render(); }
window.goCourse = (sid) => { currentCourseId = sid; currentView = 'course'; render(); }

// --- LOGIN ---
function renderLogin(c) {
    const logo = db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-64 mx-auto mb-6 object-contain drop-shadow-md">` : '<i class="fas fa-shapes text-9xl text-canvas-accent mb-6 inline-block drop-shadow-md"></i>';
    c.innerHTML = `
        <div class="flex h-screen w-full bg-[#2D3B45] items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
            <div class="theme-panel bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center relative z-10 animate-slide-up">
                ${logo}
                <h1 class="text-4xl font-black text-gray-800 mb-2 tracking-tight">${db.theme.appName}</h1>
                <p class="text-gray-500 mb-8 font-medium" id="login-subtext">Select your portal to continue</p>
                <div id="role-selector" class="space-y-4">
                    <button onclick="showLoginForm('teacher')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-chalkboard-teacher"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Teacher</span><span class="text-xs text-gray-500">Manage courses & grades</span></div></button>
                    <button onclick="showLoginForm('student')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-green-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-green-100 text-green-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-user-graduate"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Student</span><span class="text-xs text-gray-500">Access your learning</span></div></button>
                    <button onclick="showLoginForm('admin')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-purple-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-user-shield"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Admin</span><span class="text-xs text-gray-500">System configuration</span></div></button>
                </div>
                <div id="login-form-box" class="hidden text-left space-y-5 animate-fade-in">
                    <div class="flex items-center mb-6"><button onclick="hideLoginForm()" class="text-gray-400 hover:text-black mr-4 p-2 rounded-full hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button><h2 class="text-2xl font-bold text-gray-800" id="form-role-title">Login</h2></div>
                    <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1 ml-1">Username</label><input id="login-user" type="text" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-50 focus:bg-white"></div>
                    <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1 ml-1">Password</label><input id="login-pass" type="password" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-50 focus:bg-white"></div>
                    <button onclick="loginAttempt()" class="btn-theme w-full font-bold py-3.5 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition-all mt-4">Sign In</button>
                </div>
            </div>
        </div>
    `;
}
window.showLoginForm = (r) => { selectedLoginRole=r; $('role-selector').classList.add('hidden'); $('login-subtext').classList.add('hidden'); $('login-form-box').classList.remove('hidden'); $('form-role-title').innerText = {'teacher':'Teacher Portal','student':'Student Portal','admin':'Administrator'}[r]; setTimeout(() => $('login-user').focus(), 100); }
window.hideLoginForm = () => { selectedLoginRole=null; $('role-selector').classList.remove('hidden'); $('login-subtext').classList.remove('hidden'); $('login-form-box').classList.add('hidden'); $('login-user').value = ''; $('login-pass').value = ''; }
window.loginAttempt = async () => { 
    const u=$('login-user').value.trim(), p=$('login-pass').value.trim(); 
    const user = db.users.find(x => x.username === u && x.password === p); 
    if(user) { 
        if (selectedLoginRole && user.role !== selectedLoginRole) return showToast(`Not a ${selectedLoginRole}`, 'error'); 
        currentUser = user;
        await saveDB();
        goDashboard(); 
    } else showToast('Invalid credentials', 'error'); 
}

// --- DASHBOARD ---
function renderDashboard(c) {
    $('page-title').innerText = 'Dashboard';
    c.innerHTML = `<div class="max-w-4xl mx-auto"><div class="mb-6 flex items-center gap-3 p-4 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl text-white shadow-lg"><div class="bg-white/20 p-3 rounded-lg"><i class="fas fa-newspaper text-2xl"></i></div><div><h2 class="text-2xl font-bold">School News</h2><p class="text-blue-100 text-sm">Latest updates from the administration.</p></div></div><div class="space-y-6">${(db.globalPosts && db.globalPosts.length > 0) ? db.globalPosts.map(p => renderPostCard(p, false)).join('') : '<div class="theme-panel bg-white p-12 rounded-xl border border-dashed text-center text-gray-400"><i class="fas fa-inbox text-5xl mb-4 text-gray-200 block"></i>No announcements yet.</div>'}</div></div>`;
}

// --- COURSES ---
function renderCoursesList(c) {
    $('page-title').innerText = 'Courses';
    let subs = [];
    let filterHtml = '';
    if (currentUser.role === 'admin') {
        const teachers = db.users.filter(u => u.role === 'teacher');
        filterHtml = `<select onchange="setAdminFilter(this.value)" class="border p-2 rounded bg-white text-sm"><option value="all">All Teachers</option>${teachers.map(t => `<option value="${t.id}" ${adminCourseFilter===t.id?'selected':''}>${t.name}</option>`).join('')}</select>`;
        subs = adminCourseFilter === 'all' ? db.subjects : db.subjects.filter(s => s.teacherId === adminCourseFilter);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><div class="flex gap-2">${filterHtml}${currentUser.role==='teacher' ? `<button onclick="openAddCourseModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Course</button>` : ''}</div></div>`;
    } else if (currentUser.role === 'teacher') {
        subs = db.subjects.filter(s => s.teacherId === currentUser.id);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><button onclick="openAddCourseModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Course</button></div>`;
    } else {
        subs = db.subjects.filter(s => s.students.includes(currentUser.id));
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3></div>`;
    }
    
    if(subs.length === 0) { c.innerHTML += `<div class="theme-panel bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-book-open text-4xl mb-3 block"></i><p>No courses found.</p></div>`; } else {
        c.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${subs.map(s => {
            const t = db.users.find(u => u.id === s.teacherId);
            const isOwner = (currentUser.role === 'admin') || (currentUser.role === 'teacher' && s.teacherId === currentUser.id);
            
            const bgStyle = s.img ? `background-image: url('${s.img}');` : `background-color: ${s.color};`;
            
            return `
            <div onclick="openCourse('${s.id}')" class="theme-panel course-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer h-64 flex flex-col group hover-lift">
                <div class="course-header relative bg-gray-200" style="${bgStyle} background-size: cover; background-position: center;">
                    ${isOwner ? `
                        <button onclick="event.stopPropagation(); triggerBannerUpload('${s.id}')" class="absolute top-2 right-2 bg-black/40 hover:bg-black/70 text-white w-8 h-8 rounded-full backdrop-blur-sm flex items-center justify-center transition opacity-0 group-hover:opacity-100 z-20 shadow-md hover:scale-110" title="Change Banner Image">
                            <i class="fas fa-camera text-xs"></i>
                        </button>
                    ` : ''}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent p-4 flex flex-col justify-end transition group-hover:from-black/90">
                        <span class="bg-white/20 backdrop-blur-md text-white border border-white/30 text-xs font-bold px-2 py-1 rounded w-max shadow-md mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.8);">${s.code}</span>
                        <h3 class="font-bold text-white text-lg leading-tight drop-shadow-md" style="text-shadow: 0 2px 4px rgba(0,0,0,0.9); letter-spacing: 0.5px;">${s.name}</h3>
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Instructor</p>
                        <div class="flex items-center gap-2">${renderAvatar(t, 'w-6 h-6', 'text-[10px]')} <span class="text-sm font-medium text-gray-700">${t ? t.name : 'Unknown'}</span></div>
                    </div>
                    <div class="flex items-center justify-between text-gray-400 text-xs border-t pt-3">
                        <span class="bg-gray-100 px-2 py-1 rounded text-gray-600"><i class="fas fa-users mr-1"></i> ${s.students.length} Students</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform text-gray-300 group-hover:text-theme"></i>
                    </div>
                </div>
            </div>`;
        }).join('')}</div>`;
    }
}

window.setAdminFilter = (val) => { adminCourseFilter = val; render(); }
window.openAddCourseModal = () => { renderModal('modal-add-course', 'Add Course', `<div class="space-y-3"><input id="c-name" class="w-full border p-2 rounded" placeholder="Course Name"><input id="c-code" class="w-full border p-2 rounded" placeholder="Course Code"><div><label class="text-xs font-bold text-gray-500">Select Teacher</label><select id="c-teacher" class="w-full border p-2 rounded bg-white text-sm">${db.users.filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select></div><button onclick="addCourse()" class="w-full btn-theme py-2 rounded">Create</button></div>`); }
window.addCourse = () => { const n=$('c-name').value, c=$('c-code').value; let tid=currentUser.id; if(currentUser.role==='admin') tid=$('c-teacher').value; if(n&&c){ db.subjects.push({id:'s'+Date.now(), name:n, code:c, teacherId:tid, students:[], color:'#0374B5', img:'', introTitle:'Welcome', introBody:'', gradingWeights:{ww:40,pt:40,qa:20}}); saveDB(); render(); closeModal('modal-add-course'); } }
window.openCourse = (sid) => { currentCourseId = sid; currentView = 'course'; currentTab = 'home'; render(); }

// --- BANNER UPLOAD LOGIC ---
let uploadingCourseId = null;

window.triggerBannerUpload = (sid) => {
    uploadingCourseId = sid;
    let input = $('course-banner-input');
    if (!input) {
        input = document.createElement('input');
        input.type = 'file';
        input.id = 'course-banner-input';
        input.accept = 'image/png, image/jpeg, image/gif, image/webp';
        input.style.display = 'none';
        document.body.appendChild(input);
        input.addEventListener('change', handleBannerSelect);
    }
    input.click();
}

window.handleBannerSelect = (e) => {
    const file = e.target.files[0];
    if (file && uploadingCourseId) {
        if (file.size > 2 * 1024 * 1024) {
            showToast('Image too large (max 2MB)', 'error');
            e.target.value = '';
            uploadingCourseId = null;
            return;
        }
        
        showToast('Processing banner...', 'info');
        const reader = new FileReader();
        reader.onload = function(evt) {
            saveBannerToDB(evt.target.result);
        };
        reader.readAsDataURL(file);
    }
}

window.saveBannerToDB = async (base64) => {
    const courseIndex = db.subjects.findIndex(s => s.id === uploadingCourseId);
    if (courseIndex !== -1) {
        db.subjects[courseIndex].img = base64;
        showToast('Saving to cloud...', 'info');
        const success = await saveDB();
        if (success) {
            render();
            showToast('Course banner updated!');
        } else {
            showToast('Save failed.', 'error');
        }
    }
    uploadingCourseId = null;
    const input = $('course-banner-input');
    if(input) input.value = '';
}

// --- CALENDAR ---
function renderCalendar(c) {
    $('page-title').innerText = 'Calendar';
    const year=calendarDate.getFullYear(), month=calendarDate.getMonth();
    const firstDay=new Date(year,month,1).getDay(), days=new Date(year,month+1,0).getDate();
    let html = `<div class="theme-panel bg-white p-4 rounded shadow mb-4 flex justify-between"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><h2 class="font-bold text-xl">${calendarDate.toLocaleString('default',{month:'long'})} ${year}</h2><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div>`;
    html += `<div class="calendar-grid">${['S','M','T','W','T','F','S'].map(d=>`<div class="bg-gray-50 p-2 text-center text-xs font-bold">${d}</div>`).join('')}`;
    for(let i=0; i<firstDay; i++) html+=`<div class="cal-cell bg-gray-50/50"></div>`;
    for(let d=1; d<=days; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const monthDay = `${month+1}-${d}`;
        let evts = '';
        
        const hol = phHolidays.find(h => (h.m === month && h.d === d));
        if(hol) evts += `<div class="event-pill text-white font-bold" style="background:${hol.c || 'red'}">ðŸ‡µðŸ‡­ ${hol.t}</div>`;

        (db.globalEvents || []).forEach(e => {
            if(e.date === dateStr) evts += `<div class="event-pill bg-purple-600 text-white font-bold">${e.title}</div>`;
        });

        db.subjects.forEach(s => {
            if(currentUser.role==='student' && !s.students.includes(currentUser.id)) return;
            if(currentUser.role==='teacher' && s.teacherId!==currentUser.id) return;
            (db.exams||[]).filter(e => e.courseId === s.id).forEach(e => { 
                if(e.dueDate && e.dueDate.startsWith(dateStr)) 
                    evts += `<div onclick="goCourse('${s.id}'); switchTab('quizzes')" class="event-pill cursor-pointer hover:opacity-80" style="background:${s.color};color:white">Due: ${e.title}</div>`; 
            });
            (db.activities||[]).filter(a => a.courseId === s.id).forEach(a => { 
                if(a.dueDate && a.dueDate.startsWith(dateStr)) 
                    evts += `<div onclick="goCourse('${s.id}'); switchTab('activities')" class="event-pill border border-gray-400 text-gray-600 bg-white cursor-pointer hover:bg-gray-50">Task: ${a.title}</div>`; 
            });
        });
        html += `<div class="cal-cell">${d}<div class="flex flex-col gap-1 mt-1">${evts}</div></div>`;
    }
    html += `</div>`; c.innerHTML = html;
}
window.changeMonth = (d) => { calendarDate.setMonth(calendarDate.getMonth()+d); render(); }

// --- COURSE VIEW ---
function renderCourse(c) {
    const s = db.subjects.find(x => x.id === currentCourseId);
    if (!s) return;
    const isTeacher = currentUser.role === 'teacher' && s.teacherId === currentUser.id;
    const isAdmin = currentUser.role === 'admin';
    
    c.innerHTML = `<div class="flex flex-col md:flex-row gap-6 h-full"><nav class="theme-panel w-full md:w-48 flex-shrink-0 flex md:flex-col gap-1 text-sm font-medium text-canvas-primary border-r border-gray-200 pb-4 md:pr-4"><a onclick="switchTab('home')" class="${currentTab==='home'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Home</a><a onclick="switchTab('modules')" class="${currentTab==='modules'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Modules</a><a onclick="switchTab('activities')" class="${currentTab==='activities'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Activities</a><a onclick="switchTab('quizzes')" class="${currentTab==='quizzes'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Quizzes/Exams</a><a onclick="switchTab('grades')" class="${currentTab==='grades'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Grades</a><a onclick="switchTab('people')" class="${currentTab==='people'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">People</a></nav><div id="course-content" class="flex-1"></div></div>`;
    
    const cc = $('course-content');
    if(currentTab === 'home') renderCourseHome(cc, s, isTeacher);
    if(currentTab === 'modules') renderCourseModules(cc, s, isTeacher);
    if(currentTab === 'activities') renderCourseActivities(cc, s, isTeacher);
    if(currentTab === 'quizzes') renderCourseQuizzes(cc, s, isTeacher);
    if(currentTab === 'grades') renderCourseGrades(cc, s, isTeacher, isAdmin);
    if(currentTab === 'people') renderCoursePeople(cc, s, isTeacher);
}

window.switchTab = (t) => { currentTab = t; render(); }

function renderCourseHome(c, s, isTeacher) {
    c.innerHTML = `
        <div class="space-y-6">
            <div class="theme-panel bg-white p-6 rounded border border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">${s.introTitle || 'Welcome'}</h2>
                        <p class="text-gray-600 mt-2 whitespace-pre-line">${s.introBody || 'No announcement yet.'}</p>
                    </div>
                    ${isTeacher ? `<button onclick="editIntro()" class="text-gray-400 hover:text-blue-600"><i class="fas fa-edit"></i> Edit</button>` : ''}
                </div>
            </div>
            <div class="space-y-4">
                ${(db.posts||[]).filter(p => p.courseId === currentCourseId).map(p => renderPostCard(p, false)).join('')}
                ${isTeacher ? `
                    <div class="theme-panel bg-white p-4 rounded border border-dashed">
                        <textarea id="post-content" class="w-full border p-2 rounded text-sm" rows="3" placeholder="Write a post..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button onclick="publishPost()" class="btn-theme px-4 py-2 rounded font-bold text-sm">Post</button>
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderCourseModules(c, s, isTeacher) {
    const modules = (db.modules||[]).filter(m => m.courseId === currentCourseId);
    c.innerHTML = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Modules</h2>
                ${isTeacher ? `<button onclick="openModuleBuilder()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>New Module</button>` : ''}
            </div>
            ${modules.length === 0 ? '<div class="theme-panel p-8 text-center text-gray-400 italic">No modules yet.</div>' : 
                modules.map(m => `
                    <div class="theme-panel bg-white p-4 rounded border border-gray-200 hover-lift">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800">${m.title}</h3>
                                <p class="text-xs text-gray-500 mt-1">${m.blocks.length} content blocks</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewModule('${m.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-eye"></i></button>
                                ${isTeacher ? `
                                    <button onclick="editModule('${m.id}')" class="text-gray-600 hover:bg-gray-50 p-2 rounded"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteModule('${m.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;
}

function renderCourseActivities(c, s, isTeacher) {
    const activities = (db.activities||[]).filter(a => a.courseId === currentCourseId);
    c.innerHTML = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Activities</h2>
                ${isTeacher ? `<button onclick="openActivityBuilder()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}
            </div>
            ${activities.length === 0 ? '<div class="theme-panel p-8 text-center text-gray-400 italic">No activities yet.</div>' : 
                activities.map(a => `
                    <div class="theme-panel bg-white p-4 rounded border border-gray-200 hover-lift cursor-pointer" onclick="openActivityDetail('${a.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-xs font-bold ${a.category==='ww'?'text-orange-600':a.category==='pt'?'text-purple-600':'text-gray-600'}">${a.category.toUpperCase()}</span>
                                <h3 class="font-bold text-gray-800 mt-1">${a.title}</h3>
                                <p class="text-xs text-gray-500 mt-1">Max: ${a.maxScore} pts | Due: ${a.dueDate ? formatDate(a.dueDate) : 'No deadline'}</p>
                            </div>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;
}

function renderCourseQuizzes(c, s, isTeacher) {
    const exams = (db.exams||[]).filter(e => e.courseId === currentCourseId);
    c.innerHTML = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Quizzes & Exams</h2>
                ${isTeacher ? `<button onclick="openCreateModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>New Quiz</button>` : ''}
            </div>
            ${exams.length === 0 ? '<div class="theme-panel p-8 text-center text-gray-400 italic">No quizzes yet.</div>' : 
                exams.map(e => `
                    <div class="theme-panel bg-white p-4 rounded border border-gray-200 hover-lift cursor-pointer" onclick="openExamDetail('${e.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-xs font-bold ${e.category==='ww'?'text-orange-600':e.category==='pt'?'text-purple-600':e.category==='qa'?'text-blue-600':'text-gray-600'}">${e.category.toUpperCase()}</span>
                                <h3 class="font-bold text-gray-800 mt-1">${e.title}</h3>
                                <p class="text-xs text-gray-500 mt-1">${e.questions.length} questions | Due: ${e.dueDate ? formatDate(e.dueDate) : 'No deadline'}</p>
                            </div>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;
}

// --- DEPED-BASED GRADING SYSTEM ---
function renderCourseGrades(c, s, isTeacher, isAdmin) {
    const enrolled = db.users.filter(u => s.students.includes(u.id));
    const weights = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
    
    // Fetch all items for this course
    const activities = (db.activities||[]).filter(a => a.courseId === currentCourseId);
    const exams = (db.exams||[]).filter(e => e.courseId === currentCourseId);
    
    // Fetch manual grades for this course
    const manualGrades = (db.grades||[]).filter(g => g.courseId === currentCourseId);
    
    // Categorize & Sort by date
    const wwItems = [
        ...activities.filter(a => a.category === 'ww'),
        ...exams.filter(q => q.category === 'ww'),
        ...manualGrades.filter(g => g.category === 'ww')
    ].sort((a,b) => new Date(a.date || a.createdAt || 0) - new Date(b.date || b.createdAt || 0));
    
    const ptItems = [
        ...activities.filter(a => a.category === 'pt'),
        ...exams.filter(q => q.category === 'pt'),
        ...manualGrades.filter(g => g.category === 'pt')
    ].sort((a,b) => new Date(a.date || a.createdAt || 0) - new Date(b.date || b.createdAt || 0));
    
    const qaItems = [
        ...exams.filter(q => q.category === 'qa'),
        ...manualGrades.filter(g => g.category === 'qa')
    ].sort((a,b) => new Date(a.date || a.createdAt || 0) - new Date(b.date || b.createdAt || 0));

    // Build HTML
    let html = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">Class Record (DepEd Format)</h2>`;
    
    if (isTeacher || isAdmin) {
        html += `<div class="flex gap-2">
            <button onclick="openWeightsModal()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs font-bold border hover:bg-gray-200"><i class="fas fa-sliders-h mr-1"></i>Weights</button>
            <button onclick="openAddManualGradeModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700"><i class="fas fa-plus mr-1"></i>Add Grade Column</button>
        </div>`;
    }
    html += `</div>`;
    
    // Summary Cards
    html += `<div class="grid grid-cols-3 gap-4 mb-4 text-center">
        <div class="bg-orange-50 p-3 rounded border border-orange-100">
            <div class="text-lg font-bold text-orange-800">${weights.ww}%</div>
            <div class="text-xs text-orange-600 font-bold">WRITTEN WORK</div>
        </div>
        <div class="bg-purple-50 p-3 rounded border border-purple-100">
            <div class="text-lg font-bold text-purple-800">${weights.pt}%</div>
            <div class="text-xs text-purple-600 font-bold">PERFORMANCE TASK</div>
        </div>
        <div class="bg-blue-50 p-3 rounded border border-blue-100">
            <div class="text-lg font-bold text-blue-800">${weights.qa}%</div>
            <div class="text-xs text-blue-600 font-bold">QUARTERLY ASSESSMENT</div>
        </div>
    </div>`;
    
    html += `<div class="theme-panel overflow-x-auto bg-white border rounded shadow-sm max-w-full"><table class="w-full text-left text-sm grade-table border-collapse">`;
    // Header Row
    html += `<thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b"><tr>`;
    html += `<th class="p-3 sticky left-0 bg-gray-50 border-r min-w-[180px] z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Student Name</th>`;
    
    // Helper to generate headers
    const addHeaders = (items, prefix, colorCls) => {
        if(items.length > 0) {
            items.forEach((i, idx) => {
                const isManual = !!i.isManual;
                html += `<th class="p-2 text-center border-r min-w-[70px] ${colorCls} align-top" title="${i.title}">
                    <div class="font-bold text-xs">${prefix}${idx+1}</div>
                    ${isTeacher || isAdmin ? `<div class="text-[10px] text-gray-400">${isManual?'Manual':'Auto'}</div>` : ''}
                </th>`;
            });
            html += `<th class="p-2 text-center border-r ${colorCls.replace('/30','/50')} font-black align-middle">${prefix} Avg</th>`;
        } else { 
            html += `<th class="p-2 text-center border-r text-gray-300 font-normal">${prefix}</th>`; 
        }
    };

    addHeaders(wwItems, 'WW', 'bg-orange-50/30 text-orange-800');
    addHeaders(ptItems, 'PT', 'bg-purple-50/30 text-purple-800');
    addHeaders(qaItems, 'QA', 'bg-blue-50/30 text-blue-800');

    html += `<th class="p-3 text-center bg-gray-100 text-gray-800 min-w-[80px] align-middle border-l-2 border-gray-200">Final</th>`;
    html += `<th class="p-3 text-center bg-gray-100 text-gray-800 min-w-[80px] align-middle">Remarks</th>`;
    html += `</tr></thead><tbody class="divide-y">`;

    // Body Rows
    enrolled.forEach(stu => {
        html += `<tr class="hover:bg-gray-50 group">`;
        html += `<td class="p-3 font-bold text-gray-700 sticky left-0 bg-white border-r flex items-center gap-2 group-hover:bg-gray-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">${renderAvatar(stu, 'w-6 h-6', 'text-[10px]')} <span class="truncate">${stu.name}</span></td>`;

        const getScore = (item) => {
            if(item.isManual) {
                // Manual grade entry
                const gradeItem = db.grades.find(g => g.id === item.id && g.studentId === stu.id);
                if(gradeItem && gradeItem.score !== undefined) {
                    return { val: gradeItem.score, raw: gradeItem.score, max: gradeItem.maxScore || 100 };
                }
                return { val: '-', raw: 0, max: item.maxScore || 100 };
            } else if(item.questions) { 
                // Exam: stored as percentage (0-100)
                const sub = db.examSubmissions[item.id]?.[stu.id];
                if(sub && sub.score !== undefined) {
                    return { val: sub.score, raw: sub.score, max: 100 };
                }
                return { val: '-', raw: 0, max: 100 };
            } else { 
                // Activity: stored as raw points
                const sub = db.activitySubmissions[item.id]?.[stu.id];
                if(typeof sub === 'number') return { val: sub, raw: sub, max: parseInt(item.maxScore) };
                else if(sub && sub.score !== undefined) return { val: sub.score, raw: sub.score, max: parseInt(item.maxScore) };
                return { val: '-', raw: 0, max: parseInt(item.maxScore) };
            }
        };

        const addCells = (items, colorBg) => {
            let totalScore = 0, totalMax = 0;
            if(items.length > 0) {
                items.forEach(i => {
                    const s = getScore(i);
                    const numericScore = s.val === '-' ? 0 : s.val;
                    totalScore += numericScore;
                    totalMax += s.max;
                    
                    // Editable cell for teachers/admin
                    if (isTeacher || isAdmin) {
                        html += `<td class="p-1 text-center border-r text-gray-600">
                            <input type="number" 
                                class="grade-input text-xs" 
                                value="${s.val === '-' ? '' : s.val}" 
                                max="${s.max}" 
                                min="0"
                                data-item-id="${i.id}" 
                                data-student-id="${stu.id}"
                                data-max="${s.max}"
                                data-is-manual="${i.isManual ? 'true' : 'false'}"
                                onchange="updateGrade('${i.id}', '${stu.id}', this.value, ${i.isManual})"
                                placeholder="-">
                        </td>`;
                    } else {
                        html += `<td class="p-2 text-center text-xs border-r text-gray-600">${s.val}</td>`;
                    }
                });
                const perc = totalMax === 0 ? 0 : (totalScore / totalMax) * 100;
                html += `<td class="p-2 text-center font-bold ${colorBg} border-r">${Math.round(perc)}%</td>`;
                return perc;
            } else { 
                html += `<td class="p-2 text-center border-r text-gray-200">-</td>`; 
                return 0;
            }
        };

        const wPerc = addCells(wwItems, 'text-orange-700 bg-orange-50/20');
        const pPerc = addCells(ptItems, 'text-purple-700 bg-purple-50/20');
        const qPerc = addCells(qaItems, 'text-blue-700 bg-blue-50/20');
        
        const final = (wPerc * (weights.ww/100)) + (pPerc * (weights.pt/100)) + (qPerc * (weights.qa/100));
        const finalGrade = Math.round(final);
        const remarks = finalGrade >= 75 ? 'Passed' : 'Failed';
        const remarksClass = finalGrade >= 75 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
        
        html += `<td class="p-2 text-center font-black text-gray-800 bg-gray-100 border-l-2 border-gray-200 text-base">${finalGrade}</td>`;
        html += `<td class="p-2 text-center font-bold ${remarksClass}">${remarks}</td>`;
        html += `</tr>`;
    });

    html += `</tbody></table></div>`;
    c.innerHTML = html;
}

// Update grade (for both automatic and manual grades)
window.updateGrade = async (itemId, studentId, value, isManual) => {
    const score = value === '' ? null : parseFloat(value);
    
    if (isManual) {
        // Update manual grade in grades array
        let gradeItem = db.grades.find(g => g.id === itemId && g.studentId === studentId);
        if (gradeItem) {
            gradeItem.score = score;
        }
    } else {
        // Check if it's an exam or activity
        const exam = db.exams.find(e => e.id === itemId);
        if (exam) {
            if (!db.examSubmissions[itemId]) db.examSubmissions[itemId] = {};
            if (!db.examSubmissions[itemId][studentId]) db.examSubmissions[itemId][studentId] = {};
            db.examSubmissions[itemId][studentId].score = score;
        } else {
            const activity = db.activities.find(a => a.id === itemId);
            if (activity) {
                if (!db.activitySubmissions[itemId]) db.activitySubmissions[itemId] = {};
                db.activitySubmissions[itemId][studentId] = score;
            }
        }
    }
    
    // Save to Supabase
    const success = await saveDB();
    if (success) {
        showToast('Grade updated');
        render(); // Refresh to show updated averages
    } else {
        showToast('Failed to save grade', 'error');
    }
}

// Open modal to add manual grade column
window.openAddManualGradeModal = () => {
    renderModal('add-manual-grade', 'Add Manual Grade Column', `
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Column Name</label>
                <input id="manual-grade-title" type="text" class="w-full border p-2 rounded" placeholder="e.g., Oral Recitation, Project 1">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Category</label>
                <select id="manual-grade-category" class="w-full border p-2 rounded">
                    <option value="ww">Written Work (WW)</option>
                    <option value="pt">Performance Task (PT)</option>
                    <option value="qa">Quarterly Assessment (QA)</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Maximum Score</label>
                <input id="manual-grade-max" type="number" class="w-full border p-2 rounded" value="100" min="1">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Date</label>
                <input id="manual-grade-date" type="date" class="w-full border p-2 rounded">
            </div>
            <button onclick="addManualGradeColumn()" class="w-full btn-theme py-2 rounded font-bold">Add Column</button>
        </div>
    `);
    // Set today's date as default
    $('manual-grade-date').value = new Date().toISOString().split('T')[0];
}

window.addManualGradeColumn = async () => {
    const title = $('manual-grade-title').value;
    const category = $('manual-grade-category').value;
    const maxScore = parseInt($('manual-grade-max').value);
    const date = $('manual-grade-date').value;
    
    if (!title || !maxScore) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    const columnId = 'manual_' + Date.now();
    
    // Add column info to grades array
    if (!db.grades) db.grades = [];
    
    // Create entries for all enrolled students
    const s = db.subjects.find(x => x.id === currentCourseId);
    s.students.forEach(studentId => {
        db.grades.push({
            id: columnId,
            courseId: currentCourseId,
            studentId: studentId,
            title: title,
            category: category,
            maxScore: maxScore,
            score: null, // Initialize as null (no grade yet)
            date: date,
            isManual: true,
            createdAt: new Date().toISOString()
        });
    });
    
    const success = await saveDB();
    if (success) {
        showToast('Grade column added');
        closeModal('add-manual-grade');
        render();
    } else {
        showToast('Failed to add grade column', 'error');
    }
}

// Delete grade column (for manual grades only)
window.deleteGradeItem = (itemId) => {
    showConfirm('Delete this grade column? All grades will be removed.', async () => {
        db.grades = db.grades.filter(g => g.id !== itemId);
        const success = await saveDB();
        if (success) {
            showToast('Grade column deleted');
            render();
        } else {
            showToast('Failed to delete grade column', 'error');
        }
    });
}

// Open weights modal
window.openWeightsModal = () => {
    const s = db.subjects.find(x => x.id === currentCourseId);
    const weights = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
    
    renderModal('grading-weights', 'Grading Weights (DepEd)', `
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Written Work (WW) - %</label>
                <input id="weight-ww" type="number" class="w-full border p-2 rounded" value="${weights.ww}" min="0" max="100">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Performance Task (PT) - %</label>
                <input id="weight-pt" type="number" class="w-full border p-2 rounded" value="${weights.pt}" min="0" max="100">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Quarterly Assessment (QA) - %</label>
                <input id="weight-qa" type="number" class="w-full border p-2 rounded" value="${weights.qa}" min="0" max="100">
            </div>
            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                <p class="text-xs text-blue-800 font-bold">Total: <span id="weight-total">${weights.ww + weights.pt + weights.qa}</span>%</p>
                <p class="text-xs text-blue-600 mt-1">Must equal 100%</p>
            </div>
            <button onclick="saveGradingWeights()" class="w-full btn-theme py-2 rounded font-bold">Save Weights</button>
        </div>
    `);
}

window.saveGradingWeights = async () => {
    const ww = parseInt($('weight-ww').value) || 0;
    const pt = parseInt($('weight-pt').value) || 0;
    const qa = parseInt($('weight-qa').value) || 0;
    
    if (ww + pt + qa !== 100) {
        showToast('Weights must equal 100%', 'error');
        return;
    }
    
    const s = db.subjects.find(x => x.id === currentCourseId);
    s.gradingWeights = { ww, pt, qa };
    
    const success = await saveDB();
    if (success) {
        showToast('Grading weights updated');
        closeModal('grading-weights');
        render();
    } else {
        showToast('Failed to save weights', 'error');
    }
}

function renderCoursePeople(c, s, isTeacher) {
    const ppl = db.users.filter(u=>s.students.includes(u.id));
    c.innerHTML = `<h2 class="text-xl font-bold mb-4">People</h2>${isTeacher ? `<div class="flex gap-2"><button onclick="openAddStudentModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>Enroll Student</button></div>` : ''}</div><div class="theme-panel bg-white border rounded overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b text-xs uppercase font-bold text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">Role</th>${isTeacher?`<th class="p-4">User</th><th class="p-4">Pass</th><th class="p-4 text-right"></th>`:''}</tr></thead><tbody class="divide-y"><tr><td class="p-4 flex items-center gap-2 font-bold">${renderAvatar(db.users.find(u=>u.id===s.teacherId),'w-6 h-6')} ${db.users.find(u=>u.id===s.teacherId)?.name}</td><td class="p-4">Teacher</td>${isTeacher?`<td class="p-4 text-gray-400">-</td><td class="p-4 text-gray-400">-</td><td></td>`:''}</tr>${ppl.map(u=>`<tr><td class="p-4 flex items-center gap-2">${renderAvatar(u,'w-6 h-6')} ${u.name}</td><td class="p-4">Student</td>${isTeacher?`<td class="p-4 font-mono text-blue-600">${u.username}</td><td class="p-4 font-mono text-red-500">${u.password}</td><td class="p-4 text-right"><button onclick="removeStudentFromCourse('${s.id}','${u.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-user-minus"></i></button></td>`:''}</tr>`).join('')}</tbody></table></div>`;
}

// Course Logic
window.deletePost = (pid) => { showConfirm('Delete post?', ()=>{db.posts=db.posts.filter(p=>p.id!==pid); saveDB(); render();}); }
window.editIntro = () => { const s=db.subjects.find(x=>x.id===currentCourseId); const t=prompt('Title:',s.introTitle); if(t!==null){ const b=prompt('Body:',s.introBody); if(b!==null){ s.introTitle=t; s.introBody=b; saveDB(); render(); }}}
window.publishPost = () => { const c=$('post-content').value; if(c) { if(!db.posts) db.posts=[]; db.posts.push({id:'p'+Date.now(), courseId:currentCourseId, authorId:currentUser.id, authorName:currentUser.name, date:new Date().toISOString(), content:c, mediaType:'text', isPinned:false}); saveDB(); render(); } }

// --- GRADE HELPERS ---
window.openAddStudentModal = () => { renderModal('modal-add-student', 'Enroll Student', `<div class="space-y-3"><input id="s-name" class="w-full border p-2 rounded" placeholder="Student Name"><input id="s-user" class="w-full border p-2 rounded" placeholder="Username"><input id="s-pass" class="w-full border p-2 rounded" placeholder="Password"><button onclick="addStudent()" class="w-full btn-theme py-2 rounded">Enroll</button></div>`); }
window.addStudent = () => { const n=$('s-name').value, u=$('s-user').value, p=$('s-pass').value; if(n&&u&&p){ db.users.push({id:'u'+Date.now(), name:n, role:'student', username:u, password:p, avatar:n[0]}); const s=db.subjects.find(x=>x.id===currentCourseId); s.students.push(db.users[db.users.length-1].id); saveDB(); render(); closeModal('modal-add-student'); } }
window.removeStudentFromCourse = (sid,uid) => { showConfirm('Remove student?', ()=>{ const s=db.subjects.find(x=>x.id===sid); s.students=s.students.filter(i=>i!==uid); saveDB(); render(); }); }

// --- MODAL SYSTEM ---
window.renderModal = (id, title, content) => {
    const portal = $('modal-portal');
    portal.innerHTML = `
        <div id="${id}" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-fade-in">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="font-bold text-xl text-gray-800">${title}</h3>
                    <button onclick="closeModal('${id}')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6">${content}</div>
            </div>
        </div>
    `;
}
window.closeModal = (id) => { const el = $(id); if(el) el.remove(); }

// --- SETTINGS ---
function renderSettings(c) {
    $('page-title').innerText = 'Settings';
    c.innerHTML = `
        <div class="max-w-2xl theme-panel bg-white p-8 rounded-xl border border-gray-200">
            <h2 class="text-xl font-bold mb-6">Account Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Name</label>
                    <input id="settings-name" type="text" class="w-full border p-3 rounded" value="${currentUser.name}">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Username</label>
                    <input id="settings-user" type="text" class="w-full border p-3 rounded" value="${currentUser.username}" disabled>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Password</label>
                    <input id="settings-pass" type="password" class="w-full border p-3 rounded" value="${currentUser.password}">
                </div>
                <button onclick="saveSettings()" class="btn-theme px-6 py-2 rounded font-bold">Save Changes</button>
            </div>
        </div>
    `;
}
window.saveSettings = async () => {
    currentUser.name = $('settings-name').value;
    currentUser.password = $('settings-pass').value;
    const uIndex = db.users.findIndex(u => u.id === currentUser.id);
    if(uIndex !== -1) {
        db.users[uIndex] = currentUser;
    }
    const success = await saveDB();
    if(success) {
        showToast('Settings saved');
        render();
    }
}

// --- ADMIN TEACHERS LIST ---
function renderTeachersList(c) {
    $('page-title').innerText = 'Teachers';
    const teachers = db.users.filter(u => u.role === 'teacher');
    c.innerHTML = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Teachers</h2>
                <button onclick="openAddTeacherModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>Add Teacher</button>
            </div>
            ${teachers.length === 0 ? '<div class="theme-panel p-8 text-center text-gray-400 italic">No teachers yet.</div>' : 
                teachers.map(t => `
                    <div class="theme-panel bg-white p-4 rounded border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                ${renderAvatar(t, 'w-10 h-10', 'text-sm')}
                                <div>
                                    <h3 class="font-bold text-gray-800">${t.name}</h3>
                                    <p class="text-xs text-gray-500">${t.username}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;
}
window.openAddTeacherModal = () => { renderModal('modal-add-teacher', 'Add Teacher', `<div class="space-y-3"><input id="t-name" class="w-full border p-2 rounded" placeholder="Teacher Name"><input id="t-user" class="w-full border p-2 rounded" placeholder="Username"><input id="t-pass" class="w-full border p-2 rounded" placeholder="Password"><button onclick="addTeacher()" class="w-full btn-theme py-2 rounded">Add Teacher</button></div>`); }
window.addTeacher = () => { const n=$('t-name').value, u=$('t-user').value, p=$('t-pass').value; if(n&&u&&p){ db.users.push({id:'u'+Date.now(), name:n, role:'teacher', username:u, password:p, avatar:n[0]}); saveDB(); render(); closeModal('modal-add-teacher'); } }

// --- THEME BUILDER ---
function renderThemeBuilder(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    $('page-title').innerText = 'Theme & Design';
    const t = db.theme;
    c.innerHTML = `
        <div class="max-w-4xl mx-auto theme-panel bg-white p-8 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800">Customize Interface</h2>
                <button onclick="saveTheme()" class="btn-theme px-6 py-2 font-bold rounded shadow hover:shadow-lg">Save Changes</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">App Name</label>
                    <input id="theme-name" value="${t.appName}" class="w-full border p-3 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">Accent Color</label>
                    <input type="color" id="accent-color" value="${t.accentColor || '#0374B5'}" class="w-full h-12 cursor-pointer rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">Background Color</label>
                    <input type="color" id="bg-color" value="${t.bgColor}" class="w-full h-12 cursor-pointer rounded">
                </div>
            </div>
        </div>
    `;
}
window.saveTheme = async () => {
    db.theme.appName = $('theme-name').value;
    db.theme.accentColor = $('accent-color').value;
    db.theme.bgColor = $('bg-color').value;
    db.theme.bgType = 'color';
    applyTheme();
    const success = await saveDB();
    if(success) {
        showToast('Theme saved');
    }
}

// --- POST CARD HELPER ---
function renderPostCard(p, isAdmin) {
    return `<div class="theme-panel bg-white p-6 rounded border border-gray-200 shadow-sm relative group">
        <div class="flex gap-3 mb-3">${renderAvatar({name:p.authorName}, 'w-10 h-10', 'text-sm')}<div><p class="font-bold text-sm">${p.authorName}</p><p class="text-xs text-gray-500">${new Date(p.date).toLocaleString()}</p></div></div>
        <div class="text-gray-700 whitespace-pre-line">${p.content}</div>
    </div>`;
}

// --- MODULE BUILDER ---
window.openModuleBuilder = () => { builderBlocks = []; editingModuleId = null; currentView = 'module_builder'; render(); }
window.editModule = (mid) => { const m = db.modules.find(x=>x.id===mid); builderBlocks = JSON.parse(JSON.stringify(m.blocks)); editingModuleId = mid; currentView = 'module_builder'; render(); }
window.deleteModule = (mid) => { showConfirm("Delete Module?", () => { db.modules = db.modules.filter(m=>m.id!==mid); saveDB(); render(); }); }
window.viewModule = (mid) => { const m = db.modules.find(x=>x.id===mid); if(!m) return; const contentHtml = m.blocks.map(b => { if(b.type==='text') return `<div class="mb-4 text-gray-800 whitespace-pre-wrap">${b.content}</div>`; if(b.type==='image') return `<img src="${b.content}" class="w-full h-auto rounded mb-4">`; return ''; }).join(''); renderModal('mod-view', m.title, `<div class="max-h-[75vh] overflow-y-auto">${contentHtml||'<div class="text-center text-gray-400 py-8">No content</div>'}</div>`); }
window.saveModule = async () => { const title=$('mod-title').value; if(!title) return showToast('Title required','error'); const moduleData = { id: editingModuleId || 'mod'+Date.now(), courseId: currentCourseId, title: title, blocks: builderBlocks }; if(editingModuleId){ const idx=db.modules.findIndex(m=>m.id===editingModuleId); db.modules[idx]=moduleData; } else { if(!db.modules) db.modules=[]; db.modules.push(moduleData); } await saveDB(); currentView='course'; render(); showToast('Module saved'); }
window.cancelModule = () => { currentView='course'; render(); }

function renderModuleBuilder(c) {
    c.innerHTML = `<div class="max-w-3xl mx-auto theme-panel bg-white p-6 rounded-xl"><h2 class="text-xl font-bold mb-4">${editingModuleId ? 'Edit Module' : 'New Module'}</h2><input id="mod-title" class="w-full border p-3 rounded-lg mb-4" placeholder="Module Title" value="${editingModuleId ? (db.modules.find(m=>m.id===editingModuleId)||{}).title : ''}"><div id="blocks-container"></div><div class="flex gap-2 mt-4"><button onclick="addBlock('text')" class="px-4 py-2 border rounded hover:bg-gray-50"><i class="fas fa-font mr-2"></i>Text</button><button onclick="addBlock('image')" class="px-4 py-2 border rounded hover:bg-gray-50"><i class="fas fa-image mr-2"></i>Image</button></div><div class="flex justify-between mt-6"><button onclick="cancelModule()" class="px-6 py-2 border rounded hover:bg-gray-50">Cancel</button><button onclick="saveModule()" class="btn-theme px-6 py-2 rounded font-bold">Save Module</button></div></div>`;
    renderBlocks();
}
window.renderBlocks = () => { const container=$('blocks-container'); if(!container) return; container.innerHTML=builderBlocks.map((b,i)=>`<div class="module-block"><div class="block-actions"><button onclick="removeBlock(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>${b.type==='text'?`<textarea class="rich-content w-full" onchange="updateBlock(${i},this.value)" placeholder="Enter text...">${b.content}</textarea>`:b.type==='image'?`<input type="file" onchange="uploadBlockFile(${i},this)" accept="image/*" class="text-sm">${b.content?`<img src="${b.content}" class="mt-2 rounded max-h-48">`:''}`:''}</div>`).join(''); }
window.addBlock = (type) => { builderBlocks.push({type,content:''}); renderBlocks(); }
window.removeBlock = (i) => { builderBlocks.splice(i,1); renderBlocks(); }
window.updateBlock = (i,val) => { builderBlocks[i].content=val; }
window.uploadBlockFile = (i,input) => { if(input.files[0]){ const r=new FileReader(); r.onload=e=>{ builderBlocks[i].content=e.target.result; renderBlocks(); }; r.readAsDataURL(input.files[0]); } }

</script>
</body>
</html>
