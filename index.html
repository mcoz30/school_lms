<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LearnNovaLMS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { 
                            base: '#2D3B45', 
                            primary: '#0e1e24', 
                            accent: 'var(--accent-color)', 
                            danger: '#EE4D3D', 
                            success: '#00AC18',
                            light: '#F5F5F5'
                        }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-style: #F5F5F5;
            --glass-bg: #ffffff;
            --glass-border: 1px solid #e2e8f0;
            --glass-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --backdrop-blur: none;
            --text-color: #2D3B45;
            --sidebar-bg: #ffffff;
            --nav-item-active-bg: rgba(3, 116, 181, 0.1);
            
            --header-bg: #ffffff;
            --header-text: #2D3B45;
            --header-shadow: none;
            --global-border-color: #e2e8f0;
            --accent-color: #0374B5; 
            --btn-bg: #0374B5; 
        }

        body { 
            background: var(--bg-style); 
            color: var(--text-color); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        .theme-panel {
            background: var(--glass-bg);
            border: 1px solid var(--global-border-color);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        header.theme-panel {
            background: var(--header-bg) !important;
            color: var(--header-text) !important;
            border-bottom: 1px solid var(--global-border-color) !important;
            text-shadow: var(--header-shadow);
        }
        
        .btn-theme {
            background: var(--btn-bg);
            color: white;
            border: none;
            transition: all 0.2s;
        }
        .btn-theme:hover {
            opacity: 0.95;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .text-theme { color: var(--accent-color); }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
        
        .nav-item.active { background: var(--nav-item-active-bg); color: var(--accent-color); border-right: 3px solid var(--accent-color); }

        #global-nav { 
            width: 84px; flex-shrink: 0; 
            background: var(--sidebar-bg);
            display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; 
            border-right: 1px solid var(--global-border-color);
            backdrop-filter: var(--backdrop-blur);
        }
        .nav-item { color: var(--text-color); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; opacity: 0.8; }
        .nav-item:hover { background-color: rgba(0,0,0,0.05); opacity: 1; }
        .nav-item.active { background-color: rgba(var(--accent-color), 0.1); color: var(--accent-color); border-left: 4px solid var(--accent-color); opacity: 1; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }

        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .module-block { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: rgba(255,255,255,0.8); position: relative; transition: all 0.2s; }
        .module-block:hover { border-color: var(--accent-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .module-block:hover .block-actions { opacity: 1; }
        .rich-toolbar { background: rgba(0,0,0,0.02); padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .rich-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; font-size: 12px; font-weight: bold; color: #475569; display: inline-flex; align-items: center; justify-content: center; height: 28px; min-width: 28px; }
        .rich-btn:hover { background: #e2e8f0; color: #0f172a; }
        .rich-content { min-height: 80px; padding: 10px; outline: none; background: white; color: #334155; }
        
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; align-items: center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm font-sans">

    <div id="loading-screen"><i class="fas fa-circle-notch fa-spin text-4xl"></i><p class="font-bold tracking-widest">CONNECTING...</p></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved</div>
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { createClient } from "https://esm.run/@libsql/client/web";

// === YOUR NEW READ-WRITE TURSO TOKEN ===
const tursoUrl = "libsql://schoollms-mcoz30.aws-ap-south-1.turso.io";
const tursoAuthToken = "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NzAyMTU2MTYsImlkIjoiMmE2YjA5ODMtZTgwNy00OTU4LWE5YmUtZjJhMTc3ZTNmMWEzIiwicmlkIjoiNGVkMGZmZjAtMzRkNS00YzBhLTliMzMtMmRiYTgxMWUwZjE3In0.8uqoA6Q-x9S3mdXSps88I8agK9_gFrEFf54gx--4XZNNj0biKu_mouO50OfrrrWUyaKx9aZRtygjVdai35ZhBg";
const client = createClient({ url: tursoUrl, authToken: tursoAuthToken });

// === DEFAULT DATA (exact same as original) ===
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u3', name: 'Maria Santos', role: 'student', username: 'student2', password: '123', avatar: 'MS' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '123', avatar: 'AD' } 
    ],
    subjects: [
        { id: 's1', name: 'Introduction to Physics', code: 'PHYS-101', teacherId: 'u1', students: ['u2', 'u3'], color: '#0374B5', img: 'https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=600&q=80', introTitle: 'Welcome to Physics', introBody: 'Check the feed.', gradingWeights: { ww: 40, pt: 40, qa: 20 } }
    ],
    posts: [{ id: 'p1', courseId: 's1', authorId: 'u1', authorName: 'Mrs. Anderson', date: '2023-10-24T09:00', content: 'Welcome to class!', mediaType: 'text', isPinned: false }],
    globalPosts: [],
    activities: { 's1': [] },
    activitySubmissions: {},
    exams: { 's1': [] },
    examSubmissions: {},
    modules: { 's1': [] },
    globalEvents: [],
    theme: { appName: 'LearnNovaLMS', logoUrl: '', bgType: 'color', bgColor: '#F5F5F5', bgGradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', bgImage: '', glassEffect: false, glassOpacity: 0.95 }
};

let db = structuredClone(defaultData), currentUser = null, currentView = 'login', currentCourseId = null, activeExamId = null, currentTab = 'home';
let builderBlocks = [], editingModuleId = null, editingActivityId = null;

// === SAFE INIT WITH TIMEOUT (NO MORE STUCK LOADING) ===
async function initDB() {
    let loadedFromCloud = false;

    // 5-second timeout for cloud connection
    const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000));
    try {
        const { rows } = await Promise.race([
            client.execute("SELECT data FROM app_data WHERE id = 'master_record'"),
            timeout
        ]);
        if (rows.length > 0) {
            db = JSON.parse(rows[0].data);
            loadedFromCloud = true;
            showToast("Synced from cloud database", "info");
        }
    } catch (e) {
        console.log("Cloud load skipped or failed:", e.message || e);
    }

    // Fallback to localStorage
    if (!loadedFromCloud) {
        const local = localStorage.getItem('lms_local_db');
        if (local) {
            try { db = JSON.parse(local); } catch {}
        }
        showToast("Running offline â€“ data saved in browser", "info");
    }

    // Ensure structures
    if (!db.modules) db.modules = {};
    if (!db.theme) db.theme = defaultData.theme;

    applyTheme();
    removeLoadingScreen();
    render();
}

// Force remove loading after 8 seconds max
setTimeout(() => {
    removeLoadingScreen();
    render();
}, 8000);

function removeLoadingScreen() {
    const l = $('loading-screen');
    if (l) {
        l.style.opacity = 0;
        setTimeout(() => l.remove(), 500);
    }
    $('app').classList.remove('opacity-0');
}

// === SAVE (WORKS FULLY WITH YOUR RW TOKEN) ===
let saveTimeout = null;
async function saveDB() {
    const status = $('sync-status');
    if (status) {
        status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
        status.style.opacity = '1';
    }

    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        localStorage.setItem('lms_local_db', JSON.stringify(db)); // Always local backup

        try {
            // Create table if missing
            await client.execute("CREATE TABLE IF NOT EXISTS app_data (id TEXT PRIMARY KEY, data TEXT, updated_at TEXT)");

            await client.execute({
                sql: `INSERT INTO app_data (id, data, updated_at) VALUES (?, ?, ?)
                      ON CONFLICT(id) DO UPDATE SET data = excluded.data, updated_at = excluded.updated_at`,
                args: ['master_record', JSON.stringify(db), new Date().toISOString()]
            });
            if (status) {
                status.innerHTML = '<i class="fas fa-cloud-check"></i> Synced to Cloud';
                setTimeout(() => status.style.opacity = '0', 2000);
            }
        } catch (e) {
            console.error("Cloud save error:", e);
            if (status) {
                status.innerHTML = '<i class="fas fa-save"></i> Saved Locally';
                setTimeout(() => status.style.opacity = '0', 2000);
            }
        }
    }, 500);
}

// === ALL YOUR ORIGINAL FUNCTIONS BELOW (login, dashboard, builders, etc.) ===
// Paste the rest of your original JavaScript code here (from helpers, render, renderLogin, renderDashboard, renderCourse, renderModuleBuilder, renderActivityBuilder, quizzes, etc.)

// Example placeholders for key functions (replace with your full original code)
const $ = id => document.getElementById(id);
const showToast = (msg, type = 'info') => {
    const el = document.createElement('div');
    el.className = `px-4 py-3 rounded shadow-lg text-white font-bold ${type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
    el.textContent = msg;
    $('toast-container').appendChild(el);
    setTimeout(() => el.remove(), 4000);
};

function applyTheme() { /* your original theme code */ }

// render(), renderLogin(), renderDashboard(), renderCourse(), renderModuleBuilder(), renderActivityBuilder(), etc.
// Include the shared block builder functions and the original floating toolbar design from previous fixes.

initDB();
</script>
</body>
</html>
