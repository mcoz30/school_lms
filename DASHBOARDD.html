<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LearnNovaLMS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2D3B45">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Lato"', 'sans-serif'] },
                    colors: {
                        canvas: { 
                            base: '#2D3B45', 
                            primary: '#0e1e24', 
                            accent: 'var(--accent-color)', 
                            danger: '#EE4D3D', 
                            success: '#00AC18',
                            light: '#F5F5F5'
                        }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        /* Dynamic Theme Variables */
        :root {
            --bg-style: #F5F5F5;
            --glass-bg: #ffffff;
            --glass-border: 1px solid #e2e8f0;
            --glass-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --backdrop-blur: none;
            --text-color: #2D3B45;
            --sidebar-bg: #ffffff;
            --nav-item-active-bg: rgba(3, 116, 181, 0.1);
            
            /* Theme Variables */
            --header-bg: #ffffff;
            --header-text: #2D3B45;
            --header-shadow: none;
            --global-border-color: #e2e8f0;
            --accent-color: #0374B5; 
            --btn-bg: #0374B5; 
        }

        body { 
            background: var(--bg-style); 
            color: var(--text-color); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* Professional Card Style */
        .theme-panel {
            background: var(--glass-bg);
            border: 1px solid var(--global-border-color);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Header Styling */
        header.theme-panel {
            background: var(--header-bg) !important;
            color: var(--header-text) !important;
            border-bottom: 1px solid var(--global-border-color) !important;
            text-shadow: var(--header-shadow);
        }
        
        /* Custom Button Class */
        .btn-theme {
            background: var(--btn-bg);
            color: white;
            border: none;
            transition: all 0.2s;
        }
        .btn-theme:hover {
            opacity: 0.95;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .text-theme { color: var(--accent-color); }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
        
        .nav-item.active { background: var(--nav-item-active-bg); color: var(--accent-color); border-right: 3px solid var(--accent-color); }

        /* Global Nav */
        #global-nav { 
            width: 84px; flex-shrink: 0; 
            background: var(--sidebar-bg);
            display: flex; flex-direction: column; align-items: center; padding-top: 1rem; z-index: 50; 
            border-right: 1px solid var(--global-border-color);
            backdrop-filter: var(--backdrop-blur);
        }
        .nav-item { color: var(--text-color); display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 0; cursor: pointer; transition: background 0.2s; position: relative; opacity: 0.8; }
        .nav-item:hover { background-color: rgba(0,0,0,0.05); opacity: 1; }
        .nav-item.active { background-color: rgba(var(--accent-color), 0.1); color: var(--accent-color); border-left: 4px solid var(--accent-color); opacity: 1; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }

        /* Course Cards */
        .course-card { transition: transform 0.2s, box-shadow 0.2s; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .course-header { height: 140px; background-size: cover; background-position: center; position: relative; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.1); }
        .cal-cell { background: var(--glass-bg); min-height: 120px; padding: 0.5rem; position: relative; }
        .cal-cell.today { background: rgba(var(--accent-color), 0.1); border: 1px solid var(--accent-color); }
        .event-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; items-center; gap: 4px; transition: opacity 0.2s; }
        
        /* Feed */
        .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; margin-top: 10px; } 
        .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Module & Activity Builder Styles */
        .module-block { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: rgba(255,255,255,0.8); position: relative; transition: all 0.2s; }
        .module-block:hover { border-color: var(--accent-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .block-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .module-block:hover .block-actions { opacity: 1; }
        .rich-toolbar { background: rgba(0,0,0,0.02); padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .rich-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; font-size: 12px; font-weight: bold; color: #475569; display: inline-flex; align-items: center; justify-content: center; height: 28px; min-width: 28px; }
        .rich-btn:hover { background: #e2e8f0; color: #0f172a; }
        .rich-content { min-height: 80px; padding: 10px; outline: none; background: white; color: #334155; }
        
        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #global-nav { width: 100%; height: 60px; flex-direction: row; padding: 0; justify-content: space-around; position: fixed; bottom: 0; }
            .nav-item { padding: 0.5rem; }
            .nav-label { display: none; }
            #content-area { padding-bottom: 80px; }
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .cal-cell { min-height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
            .cal-header-row { display: none; }
        }
        
        #loading-screen { position: fixed; inset: 0; background: #2D3B45; z-index: 9999; display: flex; justify-content: center; items-center; color: white; flex-direction: column; gap: 1rem; transition: opacity 0.5s; }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; z-index: 100; display: flex; items-center; gap: 0.5rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm font-sans">

    <div id="loading-screen"><i class="fas fa-circle-notch fa-spin text-4xl"></i><p class="font-bold tracking-widest">CONNECTING...</p></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sync-status"><i class="fas fa-save"></i> Saved</div>
    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500"></div>
    <div id="modal-portal" class="relative z-[60]"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// --- SUPABASE CONFIGURATION ---
const supabaseUrl = 'https://lgovvztkuqnpsshdrwyu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnb3Z2enRrdXFucHNzaGRyd3l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTY0OTgsImV4cCI6MjA4NTU5MjQ5OH0.0gks6pz9g8JCP6LMiKEGQj3J-M27ljGPLwv-umyoPVA';

const supabase = createClient(supabaseUrl, supabaseKey);

// --- DATA STORE ---
const defaultData = {
    users: [
        { id: 'u1', name: 'Mrs. Anderson', role: 'teacher', username: 'teacher', password: '123', avatar: 'MA' },
        { id: 'u2', name: 'Juan Dela Cruz', role: 'student', username: 'student', password: '123', avatar: 'JD' },
        { id: 'u3', name: 'Maria Santos', role: 'student', username: 'student2', password: '123', avatar: 'MS' },
        { id: 'u0', name: 'School Admin', role: 'admin', username: 'admin', password: '123', avatar: 'AD' } 
    ],
    subjects: [
        { id: 's1', name: 'Introduction to Physics', code: 'PHYS-101', teacherId: 'u1', students: ['u2', 'u3'], color: '#0374B5', img: 'https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=600&q=80', introTitle: 'Welcome to Physics', introBody: 'Check the feed.', gradingWeights: { ww: 40, pt: 40, qa: 20 } }
    ],
    posts: [{ id: 'p1', courseId: 's1', authorId: 'u1', authorName: 'Mrs. Anderson', date: '2023-10-24T09:00', content: 'Welcome to class!', mediaType: 'text', isPinned: false }],
    globalPosts: [],
    activities: { 's1': [] },
    activitySubmissions: {},
    exams: { 's1': [] },
    examSubmissions: {},
    modules: { 's1': [] },
    globalEvents: [],
    theme: { appName: 'LearnNovaLMS', logoUrl: '', bgType: 'color', bgColor: '#F5F5F5', bgGradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', bgImage: '', glassEffect: false, glassOpacity: 0.95 }
};

let db = defaultData, currentUser = null, currentView = 'login', currentCourseId = null, activeExamId = null, currentTab = 'home', calendarDate = new Date(), importedText = '', tempPostImage = null, tempTeacherImage = null, adminCourseFilter = 'all', selectedLoginRole = null, supabaseUser = null; 
let builderBlocks = [], editingModuleId = null, editingActivityId = null;

// --- MESSAGING SYSTEM ---
let currentChatRoom = null;
let messagePollingInterval = null;
const MESSAGE_RETENTION_DAYS = 7; // Messages vanish after 7 days

// --- PH HOLIDAYS ---
const phHolidays = [
    {m:0, d:1, t:'New Year\'s Day', c:'red'}, {m:1, d:25, t:'EDSA Revolution', c:'yellow'}, {m:3, d:9, t:'Araw ng Kagitingan', c:'red'}, {m:4, d:1, t:'Labor Day', c:'red'},
    {m:5, d:12, t:'Independence Day', c:'blue'}, {m:7, d:21, t:'Ninoy Aquino Day', c:'yellow'}, {m:7, d:28, t:'National Heroes Day', c:'red'}, {m:10, d:1, t:'All Saints Day', c:'purple'},
    {m:10, d:2, t:'All Souls Day', c:'purple'}, {m:10, d:30, t:'Bonifacio Day', c:'red'}, {m:11, d:8, t:'Feast of Immaculate Conception', c:'blue'}, {m:11, d:25, t:'Christmas Day', c:'green'}, {m:11, d:30, t:'Rizal Day', c:'blue'}
];

// --- SUPABASE SYNC ---
let saveTimeout = null;

async function initSupabase() {
    try {
        const { data: appData, error } = await supabase
            .from('app_data')
            .select('data')
            .eq('id', 'master_record')
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error("Supabase Error:", error);
        }
        
        if (appData && appData.data) {
            db = appData.data;
            ['activities','activitySubmissions','modules','exams','examSubmissions','globalEvents'].forEach(k=>{
                if(!db[k]) db[k] = (k==='activitySubmissions'||k==='examSubmissions') ? {} : [];
            });
            if(!db.theme) db.theme = defaultData.theme;
        } else {
            console.log("Initializing with default data");
        }
        
        applyTheme();
        
        const l = $('loading-screen');
        if(l) {
            l.style.opacity=0;
            setTimeout(() => l.remove(), 500);
            $('app').classList.remove('opacity-0');
        }
        
        // --- REALTIME SUBSCRIPTION SETUP ---
        supabase.channel('public:app_data')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'app_data', filter: 'id=eq.master_record' }, payload => {
                // Ignore updates if they match our last local save (prevents jitter)
                // Since we don't have a transaction ID, we check content roughly or just apply
                if (payload.new && payload.new.data) {
                    console.log('Received live update:', new Date().toISOString());
                    
                    const unsafeViews = ['module_builder', 'activity_builder', 'theme_builder', 'exam-take'];
                    const isWritingPost = currentView === 'course' && currentTab === 'home' && document.activeElement && document.activeElement.tagName === 'TEXTAREA';
                    
                    if (!unsafeViews.includes(currentView) && !isWritingPost) {
                         db = payload.new.data; // Apply cloud data
                         applyTheme();
                         render(); // Refresh UI
                         
                         const status = $('sync-status');
                         if(status) {
                             status.innerHTML = '<i class="fas fa-bolt text-yellow-400"></i> Live Update';
                             status.style.opacity = '1';
                             setTimeout(() => { status.style.opacity = '0'; }, 2000);
                         }
                    } else {
                        // If user is editing, we skip the full render but maybe silently update non-conflict parts? 
                        // For simplicity in this structure, we skip to avoid overwriting work.
                        console.log('Skipped render to protect user input');
                    }
                }
            })
            .subscribe();

        if(!currentUser) render();
    } catch (e) {
        console.error("Supabase Init Error:", e);
        const l = $('loading-screen');
        if(l) {
            l.style.opacity=0;
            setTimeout(() => l.remove(), 500);
            $('app').classList.remove('opacity-0');
        }
        if(!currentUser) render();
    }
}

// Optimized Non-Blocking Save
async function saveDB() {
    // Immediate UI Feedback
    const status = $('sync-status');
    if(status) {
        status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
        status.style.opacity = '1';
    }

    // Debounce to prevent flooding
    if (saveTimeout) clearTimeout(saveTimeout);

    return new Promise((resolve) => {
        saveTimeout = setTimeout(async () => {
            try {
                const { error } = await supabase
                    .from('app_data')
                    .upsert({ 
                        id: 'master_record', 
                        data: db,
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'id' 
                    });
                
                if (error) {
                    console.error("Save Error:", error);
                    if (error.code === '42P01' || error.code === '42501') {
                        showDatabaseErrorModal(error.code);
                    } else {
                        showToast('Sync failed: ' + error.message, 'error');
                    }
                    resolve(false);
                } else {
                    if(status) {
                        status.innerHTML = '<i class="fas fa-check"></i> Saved';
                        setTimeout(() => status.style.opacity = '0', 2000);
                    }
                    resolve(true);
                }
            } catch (e) {
                console.error("Save Error:", e);
                showToast('Connection failed', 'error');
                resolve(false);
            }
        }, 500); // 500ms delay to batch rapid updates
    });
}

// Helper to show SQL Fix
window.showDatabaseErrorModal = (code) => {
    const title = code === '42P01' ? 'Database Table Missing' : 'Permission Denied (RLS)';
    const msg = code === '42P01' 
        ? 'The "app_data" table does not exist in your Supabase project.' 
        : 'Row Level Security is blocking the save. You need to enable public access.';
    
    renderModal('db-error', title, `
        <div class="space-y-4">
            <div class="bg-red-50 text-red-700 p-4 rounded border border-red-200">
                <p class="font-bold"><i class="fas fa-exclamation-triangle"></i> Data Not Saving</p>
                <p class="text-sm mt-1">${msg}</p>
            </div>
            <p class="text-sm text-gray-600">Please go to the <strong>Supabase SQL Editor</strong> and run this code:</p>
            <div class="relative group">
                <textarea id="sql-code" class="w-full h-32 bg-gray-800 text-green-400 font-mono text-xs p-3 rounded" readonly>
create table if not exists app_data (
  id text primary key,
  data jsonb,
  updated_at timestamptz
);
alter table app_data enable row level security;
create policy "Public Access" on app_data for all using (true) with check (true);
                </textarea>
                <button onclick="navigator.clipboard.writeText(document.getElementById('sql-code').value); showToast('SQL Copied!')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/40 text-white px-2 py-1 rounded text-xs">Copy</button>
            </div>
            <button onclick="saveDB(); closeModal('db-error')" class="btn-theme w-full text-white py-2 rounded font-bold">I ran the code, Try Saving Again</button>
        </div>
    `);
}

initSupabase();

// --- THEME ENGINE ---
function applyTheme() {
    const t = db.theme || defaultData.theme;
    document.title = t.appName;
    const root = document.documentElement;
    if (t.bgType === 'image' && t.bgImage) root.style.setProperty('--bg-style', `url('${t.bgImage}')`);
    else if (t.bgType === 'gradient') root.style.setProperty('--bg-style', t.bgGradient);
    else root.style.setProperty('--bg-style', t.bgColor);

    if (t.glassEffect) {
        root.style.setProperty('--glass-bg', `rgba(255, 255, 255, ${t.glassOpacity || 0.8})`);
        root.style.setProperty('--glass-border', '1px solid rgba(255, 255, 255, 0.4)');
        root.style.setProperty('--glass-shadow', '0 8px 32px 0 rgba(31, 38, 135, 0.15)');
        root.style.setProperty('--backdrop-blur', 'blur(16px)');
        root.style.setProperty('--sidebar-bg', `rgba(255, 255, 255, ${Math.max(0.5, (t.glassOpacity || 0.8) - 0.1)})`);
    } else {
        root.style.setProperty('--glass-bg', '#ffffff');
        root.style.setProperty('--glass-border', '1px solid #e2e8f0');
        root.style.setProperty('--glass-shadow', '0 1px 3px 0 rgb(0 0 0 / 0.1)');
        root.style.setProperty('--backdrop-blur', 'none');
        root.style.setProperty('--sidebar-bg', '#ffffff');
    }
    
    // Theme Props
    root.style.setProperty('--global-border-color', t.borderColor || '#e2e8f0');
    root.style.setProperty('--accent-color', t.accentColor || '#0374B5');
    root.style.setProperty('--nav-item-active-bg', `rgba(${hexToRgb(t.accentColor || '#0374B5')}, 0.1)`);
    
    // Header
    if (t.headerType === 'gradient') {
        root.style.setProperty('--header-bg', t.headerGradient || 'linear-gradient(to right, #ffffff, #f3f4f6)');
    } else {
        root.style.setProperty('--header-bg', t.headerColor || '#ffffff');
    }
    root.style.setProperty('--header-text', t.headerTextColor || '#2D3B45');
    root.style.setProperty('--header-shadow', t.headerShadow || 'none');

    // Buttons
    if (t.btnType === 'gradient') {
        root.style.setProperty('--btn-bg', t.btnGradient || 'linear-gradient(to right, #0374B5, #00C6FF)');
    } else {
        root.style.setProperty('--btn-bg', t.accentColor || '#0374B5');
    }
}

function hexToRgb(hex) {
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) { return r + r + g + g + b + b; });
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '3, 116, 181';
}

// --- HELPERS ---
const $ = (id) => document.getElementById(id);
window.$ = $;
const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const showToast = (msg, type='info') => {
    const b = document.createElement('div');
    b.className = `px-4 py-3 rounded shadow-lg text-white font-bold transform transition-all duration-300 translate-y-4 pointer-events-auto ${type==='error'?'bg-canvas-danger':'bg-canvas-accent'}`;
    b.innerText = msg; $('toast-container').appendChild(b); setTimeout(()=>b.remove(), 3000);
};
const showConfirm = (message, onYes) => {
    const id = 'confirm-modal';
    renderModal(id, 'Confirm', `<div class="space-y-4"><p>${message}</p><div class="flex justify-end gap-2"><button onclick="closeModal('${id}')" class="px-4 py-2 border rounded">Cancel</button><button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded">Confirm</button></div></div>`);
    setTimeout(() => $('confirm-yes').onclick = () => { onYes(); closeModal(id); }, 50);
};
const renderAvatar = (user, size='w-8 h-8', text='text-xs') => {
    if (user?.avatar?.startsWith('data:') || user?.avatar?.startsWith('http')) return `<img src="${user.avatar}" class="${size} rounded-full object-cover border bg-white">`;
    return `<div class="${size} rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ${text} font-bold border border-blue-200">${user?.name?.[0]||'?'}</div>`;
};
window.parseQuizText = (text) => {
    const questions = []; const lines = text.split('\n').map(l => l.trim()).filter(l => l); let currQ = null, currPassage = '', tempBuffer = '';
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i]; const ansMatch = line.match(/^(?:Answer|Ans|Key)[\s:\-\.]*([A-Z])/i) || line.match(/^\*([A-Z])/i);
        if (ansMatch && currQ) { let code = ansMatch[1].toUpperCase().charCodeAt(0) - 65; if(code >= 0 && code < 26) currQ.ans = code; continue; }
        const optMatch = line.match(/^[\(\s]*([A-Z])[\.\)\s]\s*(.*)/i);
        if (optMatch && currQ) { currQ.options.push(optMatch[2].trim()); continue; }
        const qMatch = line.match(/^(\d+)[\.\)\s]\s*(.*)/);
        if (qMatch) { if (currQ) { if(currQ.options.length > 0) questions.push(currQ); } if (tempBuffer) { currPassage = tempBuffer.trim(); tempBuffer = ''; } let qText = qMatch[2].trim(); currQ = { q: qText, options: [], ans: 0, passage: currPassage }; continue; }
        if (line.length < 2 && !line.match(/[a-z]/i)) continue; if (tempBuffer) tempBuffer += '\n'; tempBuffer += line;
    }
    if (currQ && currQ.options.length > 0) questions.push(currQ);
    return questions;
};
function questionsToText(questions) {
    let textOutput = "", lastPassage = "";
    questions.forEach((q, i) => { if (q.passage && q.passage !== lastPassage) { textOutput += `\n${q.passage}\n\n`; lastPassage = q.passage; } textOutput += `${i+1}. ${q.q}\n`; q.options.forEach((opt, idx) => { textOutput += `${String.fromCharCode(65+idx)}. ${opt}\n`; }); textOutput += `Answer: ${String.fromCharCode(65+q.ans)}\n\n`; });
    return textOutput.trim();
}
window.onManualInput = (val) => { const qs = parseQuizText(val); const label = $('manual-detected-label'); if(label) label.innerHTML = qs.length > 0 ? `<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> ${qs.length} Questions Detected</span>` : `<span class="text-gray-400">Typing...</span>`; }

// --- ROUTER ---
function render() {
    const app = $('app'); if (!app) return; app.innerHTML = '';
    if(currentView === 'login') { renderLogin(app); } else {
        const logo = db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-20 w-auto max-w-[80px] object-contain">` : '<i class="fas fa-shapes text-5xl text-canvas-accent"></i>';
        app.innerHTML = `
            <div id="main-layout" class="flex w-full h-full">
                <nav id="global-nav">
                    <div class="mb-6 hidden md:block mt-4 transform hover:scale-110 transition-transform duration-300 px-2">${logo}</div>
                    <div class="nav-item ${currentView==='dashboard'?'active':''}" onclick="goDashboard()"><i class="fas fa-tachometer-alt nav-icon"></i><span class="nav-label">Dash</span></div>
                    ${currentUser.role === 'admin' ? `
                    <div class="nav-item ${currentView==='teachers_list'?'active':''}" onclick="goTeachersList()"><i class="fas fa-chalkboard-teacher nav-icon"></i><span class="nav-label">Teachers</span></div>
                    <div class="nav-item ${currentView==='theme_builder'?'active':''}" onclick="goThemeBuilder()"><i class="fas fa-palette nav-icon"></i><span class="nav-label">Design</span></div>
                    ` : ''}
                    <div class="nav-item ${currentView==='courses_list'||currentView==='course'||currentView==='module_builder'?'active':''}" onclick="goCoursesList()"><i class="fas fa-book nav-icon"></i><span class="nav-label">Courses</span></div>
                    <div class="nav-item ${currentView==='calendar'?'active':''}" onclick="goCalendar()"><i class="fas fa-calendar-alt nav-icon"></i><span class="nav-label">Calendar</span></div>
                    <div class="nav-item ${currentView==='settings'?'active':''}" onclick="goSettings()"><i class="fas fa-cog nav-icon"></i><span class="nav-label">Settings</span></div>
                    <div class="mt-auto mb-4 nav-item" onclick="logout()"><i class="fas fa-sign-out-alt nav-icon text-gray-400"></i><span class="nav-label text-gray-400">Logout</span></div>
                </nav>
                <main id="content-area" class="flex-1 overflow-y-auto relative p-6">
                    <header class="theme-panel h-20 flex items-center justify-between px-6 sticky top-0 z-40 rounded-xl mb-6 animate-slide-up">
                        <div class="flex items-center gap-4">
                            ${db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-16 w-auto object-contain">` : ''}
                            <h2 class="font-bold text-xl uppercase tracking-wide" id="page-title">${db.theme.appName}</h2>
                        </div>
                        <div class="flex items-center gap-3"><span class="text-sm font-bold opacity-90">${currentUser.name}</span>${renderAvatar(currentUser, 'w-9 h-9', 'text-sm')}</div>
                    </header>
                    <div id="page-content" class="max-w-7xl mx-auto animate-slide-up" style="animation-delay: 0.1s;"></div>
                </main>
            </div>
        `;
        const c = $('page-content');
        if(currentView === 'dashboard') renderDashboard(c);
        if(currentView === 'teachers_list') renderTeachersList(c);
        if(currentView === 'courses_list') renderCoursesList(c);
        if(currentView === 'calendar') renderCalendar(c);
        if(currentView === 'course') renderCourse(c);
        if(currentView === 'module_builder') renderModuleBuilder(c);
        if(currentView === 'activity_builder') renderActivityBuilder(c);
        if(currentView === 'exam-take') renderExamTake(c);
        if(currentView === 'exam-review') renderExamReview(c);
        if(currentView === 'settings') renderSettings(c);
        if(currentView === 'theme_builder') renderThemeBuilder(c);
    }
}

// Global Nav
window.goDashboard = () => { currentView='dashboard'; render(); }
window.goCoursesList = () => { currentView='courses_list'; render(); }
window.goCalendar = () => { currentView='calendar'; render(); }
window.goSettings = () => { currentView='settings'; render(); }
window.goTeachersList = () => { currentView='teachers_list'; render(); }
window.goThemeBuilder = () => { currentView='theme_builder'; render(); }
window.logout = () => { currentUser=null; currentView='login'; render(); }
window.goCourse = (sid) => { currentCourseId = sid; currentView = 'course'; render(); }

// --- LOGIN ---
function renderLogin(c) {
    const logo = db.theme.logoUrl ? `<img src="${db.theme.logoUrl}" class="h-64 mx-auto mb-6 object-contain drop-shadow-md">` : '<i class="fas fa-shapes text-9xl text-canvas-accent mb-6 inline-block drop-shadow-md"></i>';
    c.innerHTML = `
        <div class="flex h-screen w-full bg-[#2D3B45] items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
            <div class="theme-panel bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center relative z-10 animate-slide-up">
                ${logo}
                <h1 class="text-4xl font-black text-gray-800 mb-2 tracking-tight">${db.theme.appName}</h1>
                <p class="text-gray-500 mb-8 font-medium" id="login-subtext">Select your portal to continue</p>
                <div id="role-selector" class="space-y-4">
                    <button onclick="showLoginForm('teacher')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-chalkboard-teacher"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Teacher</span><span class="text-xs text-gray-500">Manage courses & grades</span></div></button>
                    <button onclick="showLoginForm('student')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-green-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-green-100 text-green-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-user-graduate"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Student</span><span class="text-xs text-gray-500">Access your learning</span></div></button>
                    <button onclick="showLoginForm('admin')" class="w-full flex items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl hover:border-purple-500 hover:shadow-lg transition-all group hover:-translate-y-1"><div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm"><i class="fas fa-user-shield"></i></div><div class="text-left"><span class="block font-bold text-lg text-gray-800">Admin</span><span class="text-xs text-gray-500">System configuration</span></div></button>
                </div>
                <div id="login-form-box" class="hidden text-left space-y-5 animate-fade-in">
                    <div class="flex items-center mb-6"><button onclick="hideLoginForm()" class="text-gray-400 hover:text-black mr-4 p-2 rounded-full hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button><h2 class="text-2xl font-bold text-gray-800" id="form-role-title">Login</h2></div>
                    <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1 ml-1">Username</label><input id="login-user" type="text" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-50 focus:bg-white"></div>
                    <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1 ml-1">Password</label><input id="login-pass" type="password" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-50 focus:bg-white"></div>
                    <button onclick="loginAttempt()" class="btn-theme w-full font-bold py-3.5 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition-all mt-4">Sign In</button>
                </div>
            </div>
        </div>
    `;
}
window.showLoginForm = (r) => { selectedLoginRole=r; $('role-selector').classList.add('hidden'); $('login-subtext').classList.add('hidden'); $('login-form-box').classList.remove('hidden'); $('form-role-title').innerText = {'teacher':'Teacher Portal','student':'Student Portal','admin':'Administrator'}[r]; setTimeout(() => $('login-user').focus(), 100); }
window.hideLoginForm = () => { selectedLoginRole=null; $('role-selector').classList.remove('hidden'); $('login-subtext').classList.remove('hidden'); $('login-form-box').classList.add('hidden'); $('login-user').value = ''; $('login-pass').value = ''; }
window.loginAttempt = async () => { 
    const u=$('login-user').value.trim(), p=$('login-pass').value.trim(); 
    const user = db.users.find(x => x.username === u && x.password === p); 
    if(user) { 
        if (selectedLoginRole && user.role !== selectedLoginRole) return showToast(`Not a ${selectedLoginRole}`, 'error'); 
        currentUser = user;
        supabaseUser = { id: user.id, email: user.username + '@school.local' };
        await saveDB(); // Save any pending changes
        goDashboard(); 
    } else showToast('Invalid credentials', 'error'); 
}

// --- DASHBOARD ---
function renderDashboard(c) {
    $('page-title').innerText = 'Dashboard';
    if(currentUser.role === 'admin') {
        // Trigger Auto-Backup Check on Dashboard Load
        checkAutoBackup();
        
        // Fetch backups list for the UI
        fetchBackupsList();

        c.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Backup & System Panel (New) -->
                <div class="lg:col-span-3">
                    <div class="theme-panel bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gradient-to-r from-gray-50 to-white">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xl shadow-sm">
                                <i class="fas fa-database"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">System Database & Backups</h3>
                                <p class="text-xs text-gray-500" id="last-backup-msg">Last Auto-Backup: ${db.lastAutoBackup ? new Date(db.lastAutoBackup).toLocaleString() : 'Never'}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="createCloudBackup()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow hover:shadow-md text-sm">
                                <i class="fas fa-cloud-upload-alt"></i> Cloud Backup
                            </button>
                            <button onclick="downloadLocalBackup()" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 transition shadow-sm text-sm">
                                <i class="fas fa-download"></i> Download JSON
                            </button>
                             <button onclick="$('backup-list-container').classList.toggle('hidden')" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition text-sm">
                                <i class="fas fa-history"></i> Restore
                            </button>
                        </div>
                    </div>
                    
                    <!-- Restore Interface (Hidden by default) -->
                    <div id="backup-list-container" class="hidden mt-4 theme-panel bg-white p-6 rounded-xl shadow-inner border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fas fa-history"></i> Restore Points (Cloud)</h4>
                        <div id="backup-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            <div class="text-center text-gray-400 py-4"><i class="fas fa-circle-notch fa-spin"></i> Loading backups...</div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="theme-panel bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover-lift">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><i class="fas fa-bullhorn text-blue-500"></i> Post Announcement</h3>
                        <div class="space-y-3">
                            <input id="gp-title" class="w-full border p-2 rounded text-sm bg-gray-50 focus:bg-white transition" placeholder="Title">
                            <textarea id="gp-content" class="w-full border p-2 rounded text-sm h-24 bg-gray-50 focus:bg-white transition" placeholder="Announcement body..."></textarea>
                            <select id="gp-type" class="w-full border p-2 rounded text-sm bg-gray-50" onchange="toggleAdminMedia()"><option value="text">Text Only</option><option value="image_upload">Image (Upload Poster)</option><option value="image_url">Image (URL)</option><option value="video">Video (YouTube)</option></select>
                            <input id="gp-url" class="w-full border p-2 rounded text-sm hidden" placeholder="Media URL...">
                            <div id="gp-file-container" class="hidden"><label class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"><input type="file" id="gp-file" accept="image/*" class="w-full"></label></div>
                            <button onclick="publishGlobalPost()" class="btn-theme w-full py-2 rounded font-bold hover:shadow-md transition">Publish</button>
                        </div>
                    </div>
                    <div class="theme-panel bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover-lift">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><i class="fas fa-calendar-plus text-purple-500"></i> Calendar Events</h3>
                        <div class="space-y-3">
                            <input id="ev-title" class="w-full border p-2 rounded text-sm bg-gray-50" placeholder="Event Title (e.g. Sports Fest)">
                            <input id="ev-date" type="date" class="w-full border p-2 rounded text-sm bg-gray-50">
                            <button onclick="addGlobalEvent()" class="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700 transition">Add Event</button>
                        </div>
                        <div class="mt-4 pt-4 border-t space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                            ${(db.globalEvents || []).map(e => `<div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded border border-gray-100"><span><b class="text-purple-700">${e.date}</b>: ${e.title}</span><button onclick="deleteGlobalEvent('${e.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`).join('')}
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <h3 class="font-bold text-gray-500 uppercase text-xs mb-4 tracking-wider">Active Global Posts</h3>
                    <div class="space-y-6">${(db.globalPosts || []).length === 0 ? '<div class="theme-panel p-8 text-center text-gray-400 italic">No active posts.</div>' : ''}${(db.globalPosts || []).map(p => renderPostCard(p, true)).join('')}</div>
                </div>
            </div>
        `;
        setTimeout(() => { const fileInput = document.getElementById('gp-file'); if(fileInput) { fileInput.addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(evt) { tempPostImage = evt.target.result; }; reader.readAsDataURL(file); } }); } }, 500); 
        return;
    }
    c.innerHTML = `<div class="max-w-4xl mx-auto"><div class="mb-6 flex items-center gap-3 p-4 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl text-white shadow-lg"><div class="bg-white/20 p-3 rounded-lg"><i class="fas fa-newspaper text-2xl"></i></div><div><h2 class="text-2xl font-bold">School News</h2><p class="text-blue-100 text-sm">Latest updates from the administration.</p></div></div><div class="space-y-6">${(db.globalPosts && db.globalPosts.length > 0) ? db.globalPosts.map(p => renderPostCard(p, false)).join('') : '<div class="theme-panel bg-white p-12 rounded-xl border border-dashed text-center text-gray-400"><i class="fas fa-inbox text-5xl mb-4 text-gray-200 block"></i>No announcements yet.</div>'}</div></div>`;
}

// --- BACKUP & RESTORE LOGIC ---
window.checkAutoBackup = async () => {
    const last = db.lastAutoBackup ? new Date(db.lastAutoBackup) : new Date(0);
    const now = new Date();
    const hoursSinceLast = (now - last) / (1000 * 60 * 60);
    
    if (hoursSinceLast > 24) {
        console.log("Running auto-backup...");
        await createCloudBackup(true); // true = silent/auto mode
    }
}

window.createCloudBackup = async (isAuto = false) => {
    const timestamp = new Date().toISOString();
    const backupId = `backup_${timestamp.replace(/[:.]/g, '-')}`;
    
    if(!isAuto) showToast('Creating cloud backup...', 'info');

    // Create a deep copy and mark it as a backup
    const backupData = JSON.parse(JSON.stringify(db));
    backupData.isBackup = true;
    backupData.backupDate = timestamp;

    const { error } = await supabase
        .from('app_data')
        .insert({
            id: backupId,
            data: backupData,
            updated_at: timestamp
        });

    if (error) {
        console.error('Backup failed:', error);
        if(!isAuto) showToast('Backup failed: ' + error.message, 'error');
    } else {
        // Update local state to remember we backed up
        db.lastAutoBackup = timestamp;
        await saveDB(); // Save this timestamp to the main record
        
        if(!isAuto) {
            showToast('Backup saved to cloud!', 'success');
            fetchBackupsList(); // Refresh UI
            $('last-backup-msg').innerText = `Last Auto-Backup: ${new Date(timestamp).toLocaleString()}`;
        }
    }
}

window.downloadLocalBackup = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", `LMS_Backup_${new Date().toISOString().slice(0,10)}.json`);
    document.body.appendChild(dlAnchorElem);
    dlAnchorElem.click();
    dlAnchorElem.remove();
    showToast('Download started');
}

window.fetchBackupsList = async () => {
    const listEl = $('backup-list');
    if(!listEl) return;
    
    // Select IDs that start with 'backup_'
    // Supabase JS doesn't support 'LIKE' easily on ID column in some versions, 
    // but we can just fetch all and filter client side if the table isn't huge, 
    // OR assuming standard 'app_data' table, we use a different strategy.
    // Better strategy: We only fetch the ID and updated_at to save bandwidth.
    
    const { data, error } = await supabase
        .from('app_data')
        .select('id, updated_at')
        .like('id', 'backup_%')
        .order('updated_at', { ascending: false })
        .limit(10); // Last 10 backups

    if (error) {
        listEl.innerHTML = '<div class="text-red-400 p-2">Failed to load backups.</div>';
        return;
    }

    if (!data || data.length === 0) {
        listEl.innerHTML = '<div class="text-gray-400 p-2 text-center italic">No backups found.</div>';
        return;
    }

    listEl.innerHTML = data.map(b => `
        <div class="flex justify-between items-center p-3 border rounded hover:bg-blue-50 transition group">
            <div>
                <div class="font-bold text-gray-700 text-sm">Backup: ${new Date(b.updated_at).toLocaleString()}</div>
                <div class="text-xs text-gray-400 font-mono">${b.id}</div>
            </div>
            <button onclick="restoreFromCloud('${b.id}')" class="text-xs bg-white border border-gray-300 text-blue-600 px-3 py-1 rounded font-bold hover:bg-blue-600 hover:text-white transition shadow-sm">
                Restore
            </button>
        </div>
    `).join('');
}

window.restoreFromCloud = async (backupId) => {
    showConfirm('⚠️ RESTORE DATABASE?\n\nThis will overwrite ALL current data with the selected backup. This cannot be undone immediately.', async () => {
        showToast('Restoring...', 'info');
        
        const { data, error } = await supabase
            .from('app_data')
            .select('data')
            .eq('id', backupId)
            .single();

        if (error || !data) {
            showToast('Failed to download backup.', 'error');
            return;
        }

        // Apply backup data
        db = data.data;
        // Ensure we keep the master record ID
        delete db.isBackup;
        delete db.backupDate;

        const success = await saveDB();
        if (success) {
            showToast('System Restored Successfully!', 'success');
            setTimeout(() => location.reload(), 1500); // Reload to ensure clean state
        }
    });
}

// --- COURSES ---
function renderCoursesList(c) {
    $('page-title').innerText = 'Courses';
    let subs = [];
    let filterHtml = '';
    if (currentUser.role === 'admin') {
        const teachers = db.users.filter(u => u.role === 'teacher');
        filterHtml = `<select onchange="setAdminFilter(this.value)" class="border p-2 rounded bg-white text-sm"><option value="all">All Teachers</option>${teachers.map(t => `<option value="${t.id}" ${adminCourseFilter===t.id?'selected':''}>${t.name}</option>`).join('')}</select>`;
        subs = adminCourseFilter === 'all' ? db.subjects : db.subjects.filter(s => s.teacherId === adminCourseFilter);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><div class="flex gap-2">${filterHtml}${currentUser.role==='teacher' ? `<button onclick="openAddCourseModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Course</button>` : ''}</div></div>`;
    } else if (currentUser.role === 'teacher') {
        subs = db.subjects.filter(s => s.teacherId === currentUser.id);
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3><button onclick="openAddCourseModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Course</button></div>`;
    } else {
        subs = db.subjects.filter(s => s.students.includes(currentUser.id));
        c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Active Courses</h3></div>`;
    }
    
    if(subs.length === 0) { c.innerHTML += `<div class="theme-panel bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-book-open text-4xl mb-3 block"></i><p>No courses found.</p></div>`; } else {
        c.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${subs.map(s => {
            const t = db.users.find(u => u.id === s.teacherId);
            const isOwner = (currentUser.role === 'admin') || (currentUser.role === 'teacher' && s.teacherId === currentUser.id);
            
            // Background style logic
            const bgStyle = s.img ? `background-image: url('${s.img}');` : `background-color: ${s.color};`;
            
            return `
            <div onclick="openCourse('${s.id}')" class="theme-panel course-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer h-64 flex flex-col group hover-lift">
                <div class="course-header relative bg-gray-200" style="${bgStyle} background-size: cover; background-position: center;">
                    ${isOwner ? `
                        <button onclick="event.stopPropagation(); triggerBannerUpload('${s.id}')" class="absolute top-2 right-2 bg-black/40 hover:bg-black/70 text-white w-8 h-8 rounded-full backdrop-blur-sm flex items-center justify-center transition opacity-0 group-hover:opacity-100 z-20 shadow-md hover:scale-110" title="Change Banner Image">
                            <i class="fas fa-camera text-xs"></i>
                        </button>
                    ` : ''}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent p-4 flex flex-col justify-end transition group-hover:from-black/90">
                        <span class="bg-white/20 backdrop-blur-md text-white border border-white/30 text-xs font-bold px-2 py-1 rounded w-max shadow-md mb-1" style="text-shadow: 0 1px 2px rgba(0,0,0,0.8);">${s.code}</span>
                        <h3 class="font-bold text-white text-lg leading-tight drop-shadow-md" style="text-shadow: 0 2px 4px rgba(0,0,0,0.9); letter-spacing: 0.5px;">${s.name}</h3>
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Instructor</p>
                        <div class="flex items-center gap-2">${renderAvatar(t, 'w-6 h-6', 'text-[10px]')} <span class="text-sm font-medium text-gray-700">${t ? t.name : 'Unknown'}</span></div>
                    </div>
                    <div class="flex items-center justify-between text-gray-400 text-xs border-t pt-3">
                        <span class="bg-gray-100 px-2 py-1 rounded text-gray-600"><i class="fas fa-users mr-1"></i> ${s.students.length} Students</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform text-gray-300 group-hover:text-theme"></i>
                    </div>
                </div>
            </div>`;
        }).join('')}</div>`;
    }
}

// --- BANNER UPLOAD LOGIC ---
let uploadingCourseId = null;

window.triggerBannerUpload = (sid) => {
    uploadingCourseId = sid;
    let input = $('course-banner-input');
    if (!input) {
        input = document.createElement('input');
        input.type = 'file';
        input.id = 'course-banner-input';
        input.accept = 'image/png, image/jpeg, image/gif, image/webp';
        input.style.display = 'none';
        document.body.appendChild(input);
        input.addEventListener('change', handleBannerSelect);
    }
    input.click();
}

window.handleBannerSelect = (e) => {
    const file = e.target.files[0];
    if (file && uploadingCourseId) {
        
        // 1. SPECIAL HANDLING FOR GIFS (To preserve animation)
        if (file.type === 'image/gif') {
            if (file.size > 2.5 * 1024 * 1024) { // Limit GIFs to 2.5MB to prevent DB errors
                showToast('GIF is too large (>2.5MB). Please use a smaller file.', 'error');
                e.target.value = '';
                uploadingCourseId = null;
                return;
            }
            showToast('Uploading GIF...', 'info');
            const reader = new FileReader();
            reader.onload = async function(evt) {
                await saveBannerToDB(evt.target.result);
            };
            reader.readAsDataURL(file);
            return;
        }

        // 2. COMPRESSION FOR STATIC IMAGES (JPEG, PNG)
        if (file.size > 5 * 1024 * 1024) {
             showToast('Large file detected. Compressing...', 'info');
        } else {
             showToast('Processing banner...', 'info');
        }

        const reader = new FileReader();
        reader.onload = function(evt) {
            const img = new Image();
            img.onload = async function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const MAX_WIDTH = 1024;
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compress to JPEG 0.7
                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                await saveBannerToDB(base64);
            }
            img.onerror = function() {
                showToast('Invalid image file.', 'error');
                uploadingCourseId = null;
            }
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// Helper to save banner
window.saveBannerToDB = async (base64) => {
    const courseIndex = db.subjects.findIndex(s => s.id === uploadingCourseId);
    if (courseIndex !== -1) {
        db.subjects[courseIndex].img = base64;
        
        showToast('Saving to cloud...', 'info');
        const success = await saveDB();
        if (success) {
            render();
            showToast('Course banner updated!');
        } else {
            showToast('Save failed. Image might be too large.', 'error');
        }
    }
    uploadingCourseId = null;
    const input = $('course-banner-input');
    if(input) input.value = '';
}

window.setAdminFilter = (val) => { adminCourseFilter = val; render(); }
window.openAddCourseModal = () => { renderModal('modal-add-course', 'Add Course', `<div class="space-y-3"><input id="c-name" class="w-full border p-2 rounded" placeholder="Course Name"><input id="c-code" class="w-full border p-2 rounded" placeholder="Course Code"><div><label class="text-xs font-bold text-gray-500">Select Teacher</label><select id="c-teacher" class="w-full border p-2 rounded bg-white text-sm">${db.users.filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select></div><button onclick="addCourse()" class="w-full btn-theme py-2 rounded">Create</button></div>`); }
window.addCourse = () => { const n=$('c-name').value, c=$('c-code').value; let tid=currentUser.id; if(currentUser.role==='admin') tid=$('c-teacher').value; if(n&&c){ db.subjects.push({id:'s'+Date.now(), name:n, code:c, teacherId:tid, students:[], color:'#0374B5', img:'', introTitle:'Welcome', introBody:'', gradingWeights:{ww:40,pt:40,qa:20}}); saveDB(); render(); closeModal('modal-add-course'); } }
window.openCourse = (sid) => { currentCourseId = sid; currentView = 'course'; currentTab = 'home'; render(); }
// --- CALENDAR ---
function renderCalendar(c) {
    $('page-title').innerText = 'Calendar';
    const year=calendarDate.getFullYear(), month=calendarDate.getMonth();
    const firstDay=new Date(year,month,1).getDay(), days=new Date(year,month+1,0).getDate();
    let html = `<div class="theme-panel bg-white p-4 rounded shadow mb-4 flex justify-between"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><h2 class="font-bold text-xl">${calendarDate.toLocaleString('default',{month:'long'})} ${year}</h2><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div>`;
    html += `<div class="calendar-grid">${['S','M','T','W','T','F','S'].map(d=>`<div class="bg-gray-50 p-2 text-center text-xs font-bold">${d}</div>`).join('')}`;
    for(let i=0; i<firstDay; i++) html+=`<div class="cal-cell bg-gray-50/50"></div>`;
    for(let d=1; d<=days; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const monthDay = `${month+1}-${d}`; // For simple holiday check
        let evts = '';
        
        // 1. Check Philippine Holidays
        const hol = phHolidays.find(h => (h.m === month && h.d === d));
        if(hol) evts += `<div class="event-pill text-white font-bold" style="background:${hol.c || 'red'}">🇵🇭 ${hol.t}</div>`;

        // 2. Check Admin Global Events
        (db.globalEvents || []).forEach(e => {
            if(e.date === dateStr) evts += `<div class="event-pill bg-purple-600 text-white font-bold">${e.title}</div>`;
        });

        // 3. Check Course Events
        db.subjects.forEach(s => {
            if(currentUser.role==='student' && !s.students.includes(currentUser.id)) return;
            if(currentUser.role==='teacher' && s.teacherId!==currentUser.id) return;
            (db.exams[s.id]||[]).forEach(e => { 
                if(e.dueDate.startsWith(dateStr)) 
                    evts += `<div onclick="goToEvent('${s.id}', 'quizzes', '${e.id}', 'exam')" class="event-pill cursor-pointer hover:opacity-80" style="background:${s.color};color:white">Due: ${e.title}</div>`; 
            });
            (db.activities[s.id]||[]).forEach(a => { 
                if(a.dueDate && a.dueDate.startsWith(dateStr)) 
                    evts += `<div onclick="goToEvent('${s.id}', 'activities', '${a.id}', 'activity')" class="event-pill border border-gray-400 text-gray-600 bg-white cursor-pointer hover:bg-gray-50">Task: ${a.title}</div>`; 
            });
        });
        html += `<div class="cal-cell">${d}<div class="flex flex-col gap-1 mt-1">${evts}</div></div>`;
    }
    html += `</div>`; c.innerHTML = html;
}
window.changeMonth = (d) => { calendarDate.setMonth(calendarDate.getMonth()+d); render(); }
window.addGlobalEvent = () => {
    const t = $('ev-title').value, d = $('ev-date').value;
    if(t && d) {
        if(!db.globalEvents) db.globalEvents = [];
        db.globalEvents.push({ id: 'ev'+Date.now(), title: t, date: d });
        saveDB(); render(); showToast('Event Added');
    } else showToast('Title and Date required', 'error');
}
window.deleteGlobalEvent = (id) => {
    db.globalEvents = db.globalEvents.filter(e => e.id !== id);
    saveDB(); render();
}

// --- ADMIN THEME BUILDER ---
function renderThemeBuilder(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    $('page-title').innerText = 'Theme & Design';
    const t = db.theme;
    
    c.innerHTML = `
        <div class="max-w-4xl mx-auto theme-panel bg-white p-8 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Customize Interface</h2>
                    <p class="text-gray-500 text-sm">Personalize the look and feel of your LMS.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetTheme()" class="px-4 py-2 border rounded hover:bg-gray-50 transition">Reset Default</button>
                    <button onclick="saveTheme()" class="btn-theme px-6 py-2 font-bold rounded shadow hover:shadow-lg transform hover:-translate-y-0.5 transition">Save Changes</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <!-- Branding -->
                <div class="space-y-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-tag text-blue-500"></i> Branding</h3>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2">App Name</label>
                        <input id="theme-name" value="${t.appName}" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-gray-50 focus:bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2">Logo</label>
                        <div class="flex items-center gap-4 p-4 border rounded-lg bg-gray-50">
                            <div id="logo-preview-box" class="w-16 h-16 border rounded bg-white flex items-center justify-center overflow-hidden shadow-sm">
                                ${t.logoUrl ? `<img src="${t.logoUrl}" class="w-full h-full object-contain">` : '<span class="text-xs text-gray-400">No Logo</span>'}
                            </div>
                            <div class="flex-1">
                                <input type="file" id="theme-logo-file" accept="image/*" onchange="handleLogoUpload(this)" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                                <input type="hidden" id="theme-logo-url" value="${t.logoUrl || ''}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Colors -->
                <div class="space-y-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-swatchbook text-pink-500"></i> Global Colors</h3>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Global Border</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="global-border-color" value="${t.borderColor||'#e2e8f0'}" oninput="previewTheme()" class="h-8 w-full rounded border cursor-pointer p-0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Primary Accent (Links/Icons)</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="accent-color" value="${t.accentColor || '#0374B5'}" oninput="previewTheme()" class="h-8 w-full rounded border cursor-pointer p-0">
                        </div>
                    </div>
                </div>

                <!-- Header Customization -->
                <div class="space-y-6 md:col-span-2 border-t pt-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-heading text-purple-500"></i> Header</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded border">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Background</label>
                            <div class="flex gap-4 mb-3">
                                <label class="flex items-center gap-2 text-xs font-bold cursor-pointer"><input type="radio" name="header-type" value="solid" ${t.headerType!=='gradient'?'checked':''} onclick="toggleHeaderInput(); previewTheme()"> Solid</label>
                                <label class="flex items-center gap-2 text-xs font-bold cursor-pointer"><input type="radio" name="header-type" value="gradient" ${t.headerType==='gradient'?'checked':''} onclick="toggleHeaderInput(); previewTheme()"> Gradient</label>
                            </div>
                            <div id="header-solid-input" class="${t.headerType==='gradient'?'hidden':''}"><input type="color" id="header-color" value="${t.headerColor||'#ffffff'}" oninput="previewTheme()" class="w-full h-8 cursor-pointer rounded border"></div>
                            <div id="header-gradient-input" class="${t.headerType!=='gradient'?'hidden':''}">
                                <div id="header-grad-stops" class="space-y-2 mb-2"></div>
                                <div class="flex gap-2 mb-2"><button onclick="addGradStop('header')" class="text-xs border px-2 rounded bg-white">Add Color</button><button onclick="removeGradStop('header')" class="text-xs border px-2 rounded bg-white text-red-500">Remove</button></div>
                                <select id="header-grad-angle" onchange="previewTheme()" class="w-full text-xs border p-1 rounded"><option value="to right">Horizontal →</option><option value="to bottom">Vertical ↓</option><option value="135deg">Diagonal ↘</option></select>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Text Style</label>
                            <div class="flex gap-4 items-center mb-4">
                                <div class="flex-1">
                                    <span class="text-xs text-gray-400 block mb-1">Color</span>
                                    <input type="color" id="header-text-color" value="${t.headerTextColor||'#2D3B45'}" oninput="previewTheme()" class="w-full h-8 rounded border cursor-pointer p-0">
                                </div>
                                <div class="flex-1">
                                    <span class="text-xs text-gray-400 block mb-1">Text Shadow</span>
                                    <select id="header-shadow" onchange="previewTheme()" class="w-full border p-1 h-8 rounded text-xs">
                                        <option value="none">None</option>
                                        <option value="0 1px 2px rgba(0,0,0,0.1)">Subtle</option>
                                        <option value="0 2px 4px rgba(0,0,0,0.3)">Medium</option>
                                        <option value="0 4px 8px rgba(0,0,0,0.5)">Strong Lift</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons Customization -->
                <div class="space-y-6 md:col-span-2 border-t pt-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-mouse-pointer text-blue-500"></i> Buttons</h3>
                    <div class="bg-gray-50 p-4 rounded border">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Button Background</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center gap-2 text-xs font-bold cursor-pointer"><input type="radio" name="btn-type" value="solid" ${t.btnType!=='gradient'?'checked':''} onclick="toggleBtnInput(); previewTheme()"> Solid (Uses Primary)</label>
                            <label class="flex items-center gap-2 text-xs font-bold cursor-pointer"><input type="radio" name="btn-type" value="gradient" ${t.btnType==='gradient'?'checked':''} onclick="toggleBtnInput(); previewTheme()"> Gradient</label>
                        </div>
                        <div id="btn-gradient-input" class="${t.btnType!=='gradient'?'hidden':''}">
                            <div id="btn-grad-stops" class="space-y-2 mb-2"></div>
                            <div class="flex gap-2 mb-2"><button onclick="addGradStop('btn')" class="text-xs border px-2 rounded bg-white">Add Color</button><button onclick="removeGradStop('btn')" class="text-xs border px-2 rounded bg-white text-red-500">Remove</button></div>
                            <select id="btn-grad-angle" onchange="previewTheme()" class="w-full text-xs border p-1 rounded"><option value="to right">Horizontal →</option><option value="to bottom">Vertical ↓</option><option value="135deg">Diagonal ↘</option></select>
                        </div>
                    </div>
                </div>

                <!-- Main Background -->
                <div class="space-y-6 md:col-span-2 border-t pt-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-image text-green-500"></i> Page Background</h3>
                    <div class="bg-gray-50 p-4 rounded border">
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer text-xs font-bold"><input type="radio" name="bg-type" value="color" ${t.bgType==='color'?'checked':''} onclick="toggleBgInput(); previewTheme()"> Solid</label>
                            <label class="flex items-center gap-2 cursor-pointer text-xs font-bold"><input type="radio" name="bg-type" value="gradient" ${t.bgType==='gradient'?'checked':''} onclick="toggleBgInput(); previewTheme()"> Gradient</label>
                            <label class="flex items-center gap-2 cursor-pointer text-xs font-bold"><input type="radio" name="bg-type" value="image" ${t.bgType==='image'?'checked':''} onclick="toggleBgInput(); previewTheme()"> Image</label>
                        </div>
                        <div id="bg-input-color" class="${t.bgType!=='color'?'hidden':''}"><input type="color" id="theme-bgcolor" value="${t.bgColor}" oninput="previewTheme()" class="h-10 w-full cursor-pointer rounded border p-0"></div>
                        <div id="bg-input-gradient" class="${t.bgType!=='gradient'?'hidden':''}">
                            <div id="bg-grad-stops" class="space-y-2 mb-2"></div>
                            <div class="flex gap-2 mb-2"><button onclick="addGradStop('bg')" class="text-xs border px-2 rounded bg-white">Add Color</button><button onclick="removeGradStop('bg')" class="text-xs border px-2 rounded bg-white text-red-500">Remove</button></div>
                            <select id="bg-grad-angle" onchange="previewTheme()" class="w-full text-xs border p-1 rounded"><option value="to right">Horizontal →</option><option value="to bottom">Vertical ↓</option><option value="135deg">Diagonal ↘</option></select>
                        </div>
                        <div id="bg-input-image" class="${t.bgType!=='image'?'hidden':''}"><input type="text" id="theme-bgimage" value="${t.bgImage}" oninput="previewTheme()" class="w-full border p-2 rounded text-sm mb-2" placeholder="Image URL"><input type="file" id="theme-bgfile" accept="image/*" class="text-sm"></div>
                    </div>
                </div>

                <!-- Glass Effect (Missing in previous code) -->
                <div class="space-y-6 md:col-span-2 border-t pt-6">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-magic text-blue-400"></i> Glassmorphism</h3>
                    <div class="bg-gray-50 p-4 rounded border flex items-center gap-6">
                        <label class="flex items-center gap-2 font-bold text-gray-700 cursor-pointer">
                            <input type="checkbox" id="theme-glass" ${t.glassEffect ? 'checked' : ''} onchange="previewTheme()" class="w-5 h-5 text-blue-600 rounded">
                            Enable Glass Effect
                        </label>
                        <div class="flex-1 flex items-center gap-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Opacity</label>
                            <input type="range" id="theme-opacity" min="0.5" max="0.95" step="0.05" value="${t.glassOpacity || 0.9}" oninput="previewTheme()" class="w-full">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Initialize State
    initAllGradientBuilders();
    
    // BG Image File Handler
    setTimeout(() => {
        const bgFile = $('theme-bgfile');
        if(bgFile) bgFile.addEventListener('change', e => {
            const f = e.target.files[0]; if(f) { const r=new FileReader(); r.onload=ev=>{$('theme-bgimage').value=ev.target.result; previewTheme();}; r.readAsDataURL(f); }
        });
    }, 100);
}

// Fixed Logo Upload Handler
window.handleLogoUpload = (input) => {
    const f = input.files[0];
    if(f) {
        const r = new FileReader();
        r.onload = ev => {
            const url = ev.target.result;
            $('theme-logo-url').value = url;
            $('logo-preview-box').innerHTML = `<img src="${url}" class="w-full h-full object-contain">`;
        };
        r.readAsDataURL(f);
    }
}

// ... (Rest of theme logic: toggleHeaderInput, toggleBtnInput, toggleBgInput, previewTheme, etc.) ...
// ... (Including gradState, parseGradient, initAllGradientBuilders, renderGradientUI, updateGradState, addGradStop, removeGradStop, constructGradient) ...

window.toggleHeaderInput = () => {
    const type = document.querySelector('input[name="header-type"]:checked').value;
    $('header-solid-input').classList.toggle('hidden', type !== 'solid');
    $('header-gradient-input').classList.toggle('hidden', type !== 'gradient');
}
window.toggleBtnInput = () => {
    const type = document.querySelector('input[name="btn-type"]:checked').value;
    $('btn-gradient-input').classList.toggle('hidden', type !== 'gradient');
}
window.toggleBgInput = () => {
    const type = document.querySelector('input[name="bg-type"]:checked').value;
    $('bg-input-color').classList.toggle('hidden', type!=='color');
    $('bg-input-gradient').classList.toggle('hidden', type!=='gradient');
    $('bg-input-image').classList.toggle('hidden', type!=='image');
    
    if(type === 'gradient') initGradientBuilder();
}

window.previewTheme = () => {
    const root = document.documentElement;
    
    // Global Border
    const border = $('global-border-color').value;
    if(border) root.style.setProperty('--global-border-color', border);

    // Accent
    const accent = $('accent-color').value;
    if(accent) {
        root.style.setProperty('--accent-color', accent);
        root.style.setProperty('--nav-item-active-bg', `rgba(${hexToRgb(accent)}, 0.1)`);
    }

    // Header BG
    const headerType = document.querySelector('input[name="header-type"]:checked').value;
    if(headerType === 'solid') root.style.setProperty('--header-bg', $('header-color').value);
    else root.style.setProperty('--header-bg', constructGradient('header'));

    // Header Text & Shadow
    root.style.setProperty('--header-text', $('header-text-color').value);
    root.style.setProperty('--header-shadow', $('header-shadow').value);

    // Buttons
    const btnType = document.querySelector('input[name="btn-type"]:checked').value;
    if(btnType === 'solid') root.style.setProperty('--btn-bg', $('accent-color').value);
    else root.style.setProperty('--btn-bg', constructGradient('btn'));

    // Main BG
    const bgType = document.querySelector('input[name="bg-type"]:checked').value;
    if(bgType === 'color') root.style.setProperty('--bg-style', $('theme-bgcolor').value);
    else if (bgType === 'gradient') root.style.setProperty('--bg-style', constructGradient('bg'));
    else if (bgType === 'image') root.style.setProperty('--bg-style', `url('${$('theme-bgimage').value}')`);

    // Glass
    const glassEl = $('theme-glass');
    const opacityEl = $('theme-opacity');
    
    if (glassEl && opacityEl) {
        const glass = glassEl.checked;
        const opacity = opacityEl.value;
        if (glass) {
            root.style.setProperty('--glass-bg', `rgba(255, 255, 255, ${opacity})`);
            root.style.setProperty('--backdrop-blur', 'blur(16px)');
            root.style.setProperty('--sidebar-bg', `rgba(255, 255, 255, ${Math.max(0.5, opacity - 0.1)})`);
        } else {
            root.style.setProperty('--glass-bg', '#ffffff');
            root.style.setProperty('--backdrop-blur', 'none');
            root.style.setProperty('--sidebar-bg', '#ffffff');
        }
    }
}

window.gradState = { bg: [], header: [], btn: [] }; // Reset structure

window.parseGradient = (css, fallback) => {
    const matches = css ? css.match(/#[a-fA-F0-9]{6}/g) : null;
    return (matches && matches.length >= 2) ? matches : fallback;
}

window.initAllGradientBuilders = () => {
    const t = db.theme;
    // Main BG
    window.gradState.bg = parseGradient(t.bgGradient, ['#ffffff', '#e2e8f0']);
    const bgDir = t.bgGradient && t.bgGradient.includes('(') ? t.bgGradient.split('(')[1].split(',')[0].trim() : '135deg';
    if($('bg-grad-angle')) $('bg-grad-angle').value = bgDir.includes('#') ? '135deg' : bgDir; 
    
    // Header
    window.gradState.header = parseGradient(t.headerGradient, ['#ffffff', '#f3f4f6']);
    if($('header-grad-angle')) $('header-grad-angle').value = t.hGradDir || 'to right';
    if($('header-shadow')) $('header-shadow').value = t.headerShadow || 'none';

    // Buttons
    window.gradState.btn = parseGradient(t.btnGradient, ['#0374B5', '#00C6FF']);
    if($('btn-grad-angle')) $('btn-grad-angle').value = 'to right'; 

    renderGradientUI('bg');
    renderGradientUI('header');
    renderGradientUI('btn');
}

window.renderGradientUI = (type) => {
    const c = $(`${type}-grad-stops`);
    if(!c) return;
    c.innerHTML = window.gradState[type].map((col, i) => `
        <div class="flex items-center gap-2">
            <input type="color" value="${col}" oninput="updateGradState('${type}', ${i}, this.value)" class="h-8 w-10 p-0 border-0 cursor-pointer rounded">
            <span class="text-xs text-gray-400">Color ${i+1}</span>
        </div>
    `).join('');
}

window.updateGradState = (type, i, val) => {
    window.gradState[type][i] = val;
    previewTheme();
}

window.addGradStop = (type) => {
    const last = window.gradState[type][window.gradState[type].length-1];
    window.gradState[type].push(last);
    renderGradientUI(type);
    previewTheme();
}

window.removeGradStop = (type) => {
    if(window.gradState[type].length > 2) {
        window.gradState[type].pop();
        renderGradientUI(type);
        previewTheme();
    } else { showToast('Min 2 colors', 'error'); }
}

window.constructGradient = (type) => {
    const dir = $(`${type}-grad-angle`).value;
    const colors = window.gradState[type].join(', ');
    return `linear-gradient(${dir}, ${colors})`;
}

window.saveTheme = async () => {
    try {
        const bgType = document.querySelector('input[name="bg-type"]:checked').value;
        const headerType = document.querySelector('input[name="header-type"]:checked').value;
        const btnType = document.querySelector('input[name="btn-type"]:checked').value;
        
        // Safety check for elements
        const glassEl = $('theme-glass');
        const opacityEl = $('theme-opacity');

        db.theme = {
            appName: $('theme-name').value,
            logoUrl: $('theme-logo-url').value,
            
            // Colors
            borderColor: $('global-border-color').value,
            accentColor: $('accent-color').value,

            // Header
            headerType: headerType,
            headerColor: $('header-color').value,
            headerGradient: constructGradient('header'),
            hGradDir: $('header-grad-angle').value,
            headerTextColor: $('header-text-color').value,
            headerShadow: $('header-shadow').value,

            // Buttons
            btnType: btnType,
            btnGradient: constructGradient('btn'),

            // BG
            bgType: bgType,
            bgColor: $('theme-bgcolor').value,
            bgGradient: constructGradient('bg'),
            bgImage: $('theme-bgimage').value,
            
            // Glass - Use defaults if elements missing
            glassEffect: glassEl ? glassEl.checked : false,
            glassOpacity: opacityEl ? opacityEl.value : 0.9
        };
        
        // Optimistic Update
        applyTheme();
        showToast('Theme Updated');
        
        // Background Save
        saveDB(); 
    } catch (e) {
        console.error(e);
        showToast('Error saving theme: ' + e.message, 'error');
    }
}
window.publishPost = () => { 
    const c=$('post-content').value, t=$('post-type').value; 
    let u=$('post-url').value; 
    if(t==='image_upload') u=tempTeacherImage; 
    
    if(c||u) { 
        if(!db.posts) db.posts=[]; 
        db.posts.push({
            id:'p'+Date.now(), 
            courseId:currentCourseId, 
            authorId:currentUser.id, 
            authorName:currentUser.name, 
            date:new Date().toISOString(), 
            content:c, 
            mediaType:t, 
            mediaUrl:u, 
            isPinned:false
        }); 
        
        tempTeacherImage=null; 
        
        // Optimistic Render
        render(); 
        
        // Background Save
        saveDB(); 
    } 
}
// --- UPDATED MODULE BUILDER (Optimistic Save) ---
window.saveModule = async () => {
    const title = $('mod-title').value;
    const unlockDate = $('mod-unlock').value;
    if (!title) return showToast('Please enter a module title', 'error');

    const moduleData = {
        id: editingModuleId || 'mod_' + Date.now(),
        title: title,
        courseId: currentCourseId,
        unlockDate: unlockDate, // Save the scheduled date
        blocks: [...builderBlocks], 
        date: new Date().toISOString() 
    };

    // Ensure the array exists for this specific course
    if (!db.modules[currentCourseId]) db.modules[currentCourseId] = [];

    // Logic to Update or Add
    if (editingModuleId) {
        const idx = db.modules[currentCourseId].findIndex(m => m.id === editingModuleId);
        if(idx !== -1) db.modules[currentCourseId][idx] = moduleData;
    } else {
        db.modules[currentCourseId].push(moduleData);
    }

    // Optimistic Update: Switch view immediately
    showToast('Module Saved');
    goCourse(currentCourseId); 
    
    // Background Sync
    saveDB().then(success => {
        if (!success) showToast('Sync warning: Data saved locally but cloud update failed.', 'warning');
    });
};

// --- UPDATED ACTIVITY BUILDER (Optimistic Save) ---
window.publishActivity = async () => {
    // This function seems duplicate or deprecated by saveActivityBuilt, 
    // ensuring consistency with saveActivityBuilt logic below
    window.saveActivityBuilt();
};

window.createActivity = () => { builderBlocks = []; editingActivityId = null; currentView = 'activity_builder'; render(); }
window.editActivity = (aid) => { const a = db.activities[currentCourseId].find(x=>x.id===aid); builderBlocks = JSON.parse(JSON.stringify(a.blocks || [])); editingActivityId = aid; currentView = 'activity_builder'; render(); }
window.cancelActivity = () => { currentView = 'course'; render(); }

// Optimistic Activity Save
window.saveActivityBuilt = async () => {
    const t=$('act-build-title').value, max=parseInt($('act-build-max').value), cat=$('act-build-cat').value, start=$('act-build-start').value, due=$('act-build-due').value;
    const subText = $('sub-opt-text').checked, subFile = $('sub-opt-file').checked;
    
    if(!t) return showToast('Title required', 'error');

    if(!db.activities[currentCourseId]) db.activities[currentCourseId] = [];
    
    const actData = {
        id: editingActivityId || 'a'+Date.now(), 
        title: t, 
        maxScore: max, 
        category: cat, 
        openDate: start ? new Date(start).toISOString() : null, 
        dueDate: due ? new Date(due).toISOString() : null,
        blocks: [...builderBlocks], 
        submissionOptions: { text: subText, file: subFile },
        date: new Date().toISOString(),
        courseId: currentCourseId
    };
    
    if(editingActivityId) { 
        const idx = db.activities[currentCourseId].findIndex(a=>a.id===editingActivityId); 
        db.activities[currentCourseId][idx] = actData; 
    } else { 
        db.activities[currentCourseId].push(actData); 
    }
    
    // Optimistic UI Update
    showToast('Activity Saved');
    currentView = 'course'; 
    render();
    
    // Background Sync
    saveDB();
}
window.openExamDetail = (eid) => {
    const s = db.subjects.find(x => x.id === currentCourseId);
    const ex = db.exams[s.id].find(e => e.id === eid);
    if(currentUser.role !== 'student') { openCreateModal(eid); return; }
    const sub = db.examSubmissions[eid]?.[currentUser.id];
    const attemptsAllowed = ex.attempts || 1, attemptsTaken = sub ? (sub.attemptsTaken || 0) : 0, isAttemptLocked = attemptsTaken >= attemptsAllowed;
    const now = new Date(), openDate = new Date(ex.openDate), dueDate = new Date(ex.dueDate), isUpcoming = now < openDate, isClosed = now > dueDate;
    let actionBtn = '', statusMsg = '';
    if (isUpcoming) { statusMsg = `<div class="bg-yellow-50 text-yellow-800 p-3 rounded mb-4 text-center font-bold">Opens: ${openDate.toLocaleString()}</div>`; actionBtn = `<button disabled class="w-full bg-gray-300 text-gray-500 py-2 rounded font-bold cursor-not-allowed">Not Open Yet</button>`; } 
    else if (isClosed && !sub) { statusMsg = `<div class="bg-red-50 text-red-800 p-3 rounded mb-4 text-center font-bold">Closed on ${dueDate.toLocaleString()}</div>`; actionBtn = `<button disabled class="w-full bg-gray-300 text-gray-500 py-2 rounded font-bold cursor-not-allowed">Missed</button>`; } 
    else if (isAttemptLocked || (isClosed && sub)) { statusMsg = `<div class="bg-blue-50 text-blue-800 p-3 rounded mb-4 text-center font-bold">Completed (Score: ${sub.score}%)</div>`; actionBtn = `<button onclick="closeModal('exam-detail'); reviewExam('${ex.id}')" class="btn-theme w-full text-white py-2 rounded font-bold hover:bg-blue-700">Review Results</button>`; } 
    else { statusMsg = `<div class="bg-green-50 text-green-800 p-3 rounded mb-4 text-center font-bold">Open until ${dueDate.toLocaleString()}</div>`; actionBtn = `<button onclick="closeModal('exam-detail'); startExam('${ex.id}')" class="btn-theme w-full text-white py-2 rounded font-bold hover:bg-blue-600">Start Quiz</button>`; }
    renderModal('exam-detail', ex.title, `<div class="space-y-4">${statusMsg}<div class="grid grid-cols-2 gap-4 text-sm text-gray-600"><div class="border p-2 rounded text-center"><span class="block font-bold text-gray-800">Time Limit</span>${ex.timeLimit} Mins</div><div class="border p-2 rounded text-center"><span class="block font-bold text-gray-800">Attempts</span>${attemptsTaken} / ${attemptsAllowed}</div><div class="border p-2 rounded text-center"><span class="block font-bold text-gray-800">Questions</span>${ex.questions.length} Items</div><div class="border p-2 rounded text-center"><span class="block font-bold text-gray-800">Type</span>${ex.category === 'qa' ? 'Quarterly' : 'Written Work'}</div></div><div class="pt-4">${actionBtn}</div></div>`);
}

// --- TEACHERS & SETTINGS ---
function renderTeachersList(c) {
    if(currentUser.role !== 'admin') return goDashboard();
    $('page-title').innerText = 'Teachers Directory';
    const teachers = db.users.filter(u => u.role === 'teacher').sort((a,b) => b.id.localeCompare(a.id));
    c.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 text-lg">Registered Teachers (${teachers.length})</h3><button onclick="openRegisterTeacherModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>Register New Teacher</button></div><div class="theme-panel bg-white border rounded shadow-sm overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b"><tr><th class="p-4">Name</th><th class="p-4">Username</th><th class="p-4">Password</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-gray-100">${teachers.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">No teachers found.</td></tr>' : ''}${teachers.map(t => `<tr class="hover:bg-gray-50"><td class="p-4 font-bold text-gray-800 flex items-center gap-3">${renderAvatar(t, 'w-8 h-8', 'text-xs')}${t.name}</td><td class="p-4 font-mono text-gray-600">${t.username}</td><td class="p-4 font-mono text-gray-400 text-xs">${t.password}</td><td class="p-4"><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Active</span></td><td class="p-4 text-right"><button onclick="deleteUser('${t.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderSettings(c) {
    $('page-title').innerText = 'Account Settings';
    let html = `<div class="max-w-2xl mx-auto space-y-8"><div class="theme-panel bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Profile Picture</h3><div class="flex items-center gap-4"><div id="settings-avatar-preview">${renderAvatar(currentUser, 'w-16 h-16', 'text-2xl')}</div><div class="flex-1"><input type="file" id="profile-pic-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><p class="text-xs text-gray-400 mt-1">Recommended: Square JPG/PNG</p></div><button onclick="saveProfilePic()" class="btn-theme px-4 py-2 rounded font-bold text-sm">Upload</button></div></div><div class="theme-panel bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Security</h3><div class="space-y-4"><div><label class="block text-sm font-bold text-gray-500 mb-1">New Password</label><input type="password" id="set-new-pass" class="w-full border p-2 rounded" placeholder="Enter new password"></div><button onclick="updatePassword()" class="btn-theme px-4 py-2 rounded font-bold text-sm">Update Password</button></div></div>`;
    if(currentUser.role === 'teacher') {
        const myCourses = db.subjects.filter(s => s.teacherId === currentUser.id);
        html += `<div class="theme-panel bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">My Course Details</h3><div class="space-y-4">${myCourses.map(s => `<div class="border rounded p-4 bg-gray-50"><h4 class="font-bold text-canvas-accent mb-2">${s.name} (${s.code})</h4><div class="grid grid-cols-2 gap-2 mb-2"><input id="edit-name-${s.id}" value="${s.name}" class="border p-1 rounded text-sm" placeholder="Name"><input id="edit-code-${s.id}" value="${s.code}" class="border p-1 rounded text-sm" placeholder="Code"></div><input id="edit-intro-${s.id}" value="${s.introTitle || ''}" class="w-full border p-1 rounded text-sm mb-2" placeholder="Intro Title"><button onclick="updateCourseDetails('${s.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Save Changes</button></div>`).join('')}</div></div>`;
    }
    html += `</div>`;
    c.innerHTML = html;
}
window.deleteUser = (uid) => { showConfirm('Delete user?', () => { db.users = db.users.filter(u => u.id !== uid); saveDB(); render(); }); }
window.saveProfilePic = () => { const f=$('profile-pic-upload').files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ const u=db.users.find(x=>x.id===currentUser.id); if(u){ u.avatar=e.target.result; saveDB(); render(); }}; r.readAsDataURL(f); } }
window.updatePassword = () => { const p=$('set-new-pass').value; if(p){ const u=db.users.find(x=>x.id===currentUser.id); u.password=p; saveDB(); showToast('Password updated'); } }
window.updateCourseDetails = (sid) => { const s=db.subjects.find(x=>x.id===sid); s.name=$(`edit-name-${sid}`).value; s.code=$(`edit-code-${sid}`).value; s.introTitle=$(`edit-intro-${sid}`).value; saveDB(); }
window.registerTeacher = () => { const n=$('reg-t-name').value, u=$('reg-t-user').value, p=$('reg-t-pass').value; if(n&&u&&p){ db.users.push({id:'u'+Date.now(), name:n, username:u, password:p, role:'teacher'}); saveDB(); render(); closeModal('modal-reg-teacher'); showToast('Teacher registered successfully!'); } else { showToast('Please fill in all fields', 'error'); } }
window.registerStudent = () => { const n=$('reg-s-name').value, u=$('reg-s-user').value, p=$('reg-s-pass').value; if(n&&u&&p){ const newId='u'+Date.now(); db.users.push({id:newId, name:n, username:u, password:p, role:'student'}); if(currentCourseId){ const s=db.subjects.find(x=>x.id===currentCourseId); if(s)s.students.push(newId); } saveDB(); render(); closeModal('modal-reg-student'); }}
window.openRegisterStudentModal = () => { renderModal('modal-reg-student', 'Register New Student', `<div class="space-y-3"><input id="reg-s-name" class="w-full border p-2 rounded" placeholder="Full Name"><input id="reg-s-user" class="w-full border p-2 rounded" placeholder="Username"><input id="reg-s-pass" class="w-full border p-2 rounded" placeholder="Password"><button onclick="registerStudent()" class="btn-theme w-full text-white py-2 rounded font-bold">Register & Enroll</button></div>`); }
window.openRegisterTeacherModal = () => { renderModal('modal-reg-teacher', 'Register New Teacher', `<div class="space-y-3"><input id="reg-t-name" class="w-full border p-2 rounded" placeholder="Full Name"><input id="reg-t-user" class="w-full border p-2 rounded" placeholder="Username"><input id="reg-t-pass" class="w-full border p-2 rounded" placeholder="Password"><button onclick="registerTeacher()" class="btn-theme w-full text-white py-2 rounded font-bold">Register Teacher</button></div>`); }
window.openAddStudentModal = () => { const s = db.subjects.find(x => x.id === currentCourseId); const availableStudents = db.users.filter(u => u.role === 'student' && !s.students.includes(u.id)); let content = ''; if(availableStudents.length === 0) { content = '<p class="text-gray-500 italic">No existing students available to enroll.</p>'; } else { content = `<div class="space-y-2 max-h-60 overflow-y-auto">${availableStudents.map(u => `<div class="flex justify-between items-center p-2 border rounded hover:bg-gray-50"><div class="flex items-center gap-2">${renderAvatar(u, 'w-6 h-6', 'text-xs')} <span>${u.name}</span></div><button onclick="enrollExistingStudent('${u.id}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">Add</button></div>`).join('')}</div>`; } renderModal('modal-enroll-student', 'Enroll Existing Student', content); }
window.enrollExistingStudent = (uid) => { const s = db.subjects.find(x => x.id === currentCourseId); if(s && !s.students.includes(uid)) { s.students.push(uid); saveDB(); render(); showToast('Student Enrolled'); closeModal('modal-enroll-student'); } }

// --- COURSE TABS IMPLEMENTATION ---
function renderCourse(c) {
    const s = db.subjects.find(x => x.id === currentCourseId);
    if(!s) return goDashboard();
    $('page-title').innerText = s.name;
    c.innerHTML = `<div class="flex flex-col md:flex-row gap-6 h-full"><nav class="theme-panel w-full md:w-48 flex-shrink-0 flex md:flex-col gap-1 text-sm font-medium text-canvas-primary border-r border-gray-200 pb-4 md:pr-4"><a onclick="switchTab('home')" class="${currentTab==='home'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Home</a><a onclick="switchTab('modules')" class="${currentTab==='modules'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Modules</a><a onclick="switchTab('activities')" class="${currentTab==='activities'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Activities</a><a onclick="switchTab('quizzes')" class="${currentTab==='quizzes'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Quizzes/Exams</a><a onclick="switchTab('grades')" class="${currentTab==='grades'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">Grades</a><a onclick="switchTab('people')" class="${currentTab==='people'?'border-l-4 border-canvas-base font-bold pl-2':''} p-2 cursor-pointer hover:bg-gray-100 block">People</a></nav><div id="course-content" class="flex-1"></div></div>`;
    renderCourseTab();
}
window.switchTab = (t) => { currentTab=t; render(); }

function renderCourseTab() {
    const c=$('course-content'), s=db.subjects.find(x=>x.id===currentCourseId), isTeacher=currentUser.role==='teacher'||currentUser.role==='admin';
    
    // HOME (FEED)
    if(currentTab === 'home') {
        const posts = (db.posts||[]).filter(p=>p.courseId===s.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
        c.innerHTML = `<div class="theme-panel bg-white p-6 rounded border border-gray-200 mb-6 relative group">${isTeacher ? `<button onclick="editIntro()" class="absolute top-4 right-4 text-gray-400 hover:text-canvas-accent"><i class="fas fa-edit"></i> Edit Info</button>` : ''}<h2 class="text-2xl font-bold text-gray-800 mb-2">${s.introTitle||`Welcome to ${s.name}`}</h2><p class="text-gray-600 leading-relaxed">${s.introBody||'No introduction provided yet.'}</p></div>${isTeacher?`<div class="theme-panel bg-white p-4 rounded border border-gray-200 mb-6 shadow-sm"><textarea id="post-content" class="w-full border p-3 rounded mb-2 text-sm focus:outline-none focus:border-canvas-accent" placeholder="Share an announcement..." rows="3"></textarea><div class="flex flex-col gap-2"><div class="flex gap-2"><select id="post-type" class="border p-2 rounded text-sm bg-gray-50 flex-1" onchange="toggleMediaInput()"><option value="text">Text Only</option><option value="link">Link</option><option value="video">Video</option><option value="image_upload">Image (Upload)</option><option value="image_url">Image (URL)</option><option value="gif">GIF (URL)</option></select><button onclick="publishPost()" class="btn-theme px-6 py-2 rounded font-bold">Post</button></div><input id="post-url" class="border p-2 rounded text-sm hidden" placeholder="Paste URL here..."><div id="post-file-container" class="hidden border border-dashed border-gray-300 p-2 rounded bg-gray-50"><input type="file" id="post-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"></div></div></div>` : ''}<div class="space-y-6">${posts.map(p => renderPostCard(p, isTeacher)).join('')}</div>`;
        setTimeout(() => { const fi=$('post-file'); if(fi) fi.addEventListener('change', e=>{ const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=evt=>{tempTeacherImage=evt.target.result}; r.readAsDataURL(f); } }); }, 500);
    }

    // --- MODULES TAB ---
    if(currentTab === 'modules') {
        const modules = db.modules[s.id] || [];
        
        let modulesHtml = '';
        if(modules.length === 0) {
            modulesHtml = '<div class="text-center py-10 text-gray-400 border border-dashed rounded">No modules yet.</div>';
        } else {
            modulesHtml = `<div class="space-y-4">
            ${modules.map(m => {
                const unlockDate = m.unlockDate ? new Date(m.unlockDate) : null;
                const now = new Date();
                const isLocked = !isTeacher && unlockDate && now < unlockDate;
                
                let statusBadge = '';
                if (unlockDate) {
                    const dateStr = unlockDate.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: 'numeric', minute:'2-digit'});
                    if (isTeacher) {
                        statusBadge = `<span class="text-[10px] uppercase tracking-wider font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded ml-2 border border-yellow-200"><i class="fas fa-clock mr-1"></i> Scheduled: ${dateStr}</span>`;
                    } else if (isLocked) {
                        statusBadge = `<span class="text-[10px] uppercase tracking-wider font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded ml-2"><i class="fas fa-lock mr-1"></i> Available ${dateStr}</span>`;
                    }
                }

                const clickAction = isLocked ? `onclick="showToast('This module is locked until ${unlockDate.toLocaleString()}', 'error')"` : `onclick="viewModule('${m.id}')"`;
                const opacityClass = isLocked ? 'opacity-70 bg-gray-50 grayscale-[0.5]' : 'bg-white hover:shadow-md';
                const icon = isLocked 
                    ? '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><i class="fas fa-lock"></i></div>' 
                    : '<i class="fas fa-chevron-right text-gray-300"></i>';

                return `
                <div class="theme-panel ${opacityClass} p-4 rounded border transition">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 cursor-pointer" ${clickAction}>
                            <div class="flex items-center flex-wrap gap-y-1">
                                <h3 class="font-bold text-lg text-canvas-primary mr-2">${m.title}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${m.blocks.length} sections</p>
                        </div>
                        ${isTeacher ? `
                        <div class="flex gap-2">
                            <button onclick="editModule('${m.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteModule('${m.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                        </div>` : icon}
                    </div>
                </div>`;
            }).join('')}
            </div>`;
        }

        c.innerHTML = `<div class="flex justify-between items-center mb-6 border-b pb-4"><div><h2 class="text-xl font-bold text-gray-800">Learning Modules</h2></div>${isTeacher ? `<button onclick="openModuleBuilder()" class="btn-theme px-4 py-2 rounded font-bold text-sm"><i class="fas fa-plus mr-2"></i>Create Module</button>` : ''}</div>${modulesHtml}`;
    }
    
    // --- ACTIVITIES TAB (ENHANCED BUILDER) ---
    // ... rest of the tabs ...
    if(currentTab === 'activities') {
        const acts = db.activities[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-6 border-b pb-4"><div><h2 class="text-xl font-bold text-gray-800">Class Activities</h2><p class="text-gray-500 text-xs">Performance Tasks & Written Work</p></div>${isTeacher ? `<button onclick="createActivity()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}</div>`;
        if(acts.length === 0) { html += `<div class="theme-panel bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-clipboard-list text-4xl mb-3 block"></i>No activities yet.</div>`; } 
        else {
            html += `<div class="grid grid-cols-1 gap-4">`;
            acts.forEach(a => {
                const badgeColor = a.category === 'pt' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                let statusText = `<span class="text-gray-400 text-xs"><i class="fas fa-clock"></i> Due: ${a.dueDate ? formatDate(a.dueDate) : 'None'}</span>`;
                if (!isTeacher) {
                    const sub = db.activitySubmissions[a.id]?.[currentUser.id];
                    let isSub = false; 
                    if(sub && (sub.submittedAt || typeof sub === 'number')) isSub = true; 
                    if(isSub) statusText = `<span class="text-green-600 text-xs font-bold"><i class="fas fa-check-circle"></i> Submitted</span>`;
                    else if(a.dueDate && new Date() > new Date(a.dueDate)) statusText = `<span class="text-red-500 text-xs font-bold"><i class="fas fa-exclamation-circle"></i> Missing</span>`;
                }
                html += `<div class="theme-panel bg-white p-4 rounded border flex justify-between items-center hover:bg-gray-50 transition cursor-pointer" onclick="openActivityDetail('${a.id}')"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-clipboard-check text-xl"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${a.title}</h4><div class="flex gap-2 text-xs mt-1 items-center"><span class="${badgeColor} px-2 py-0.5 rounded font-bold uppercase">${a.category==='pt'?'Perf Task':'Written'}</span><span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Max: ${a.maxScore} pts</span>${statusText}</div></div></div>${isTeacher ? `<div class="flex gap-2"><button onclick="event.stopPropagation(); editActivity('${a.id}')" class="text-blue-400 hover:text-blue-600 px-2"><i class="fas fa-edit"></i></button><button onclick="event.stopPropagation(); deleteActivity('${a.id}')" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>` : '<i class="fas fa-chevron-right text-gray-300"></i>'}</div>`;
            });
            html += `</div>`;
        }
        c.innerHTML = html;
    }

    // --- QUIZZES TAB (RESTORED) ---
    if(currentTab === 'quizzes') {
        const exams = db.exams[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-4 border-b pb-2"><div><h2 class="text-xl font-bold text-gray-800">Quizzes & Exams</h2><p class="text-xs text-gray-500">Auto-graded assessments</p></div>${isTeacher ? `<div class="flex gap-2"><button onclick="openImportModal()" class="bg-white border text-gray-700 px-3 py-1 rounded text-sm font-bold"><i class="fas fa-file-word"></i> Import DOCX</button><button onclick="openCreateModal()" class="btn-theme px-4 py-2 rounded font-bold">New Quiz</button></div>` : ''}</div><div class="space-y-3">${exams.map(e => {
            const sub = db.examSubmissions[e.id]?.[currentUser.id];
            const attemptsAllowed = e.attempts || 1, attemptsTaken = sub ? (sub.attemptsTaken || 0) : 0, isAttemptLocked = attemptsTaken >= attemptsAllowed;
            const now = new Date(), openDate = new Date(e.openDate), dueDate = new Date(e.dueDate);
            const isUpcoming = now < openDate, isClosed = now > dueDate;
            let actionBtn = '';
            if(isTeacher || currentUser.role === 'admin') {
                actionBtn = `<div class="flex gap-2"><button onclick="showItemAnalysis('${e.id}')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200" title="Analytics"><i class="fas fa-chart-bar"></i></button><button onclick="reviewExamContent('${e.id}')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200" title="Review"><i class="fas fa-eye"></i></button><button onclick="openCreateModal('${e.id}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100" title="Edit"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteGradeItem('${e.id}', true)" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded" title="Delete"><i class="fas fa-trash"></i></button></div>`;
            } else {
                if (isUpcoming) actionBtn = `<span class="text-xs text-gray-500">Opens ${formatDate(e.openDate)}</span>`;
                else if (isClosed && !sub) actionBtn = `<span class="text-xs text-red-500">Closed</span>`;
                else if (isAttemptLocked || (isClosed && sub)) actionBtn = `<button onclick="reviewExam('${e.id}')" class="text-xs bg-gray-100 px-2 py-1 rounded">Review</button>`;
                else actionBtn = `<button onclick="startExam('${e.id}')" class="btn-theme px-3 py-1 rounded text-xs">Take</button>`;
            }
            return `<div class="theme-panel bg-white p-4 border rounded flex justify-between items-center hover:bg-gray-50"><div class="flex gap-4 items-center"><div><h4 class="font-bold text-gray-800">${e.title}</h4><div class="text-xs text-gray-500">Due: ${formatDate(e.dueDate)} • ${e.questions.length} Qs</div></div></div>${actionBtn}</div>`;
        }).join('')}</div>`;
        c.innerHTML = html;
    }

    // GRADES
    if(currentTab === 'grades') {
        const enrolled = db.users.filter(u => s.students.includes(u.id));
        const weights = s.gradingWeights || { ww: 40, pt: 40, qa: 20 };
        
        // Fetch all items
        const quizzes = db.exams[s.id] || [];
        const activities = db.activities[s.id] || [];
        
        // Categorize & Sort by date
        const wwItems = [
            ...activities.filter(a => a.category === 'ww'),
            ...quizzes.filter(q => q.category === 'ww') 
        ].sort((a,b) => new Date(a.date || a.openDate) - new Date(b.date || b.openDate));
        
        const ptItems = activities.filter(a => a.category === 'pt').sort((a,b) => new Date(a.date) - new Date(b.date));
        
        const qaItems = quizzes.filter(q => q.category === 'qa').sort((a,b) => new Date(a.openDate) - new Date(b.openDate));

        // Build HTML
        let html = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">Class Record</h2>${isTeacher?`<div class="flex gap-2"><button onclick="openWeightsModal()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs font-bold border">Weights</button><button onclick="resetGrades()" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded text-xs font-bold">Reset All</button></div>`:''}</div>`;
        
        // Summary Cards
        html += `<div class="grid grid-cols-3 gap-4 mb-4 text-center"><div class="bg-orange-50 p-2 rounded border border-orange-100"><div class="text-xs font-bold text-orange-800">WW (${weights.ww}%)</div></div><div class="bg-purple-50 p-2 rounded border border-purple-100"><div class="text-xs font-bold text-purple-800">PT (${weights.pt}%)</div></div><div class="bg-blue-50 p-2 rounded border border-blue-100"><div class="text-xs font-bold text-blue-800">QA (${weights.qa}%)</div></div></div>`;
        
        html += `<div class="theme-panel overflow-x-auto bg-white border rounded shadow-sm max-w-full"><table class="w-full text-left text-sm grade-table border-collapse">`;
        // Header Row
        html += `<thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b"><tr>`;
        html += `<th class="p-3 sticky left-0 bg-gray-50 border-r min-w-[150px] z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Student</th>`;
        
        // Helper to generate headers
        const addHeaders = (items, prefix, colorCls) => {
            if(items.length > 0) {
                items.forEach((i, idx) => {
                    const isExam = !!i.questions; // Check if it's an exam based on properties
                    html += `<th class="p-3 text-center border-r min-w-[80px] ${colorCls} relative group align-top" title="${i.title}">
                        <div class="flex flex-col items-center justify-between gap-1">
                            <span class="font-bold">${prefix}${idx+1}</span>
                            ${isTeacher ? `<button onclick="deleteGradeItem('${i.id}', ${isExam})" class="text-[10px] text-red-400 hover:text-red-700 opacity-50 hover:opacity-100 transition" title="Remove ${i.title}"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </th>`;
                });
                html += `<th class="p-3 text-center border-r ${colorCls.replace('/30','/50')} font-black align-middle">${prefix} Total</th>`;
            } else { html += `<th class="p-3 text-center border-r text-gray-300 font-normal">${prefix}</th>`; }
        };

        addHeaders(wwItems, 'WW', 'bg-orange-50/30 text-orange-800');
        addHeaders(ptItems, 'PT', 'bg-purple-50/30 text-purple-800');
        addHeaders(qaItems, 'QA', 'bg-blue-50/30 text-blue-800');

        html += `<th class="p-3 text-center bg-gray-100 text-gray-800 min-w-[80px] align-middle border-l-2 border-gray-200">Final Grade</th>`;
        html += `</tr></thead><tbody class="divide-y">`;

        // Body Rows
        enrolled.forEach(stu => {
            html += `<tr class="hover:bg-gray-50 group">`;
            html += `<td class="p-3 font-bold text-gray-700 sticky left-0 bg-white border-r flex items-center gap-2 group-hover:bg-gray-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] h-full">${renderAvatar(stu, 'w-6 h-6', 'text-[10px]')} <span class="truncate w-32">${stu.name}</span></td>`;

            const getScore = (item) => {
                let score = 0, max = 0;
                if(item.questions) { // Exam: stored as percentage (0-100)
                    max = 100;
                    const sub = db.examSubmissions[item.id]?.[stu.id];
                    if(sub && sub.score !== undefined) score = sub.score;
                    else return { val: '-', raw: 0, max: 100 };
                } else { // Activity: stored as raw points
                    max = parseInt(item.maxScore);
                    const sub = db.activitySubmissions[item.id]?.[stu.id];
                    if(typeof sub === 'number') score = sub;
                    else if(sub && sub.score !== undefined) score = sub.score;
                    else return { val: '-', raw: 0, max: max };
                }
                return { val: score, raw: score, max: max };
            };

            const addCells = (items, colorBg) => {
                let totalScore = 0, totalMax = 0;
                if(items.length > 0) {
                    items.forEach(i => {
                        const s = getScore(i);
                        const numericScore = s.val === '-' ? 0 : s.val;
                        totalScore += numericScore;
                        totalMax += s.max;
                        html += `<td class="p-3 text-center text-xs border-r text-gray-600">${s.val}</td>`;
                    });
                    const perc = totalMax === 0 ? 0 : (totalScore / totalMax) * 100;
                    html += `<td class="p-3 text-center font-bold ${colorBg} border-r">${Math.round(perc)}%</td>`;
                    return perc;
                } else { 
                    html += `<td class="p-3 text-center border-r text-gray-200">-</td>`; 
                    return 0;
                }
            };

            const wPerc = addCells(wwItems, 'text-orange-700 bg-orange-50/20');
            const pPerc = addCells(ptItems, 'text-purple-700 bg-purple-50/20');
            const qPerc = addCells(qaItems, 'text-blue-700 bg-blue-50/20');
            
            const final = (wPerc * (weights.ww/100)) + (pPerc * (weights.pt/100)) + (qPerc * (weights.qa/100));
            
            html += `<td class="p-3 text-center font-black text-gray-800 bg-gray-100 border-l-2 border-gray-200 text-base">${Math.round(final)}</td>`;
            html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        c.innerHTML = html;
    }
    
    if(currentTab === 'people') {
        const ppl = db.users.filter(u=>s.students.includes(u.id));
        c.innerHTML = `<h2 class="text-xl font-bold mb-4">People</h2>${isTeacher ? `<div class="flex gap-2"><button onclick="openRegisterStudentModal()" class="bg-white border text-gray-600 px-3 py-1 rounded text-sm font-bold shadow-sm">New</button><button onclick="openAddStudentModal()" class="btn-theme px-4 py-2 rounded font-bold text-sm">Enroll</button></div>` : ''}</div><div class="theme-panel bg-white border rounded overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b text-xs uppercase font-bold text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">Role</th>${isTeacher?`<th class="p-4">User</th><th class="p-4">Pass</th><th class="p-4 text-right"></th>`:''}</tr></thead><tbody class="divide-y"><tr><td class="p-4 flex items-center gap-2 font-bold">${renderAvatar(db.users.find(u=>u.id===s.teacherId),'w-6 h-6')} ${db.users.find(u=>u.id===s.teacherId)?.name}</td><td class="p-4">Teacher</td>${isTeacher?`<td class="p-4 text-gray-400">-</td><td class="p-4 text-gray-400">-</td><td></td>`:''}</tr>${ppl.map(u=>`<tr><td class="p-4 flex items-center gap-2">${renderAvatar(u,'w-6 h-6')} ${u.name}</td><td class="p-4">Student</td>${isTeacher?`<td class="p-4 font-mono text-blue-600">${u.username}</td><td class="p-4 font-mono text-red-500">${u.password}</td><td class="p-4 text-right"><button onclick="removeStudentFromCourse('${s.id}','${u.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-user-minus"></i></button></td>`:''}</tr>`).join('')}</tbody></table></div>`;
    }
}

// Course Logic
window.deletePost = (pid) => { showConfirm('Delete post?', ()=>{db.posts=db.posts.filter(p=>p.id!==pid); saveDB(); render();}); }
window.togglePinPost = (pid) => { const p=db.posts.find(x=>x.id===pid); if(p){p.isPinned=!p.isPinned; saveDB(); render(); showToast(p.isPinned ? 'Post Pinned' : 'Post Unpinned'); } }
window.removeStudentFromCourse = (sid,uid) => { showConfirm('Remove student?', ()=>{ const s=db.subjects.find(x=>x.id===sid); s.students=s.students.filter(i=>i!==uid); saveDB(); render(); }); }
window.toggleMediaInput = () => { const t=$('post-type').value; $('post-url').classList.toggle('hidden', t!=='link'&&t!=='video'&&t!=='image_url'&&t!=='gif'); $('post-file-container').classList.toggle('hidden', t!=='image_upload'); }
window.publishPost = () => { const c=$('post-content').value, t=$('post-type').value; let u=$('post-url').value; if(t==='image_upload') u=tempTeacherImage; if(c||u) { if(!db.posts) db.posts=[]; db.posts.push({id:'p'+Date.now(), courseId:currentCourseId, authorId:currentUser.id, authorName:currentUser.name, date:new Date().toISOString(), content:c, mediaType:t, mediaUrl:u, isPinned:false}); tempTeacherImage=null; saveDB(); render(); } }
window.editIntro = () => { const s=db.subjects.find(x=>x.id===currentCourseId); const t=prompt('Title:',s.introTitle); if(t!==null){ const b=prompt('Body:',s.introBody); if(b!==null){ s.introTitle=t; s.introBody=b; saveDB(); render(); }}}
function renderPostCard(p, isAdmin) {
    let mediaHtml = '';
    if(p.mediaType==='video' && p.mediaUrl) { let u=p.mediaUrl.replace('watch?v=','embed/'); mediaHtml=`<div class="embed-container mt-3"><iframe src="${u}" frameborder="0" allowfullscreen></iframe></div>`; }
    else if((p.mediaType==='image_url' || p.mediaType==='image_upload' || p.mediaType === 'gif') && p.mediaUrl) { mediaHtml=`<img src="${p.mediaUrl}" class="w-full h-auto rounded mt-3 border object-contain bg-black/5" style="max-height: 600px;">`; }
    else if(p.mediaType==='link') mediaHtml=`<a href="${p.mediaUrl}" target="_blank" class="block mt-2 bg-gray-50 p-3 rounded border text-canvas-accent font-bold"><i class="fas fa-link mr-2"></i> ${p.mediaUrl}</a>`;
    return `<div class="theme-panel bg-white p-6 rounded border border-gray-200 shadow-sm relative group ${p.isPinned ? 'bg-yellow-50 border-yellow-200' : ''}">${p.isPinned ? '<div class="absolute top-2 left-2 text-xs font-bold text-yellow-600"><i class="fas fa-thumbtack mr-1"></i> Pinned</div>' : ''}${isAdmin ? `<div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="togglePinPost('${p.id}')" class="${p.isPinned ? 'text-canvas-accent' : 'text-gray-300 hover:text-canvas-accent'}"><i class="fas fa-thumbtack"></i></button><button onclick="deletePost('${p.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>` : ''}<div class="flex gap-3 mb-3 mt-4">${renderAvatar({name:p.authorName}, 'w-10 h-10', 'text-sm')}<div><p class="font-bold text-sm">${p.authorName}</p><p class="text-xs text-gray-500">${new Date(p.date).toLocaleString()}</p></div></div><div class="text-gray-700 whitespace-pre-line">${p.content}</div>${mediaHtml}</div>`;
}

// --- MODULE BUILDER ---
window.openModuleBuilder = () => { builderBlocks = []; editingModuleId = null; currentView = 'module_builder'; render(); }
window.editModule = (mid) => { const m = db.modules[currentCourseId].find(x=>x.id===mid); builderBlocks = JSON.parse(JSON.stringify(m.blocks)); editingModuleId = mid; $('mod-title-input') ? $('mod-title-input').value=m.title : null; currentView = 'module_builder'; render(); }
window.deleteModule = (mid) => { showConfirm("Delete Module?", () => { db.modules[currentCourseId] = db.modules[currentCourseId].filter(m=>m.id!==mid); saveDB(); render(); }); }

// New function to View Module Content
window.viewModule = (mid) => {
    const m = db.modules[currentCourseId].find(x => x.id === mid);
    if (!m) return;
    
    const contentHtml = m.blocks.map(b => {
        if (b.type === 'text') return `<div class="mb-4 text-gray-800 whitespace-pre-wrap">${b.content}</div>`;
        if (b.type === 'image') return `<img src="${b.content}" class="w-full h-auto rounded mb-4 shadow-sm">`;
        if (b.type === 'video') {
             let url = b.content;
             if(url.includes('watch?v=')) url = url.replace('watch?v=', 'embed/');
             return `<div class="embed-container mb-4"><iframe src="${url}" frameborder="0" allowfullscreen></iframe></div>`;
        }
        if (b.type === 'file') return `<a href="${b.content}" download="${b.name || 'download'}" class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-100 rounded text-blue-700 font-bold mb-4 hover:bg-blue-100 transition"><i class="fas fa-file-download text-xl"></i> ${b.name || 'Download File'}</a>`;
        return '';
    }).join('');

    renderModal('mod-view', m.title, `
        <div class="max-h-[75vh] overflow-y-auto pr-2 custom-scrollbar">
            ${contentHtml || '<div class="text-center text-gray-400 py-8 italic">This module has no content yet.</div>'}
        </div>
    `);
}

// Alias for backward compatibility with datetime helper
window.toLocalISO = window.toLocalISOString;

// --- BLOCK MANAGEMENT FUNCTIONS ---

// Add a new block to the builder
window.addBlock = (type) => { 
    builderBlocks.push({ type, content: '' }); 
    renderBlocks(); 
}

// Remove a block at index i
window.removeBlock = (i) => { 
    builderBlocks.splice(i, 1); 
    renderBlocks(); 
}

// Move a block up or down
window.moveBlock = (i, dir) => { 
    if(i+dir>=0 && i+dir<builderBlocks.length) { 
        [builderBlocks[i], builderBlocks[i+dir]] = [builderBlocks[i+dir], builderBlocks[i]]; 
        renderBlocks(); 
    } 
}

// Update block content
window.updateBlock = (i, val) => { 
    builderBlocks[i].content = val; 
}

// Execute formatting commands for text blocks
window.execCmd = (i, cmd, val=null) => { 
    document.execCommand(cmd, false, val); 
    builderBlocks[i].content = document.getElementById(`editor-${i}`).innerHTML; 
}

// Handle file uploads for image/file blocks
window.uploadBlockFile = (i, input) => { 
    if(input.files[0]) { 
        const r = new FileReader(); 
        r.onload = e => { 
            builderBlocks[i].content = e.target.result; 
            builderBlocks[i].name = input.files[0].name; 
            renderBlocks(); 
        }; 
        r.readAsDataURL(input.files[0]); 
    } 
}

// Render all blocks to the UI
window.renderBlocks = () => { 
    const container = $('blocks-list'); 
    if(!container) return;
    
    if(builderBlocks.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-400 border-2 border-dashed rounded-lg"><i class="fas fa-plus-circle text-3xl mb-3"></i><p class="text-sm">Click the buttons below to add content blocks</p></div>';
        return;
    }
    
    container.innerHTML = builderBlocks.map((b, i) => {
        let content = '';
        
        if(b.type === 'text') {
            content = `
                <div class="rich-toolbar">
                    <button onclick="execCmd(${i}, 'bold')" class="rich-btn" title="Bold"><i class="fas fa-bold"></i></button>
                    <button onclick="execCmd(${i}, 'italic')" class="rich-btn" title="Italic"><i class="fas fa-italic"></i></button>
                    <button onclick="execCmd(${i}, 'underline')" class="rich-btn" title="Underline"><i class="fas fa-underline"></i></button>
                    <button onclick="execCmd(${i}, 'insertUnorderedList')" class="rich-btn" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button onclick="execCmd(${i}, 'insertOrderedList')" class="rich-btn" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                    <button onclick="execCmd(${i}, 'justifyLeft')" class="rich-btn" title="Align Left"><i class="fas fa-align-left"></i></button>
                    <button onclick="execCmd(${i}, 'justifyCenter')" class="rich-btn" title="Align Center"><i class="fas fa-align-center"></i></button>
                    <button onclick="execCmd(${i}, 'justifyRight')" class="rich-btn" title="Align Right"><i class="fas fa-align-right"></i></button>
                </div>
                <div id="editor-${i}" contenteditable="true" class="rich-content" 
                     oninput="updateBlock(${i}, this.innerHTML)"
                     placeholder="Type your text here...">${b.content}</div>
            `;
        } else if(b.type === 'image') {
            content = `
                <div class="space-y-2">
                    ${b.content ? `<img src="${b.content}" class="w-full h-auto rounded border max-h-64 object-cover">` : ''}
                    <div class="flex items-center gap-2">
                        <label class="flex-1">
                            <input type="file" accept="image/*" onchange="uploadBlockFile(${i}, this)" class="hidden">
                            <div class="w-full border-2 border-dashed rounded p-3 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
                                <i class="fas fa-cloud-upload-alt text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-500">${b.content ? 'Change image' : 'Upload image'}</span>
                            </div>
                        </label>
                        ${b.content ? `<button onclick="builderBlocks[${i}].content=''; renderBlocks()" class="text-red-500 hover:bg-red-50 px-3 py-2 rounded text-sm font-bold">Remove</button>` : ''}
                    </div>
                </div>
            `;
        } else if(b.type === 'video') {
            content = `
                <div class="space-y-2">
                    ${b.content ? `
                        <div class="aspect-video rounded overflow-hidden bg-gray-900">
                            ${b.content.includes('youtube.com') || b.content.includes('youtu.be') 
                                ? `<iframe src="${b.content.replace('watch?v=', 'embed/')}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>` 
                                : `<video src="${b.content}" controls class="w-full h-full"></video>`
                            }
                        </div>
                    ` : ''}
                    <div class="flex gap-2">
                        <input type="text" value="${b.content}" 
                               onchange="updateBlock(${i}, this.value)"
                               placeholder="Paste YouTube or video URL..." 
                               class="flex-1 border p-2 rounded text-sm">
                        ${b.content ? `<button onclick="builderBlocks[${i}].content=''; renderBlocks()" class="text-red-500 hover:bg-red-50 px-3 py-2 rounded text-sm font-bold">Remove</button>` : ''}
                    </div>
                </div>
            `;
        } else if(b.type === 'file') {
            content = `
                <div class="space-y-2">
                    ${b.content ? `
                        <div class="flex items-center gap-3 p-3 bg-orange-50 border border-orange-200 rounded">
                            <i class="fas fa-file text-orange-500 text-2xl"></i>
                            <div class="flex-1">
                                <p class="font-bold text-sm">${b.name || 'File'}</p>
                                <p class="text-xs text-gray-500">File attached</p>
                            </div>
                        </div>
                    ` : ''}
                    <div class="flex items-center gap-2">
                        <label class="flex-1">
                            <input type="file" onchange="uploadBlockFile(${i}, this)" class="hidden">
                            <div class="w-full border-2 border-dashed rounded p-3 text-center cursor-pointer hover:border-orange-400 hover:bg-orange-50 transition">
                                <i class="fas fa-paperclip text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-500">${b.content ? 'Change file' : 'Upload file'}</span>
                            </div>
                        </label>
                        ${b.content ? `<button onclick="builderBlocks[${i}].content=''; renderBlocks()" class="text-red-500 hover:bg-red-50 px-3 py-2 rounded text-sm font-bold">Remove</button>` : ''}
                    </div>
                </div>
            `;
        }
        
        return `
            <div class="module-block" data-index="${i}">
                <div class="block-actions">
                    <button onclick="moveBlock(${i}, -1)" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-1 rounded" title="Move Up">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button onclick="moveBlock(${i}, 1)" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-1 rounded" title="Move Down">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <button onclick="removeBlock(${i})" class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-1 rounded" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="text-xs font-bold text-gray-400 uppercase mb-2 flex items-center gap-2">
                    <i class="fas ${b.type === 'text' ? 'fa-font text-blue-500' : b.type === 'image' ? 'fa-image text-green-500' : b.type === 'video' ? 'fa-video text-red-500' : 'fa-paperclip text-orange-500'}"></i>
                    ${b.type.charAt(0).toUpperCase() + b.type.slice(1)} Block
                </div>
                ${content}
            </div>
        `;
    }).join('');
}); renderBlocks(); }
window.removeBlock = (i) => { builderBlocks.splice(i, 1); renderBlocks(); }
window.moveBlock = (i, dir) => { if(i+dir>=0 && i+dir<builderBlocks.length) { [builderBlocks[i], builderBlocks[i+dir]] = [builderBlocks[i+dir], builderBlocks[i]]; renderBlocks(); } }
window.updateBlock = (i, val) => { builderBlocks[i].content = val; }
window.execCmd = (i, cmd, val=null) => { document.execCommand(cmd, false, val); builderBlocks[i].content = document.getElementById(`editor-${i}`).innerHTML; }
window.uploadBlockFile = (i, input) => { if(input.files[0]) { const r = new FileReader(); r.onload = e => { builderBlocks[i].content = e.target.result; builderBlocks[i].name = input.files[0].name; renderBlocks(); }; r.readAsDataURL(input.files[0]); } }
window.cancelModule = () => { currentView = 'course'; render(); }
// --- UPDATED MODULE BUILDER (Replaces your old saveModule) ---
window.saveModule = async () => {
    const title = $('mod-title').value;
    const unlockDate = $('mod-unlock').value;
    if (!title) return showToast('Please enter a module title', 'error');

    const moduleData = {
        id: editingModuleId || 'mod_' + Date.now(),
        title: title,
        courseId: currentCourseId,
        unlockDate: unlockDate, // Save the scheduled date
        blocks: [...builderBlocks], 
        date: new Date().toISOString() 
    };

    // Ensure the array exists for this specific course
    if (!db.modules[currentCourseId]) db.modules[currentCourseId] = [];

    // Logic to Update or Add
    if (editingModuleId) {
        const idx = db.modules[currentCourseId].findIndex(m => m.id === editingModuleId);
        if(idx !== -1) db.modules[currentCourseId][idx] = moduleData;
    } else {
        db.modules[currentCourseId].push(moduleData);
    }

    const success = await saveDB();
    if (success) {
        showToast('Module successfully saved to Cloud');
        goCourse(currentCourseId); 
    }
};

// --- UPDATED ACTIVITY BUILDER (Replaces your old publishActivity) ---
window.publishActivity = async () => {
    const title = $('act-title').value;
    const type = $('act-type').value;
    if (!title) return showToast('Please enter a title', 'error');

    const activityData = {
        id: editingActivityId || 'act_' + Date.now(),
        title: title,
        type: type,
        content: builderBlocks.map(b => b.content).join('\n'),
        blocks: [...builderBlocks],
        date: new Date().toISOString(),
        courseId: currentCourseId
    };

// --- ACTIVITY BUILDER (NEW) ---
window.createActivity = () => { builderBlocks = []; editingActivityId = null; currentView = 'activity_builder'; render(); }
window.editActivity = (aid) => { const a = db.activities[currentCourseId].find(x=>x.id===aid); builderBlocks = JSON.parse(JSON.stringify(a.blocks || [])); editingActivityId = aid; currentView = 'activity_builder'; render(); }
window.cancelActivity = () => { currentView = 'course'; render(); }

// Helper for datetime-local input
window.toLocalISOString = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const pad = (n) => n < 10 ? '0' + n : n;
    return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) + 'T' + pad(date.getHours()) + ':' + pad(date.getMinutes());
}

window.saveActivityBuilt = async () => {
    const t=$('act-build-title').value, max=parseInt($('act-build-max').value), cat=$('act-build-cat').value, start=$('act-build-start').value, due=$('act-build-due').value;
    const subText = $('sub-opt-text').checked, subFile = $('sub-opt-file').checked;
    
    if(!t) return showToast('Title required', 'error');

    // Show loading
    const btn = $('btn-save-act');
    if(btn) {
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> <span>Saving...</span>';
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
    }

    if(!db.activities[currentCourseId]) db.activities[currentCourseId] = [];
    
    const actData = {
        id: editingActivityId || 'a'+Date.now(), 
        title: t, 
        maxScore: max, 
        category: cat, 
        openDate: start ? new Date(start).toISOString() : null, 
        dueDate: due ? new Date(due).toISOString() : null,
        blocks: [...builderBlocks], 
        submissionOptions: { text: subText, file: subFile },
        date: new Date().toISOString(),
        courseId: currentCourseId
    };
    
    if(editingActivityId) { 
        const idx = db.activities[currentCourseId].findIndex(a=>a.id===editingActivityId); 
        db.activities[currentCourseId][idx] = actData; 
    } else { 
        db.activities[currentCourseId].push(actData); 
    }
    
    const success = await saveDB();
    if(success) {
        currentView = 'course'; render(); showToast('Activity Saved');
    } else {
        if(btn) {
            btn.innerHTML = 'Save Activity';
            btn.disabled = false;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }
}

function renderActivityBuilder(c) {
    const act = editingActivityId ? db.activities[currentCourseId].find(a=>a.id===editingActivityId) : {};
    c.innerHTML = `
        <div class="max-w-4xl mx-auto pb-24">
            <div class="theme-panel bg-white p-6 rounded shadow-sm border mb-6 sticky top-24 z-30">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex-1 mr-4">
                         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Activity Title</label>
                        <input id="act-build-title" value="${act.title||''}" class="text-2xl font-bold bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none w-full" placeholder="e.g., Reflection Paper 1">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cancelActivity()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded border border-transparent hover:border-gray-200 transition">Cancel</button>
                        <button id="btn-save-act" onclick="saveActivityBuilt()" class="btn-theme px-4 py-2 bg-green-600 text-white font-bold rounded shadow hover:shadow-lg transition">Save Activity</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4 bg-gray-50 p-4 rounded border">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="act-build-cat" class="w-full border p-2 rounded bg-white text-sm"><option value="ww" ${act.category==='ww'?'selected':''}>Written Work</option><option value="pt" ${act.category==='pt'?'selected':''}>Perf Task</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Max Score</label><input id="act-build-max" type="number" value="${act.maxScore||100}" class="w-full border p-2 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Unlock Date (Start)</label><input id="act-build-start" type="datetime-local" value="${toLocalISO(act.openDate)}" class="w-full border p-2 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Due Date (Lock)</label><input id="act-build-due" type="datetime-local" value="${toLocalISO(act.dueDate)}" class="w-full border p-2 rounded text-sm"></div>
                </div>
                <div class="flex gap-6 border-t pt-4">
                    <span class="text-sm font-bold text-gray-700">Submission Type:</span>
                    <label class="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" id="sub-opt-text" ${(act.submissionOptions?.text !== false)?'checked':''} class="accent-blue-600"> Text Entry</label>
                    <label class="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" id="sub-opt-file" ${(act.submissionOptions?.file !== false)?'checked':''} class="accent-blue-600"> File Upload</label>
                    
                    ${editingActivityId ? `<button onclick="deleteActivity('${editingActivityId}')" class="ml-auto text-red-500 hover:text-red-700 text-xs font-bold uppercase"><i class="fas fa-trash mr-1"></i> Remove Activity</button>` : ''}
                </div>
            </div>

            <div class="flex justify-between items-end mb-4 px-2">
                 <div class="font-bold text-gray-500 uppercase text-xs tracking-wider">Instructions & Content</div>
            </div>

            <div id="blocks-list" class="space-y-4"></div>

            <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-md border border-gray-200 p-2 rounded-full flex justify-center gap-2 shadow-xl z-50">
                <button onclick="addBlock('text')" class="flex flex-col items-center justify-center w-16 h-14 hover:bg-blue-50 rounded-lg transition group">
                    <i class="fas fa-font text-blue-500 text-lg group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-600 mt-1">Text</span>
                </button>
                <div class="w-px bg-gray-200 my-2"></div>
                <button onclick="addBlock('image')" class="flex flex-col items-center justify-center w-16 h-14 hover:bg-green-50 rounded-lg transition group">
                    <i class="fas fa-image text-green-500 text-lg group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-600 mt-1">Image</span>
                </button>
                <div class="w-px bg-gray-200 my-2"></div>
                <button onclick="addBlock('video')" class="flex flex-col items-center justify-center w-16 h-14 hover:bg-red-50 rounded-lg transition group">
                    <i class="fas fa-video text-red-500 text-lg group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-600 mt-1">Video</span>
                </button>
                <div class="w-px bg-gray-200 my-2"></div>
                <button onclick="addBlock('file')" class="flex flex-col items-center justify-center w-16 h-14 hover:bg-orange-50 rounded-lg transition group">
                    <i class="fas fa-paperclip text-orange-500 text-lg group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-600 mt-1">File</span>
                </button>
            </div>
        </div>
    `;
    renderBlocks();
}

// --- UPDATED MODULE BUILDER (Replaces your old saveModule) ---
    // --- ACTIVITIES TAB (ENHANCED BUILDER) ---
    if(currentTab === 'activities') {
        const acts = db.activities[s.id] || [];
        let html = `<div class="flex justify-between items-center mb-6 border-b pb-4"><div><h2 class="text-xl font-bold text-gray-800">Class Activities</h2><p class="text-gray-500 text-xs">Performance Tasks & Written Work</p></div>${isTeacher ? `<button onclick="createActivity()" class="btn-theme px-4 py-2 rounded font-bold text-sm shadow transition"><i class="fas fa-plus mr-2"></i>New Activity</button>` : ''}</div>`;
        if(acts.length === 0) { html += `<div class="theme-panel bg-white p-12 rounded border border-dashed text-center text-gray-400"><i class="fas fa-clipboard-list text-4xl mb-3 block"></i>No activities yet.</div>`; } 
        else {
            html += `<div class="grid grid-cols-1 gap-4">`;
            acts.forEach(a => {
                const now = new Date();
                const openDate = a.openDate ? new Date(a.openDate) : null;
                const dueDate = a.dueDate ? new Date(a.dueDate) : null;
                
                // Logic for locking
                const isLocked = !isTeacher && openDate && now < openDate;
                const isClosed = !isTeacher && dueDate && now > dueDate;
                
                // Styling
                const badgeColor = a.category === 'pt' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-orange-100 text-orange-700 border-orange-200';
                const opacityClass = isLocked ? 'opacity-70 bg-gray-50 grayscale-[0.5]' : 'bg-white hover:shadow-md';
                const clickAction = isLocked 
                    ? `onclick="showToast('Locked until ${openDate.toLocaleString()}', 'error')"` 
                    : `onclick="openActivityDetail('${a.id}')"`;

                let statusBadge = '';
                if(openDate && now < openDate) statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded border border-yellow-200"><i class="fas fa-clock"></i> Scheduled: ${formatDate(openDate)}</span>`;
                else if(dueDate) statusBadge = `<span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded border border-gray-200"><i class="fas fa-hourglass-end"></i> Due: ${formatDate(dueDate)}</span>`;
                
                let subStatus = '';
                if (!isTeacher) {
                    const sub = db.activitySubmissions[a.id]?.[currentUser.id];
                    if(sub && (sub.submittedAt || typeof sub === 'number')) subStatus = `<span class="text-green-600 text-xs font-bold ml-2"><i class="fas fa-check-circle"></i> Submitted</span>`;
                    else if(isClosed) subStatus = `<span class="text-red-500 text-xs font-bold ml-2"><i class="fas fa-times-circle"></i> Missing</span>`;
                }

                html += `
                <div class="theme-panel ${opacityClass} p-4 rounded border flex justify-between items-center transition cursor-pointer" ${clickAction}>
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200">
                            <i class="fas ${isLocked ? 'fa-lock' : 'fa-clipboard-check'} text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                ${a.title}
                                ${subStatus}
                            </h4>
                            <div class="flex flex-wrap gap-2 text-xs mt-1 items-center">
                                <span class="${badgeColor} px-2 py-0.5 rounded font-bold uppercase border">${a.category==='pt'?'Performance Task':'Written Work'}</span>
                                <span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">Max: ${a.maxScore} pts</span>
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                    ${isTeacher ? `
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); editActivity('${a.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded transition"><i class="fas fa-edit"></i></button>
                        <button onclick="event.stopPropagation(); deleteActivity('${a.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button>
                    </div>` : '<i class="fas fa-chevron-right text-gray-300"></i>'}
                </div>`;
            });
            html += `</div>`;
        }
        c.innerHTML = html;
    }

    const moduleData = {
        id: editingModuleId || 'mod_' + Date.now(),
        title: title,
        courseId: currentCourseId,
        unlockDate: unlockDate, 
        blocks: [...builderBlocks], 
        date: new Date().toISOString() 
    };

    // Ensure the array exists for this specific course
    if (!db.modules[currentCourseId]) db.modules[currentCourseId] = [];

    // Logic to Update or Add
    if (editingModuleId) {
        const idx = db.modules[currentCourseId].findIndex(m => m.id === editingModuleId);
        if(idx !== -1) db.modules[currentCourseId][idx] = moduleData;
    } else {
        db.modules[currentCourseId].push(moduleData);
    }

    const success = await saveDB();
    
    if (success) {
        showToast('Module successfully saved to Cloud');
        goCourse(currentCourseId); 
    } else {
        // Reset button on failure
        if(btn) {
            btn.innerHTML = '<i class="fas fa-save"></i> <span>Save Module</span>';
            btn.disabled = false;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }
};

window.execCmd = (i, cmd, val=null) => { 
    // Ensure document focus allows command execution (basic)
    document.execCommand(cmd, false, val); 
    // Immediately update the model
    const el = document.getElementById(`editor-${i}`);
    if(el) {
        builderBlocks[i].content = el.innerHTML;
    }
}

function renderActivityBuilder(c) {
    const act = editingActivityId ? db.activities[currentCourseId].find(a=>a.id===editingActivityId) : {};
    c.innerHTML = `
        <div class="max-w-4xl mx-auto pb-24">
            <div class="theme-panel bg-white p-6 rounded shadow-sm border mb-6">
                <div class="flex justify-between items-center mb-4">
                    <input id="act-build-title" value="${act.title||''}" class="text-2xl font-bold bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none w-full mr-4" placeholder="Activity Title">
                    <div class="flex gap-2">
                        <button onclick="cancelActivity()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded">Cancel</button>
                        <button onclick="saveActivityBuilt()" class="btn-theme px-4 py-2 bg-green-600 text-white font-bold rounded shadow">Save Activity</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-xs font-bold text-gray-500">Category</label><select id="act-build-cat" class="w-full border p-2 rounded bg-white"><option value="ww" ${act.category==='ww'?'selected':''}>Written Work</option><option value="pt" ${act.category==='pt'?'selected':''}>Perf Task</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500">Max Score</label><input id="act-build-max" type="number" value="${act.maxScore||100}" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">Unlock Date</label><input id="act-build-start" type="datetime-local" value="${act.openDate||''}" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">Due Date (Lock)</label><input id="act-build-due" type="datetime-local" value="${act.dueDate||''}" class="w-full border p-2 rounded"></div>
                </div>
                <div class="flex gap-6 border-t pt-4">
                    <span class="text-sm font-bold text-gray-700">Student Submission Options:</span>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="sub-opt-text" ${(act.submissionOptions?.text !== false)?'checked':''}> Text Entry</label>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="sub-opt-file" ${(act.submissionOptions?.file !== false)?'checked':''}> File Upload</label>
                </div>
            </div>

            <div class="mb-2 font-bold text-gray-500 uppercase text-xs">Instructions / Content</div>
            <div id="blocks-list" class="space-y-4"></div>

            <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 flex justify-center gap-4 shadow z-50">
                <button onclick="addBlock('text')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 font-bold border"><i class="fas fa-font text-blue-500"></i> Text</button>
                <button onclick="addBlock('image')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 font-bold border"><i class="fas fa-image text-green-500"></i> Image</button>
                <button onclick="addBlock('video')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 font-bold border"><i class="fas fa-video text-red-500"></i> Video</button>
                <button onclick="addBlock('file')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-blue-50 font-bold border"><i class="fas fa-paperclip text-gray-500"></i> File</button>
            </div>
        </div>
    `;
    renderBlocks();
}

window.openActivityDetail = (aid) => {
    const act = db.activities[currentCourseId].find(a => a.id === aid);
    // Teacher View
    if(currentUser.role !== 'student') {
        const s = db.subjects.find(x => x.id === currentCourseId);
        const students = db.users.filter(u => s.students.includes(u.id));
        // Instructions Preview
        let instrHtml = (act.blocks || []).map(b => {
             if(b.type === 'text') return `<div class="mb-2">${b.content}</div>`;
             if(b.type === 'image') return `<img src="${b.content}" class="w-full h-auto rounded mb-2">`;
             if(b.type === 'video') return `<div class="embed-container mb-2"><iframe src="${b.content.replace('watch?v=', 'embed/')}" frameborder="0"></iframe></div>`;
             if(b.type === 'file') return `<a href="${b.content}" download="${b.name}" class="text-theme underline block mb-2">Download ${b.name}</a>`;
        }).join('');
        // Legacy support
        if(!act.blocks && act.description) instrHtml = `<p>${act.description}</p>${act.instructionFile?`<a href="${act.instructionFile.data}" download="${act.instructionFile.name}">File</a>`:''}`;

        renderModal('act-grade', act.title, `
            <div class="bg-gray-50 p-3 rounded mb-4 max-h-40 overflow-y-auto border text-sm">${instrHtml || '<span class="text-gray-400">No instructions.</span>'}</div>
            <div class="space-y-2 max-h-[50vh] overflow-y-auto border-t pt-2">
                ${students.map(u => {
                    const sub = db.activitySubmissions[aid]?.[u.id];
                    let score = '-', status = '<span class="text-red-400 text-xs">Missing</span>';
                    if(sub) {
                        if(typeof sub==='object') { 
                            score = sub.score !== undefined ? sub.score : '-'; 
                            if(sub.submittedAt) status = '<span class="text-green-600 text-xs">Submitted</span>';
                        } else { score = sub; status = '<span class="text-green-600 text-xs">Graded</span>'; }
                    }
                    return `<div onclick="viewStudentSubmission('${aid}','${u.id}')" class="p-2 border rounded hover:bg-gray-50 cursor-pointer flex justify-between items-center">
                        <div class="flex items-center gap-2">${renderAvatar(u,'w-6 h-6','text-[10px]')} <span class="text-sm font-bold">${u.name}</span></div>
                        <div class="text-right"><div>${status}</div><div class="font-bold text-sm">${score}/${act.maxScore}</div></div>
                    </div>`;
                }).join('')}
            </div>
        `);
        return;
    }
    
    // Student View
    const sub = db.activitySubmissions[aid]?.[currentUser.id] || {};
    const now = new Date();
    const isLocked = (act.openDate && now < new Date(act.openDate)) || (act.dueDate && now > new Date(act.dueDate) && !sub.submittedAt);
    if(isLocked) return showToast('Locked', 'error');

    let instrHtml = (act.blocks || []).map(b => {
             if(b.type === 'text') return `<div class="mb-4">${b.content}</div>`;
             if(b.type === 'image') return `<img src="${b.content}" class="w-full h-auto rounded mb-4">`;
             if(b.type === 'video') return `<div class="embed-container mb-4"><iframe src="${b.content.replace('watch?v=', 'embed/')}" frameborder="0"></iframe></div>`;
             if(b.type === 'file') return `<a href="${b.content}" download="${b.name}" class="block bg-blue-50 p-2 rounded text-theme font-bold mb-4"><i class="fas fa-paperclip"></i> ${b.name}</a>`;
    }).join('');
    // Legacy support
    if(!act.blocks && act.description) instrHtml = `<p class="whitespace-pre-wrap">${act.description}</p>${act.instructionFile?`<a href="${act.instructionFile.data}" download="${act.instructionFile.name}" class="text-theme underline">Download File</a>`:''}`;

    const opts = act.submissionOptions || { text: true, file: true }; // Default true for legacy

    renderModal('act-sub', act.title, `
        <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded text-sm border">${instrHtml}</div>
            
            ${opts.text ? `
            <div class="border rounded p-2">
                <div class="flex gap-2 mb-2 border-b pb-2 bg-gray-50 p-1">
                    <button onclick="document.execCommand('bold',false,null)" class="font-bold border px-2 rounded bg-white">B</button>
                    <button onclick="document.execCommand('italic',false,null)" class="italic border px-2 rounded bg-white">I</button>
                    <button onclick="document.execCommand('underline',false,null)" class="underline border px-2 rounded bg-white">U</button>
                    <button class="border px-2 rounded bg-yellow-100 hover:bg-yellow-200 text-yellow-800" onclick="document.execCommand('hiliteColor',false,'yellow')"><i class="fas fa-highlighter"></i></button>
                    <button class="border px-2 rounded hover:bg-gray-100 text-gray-500" onclick="document.execCommand('removeFormat',false,null)" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
                </div>
                <div id="sub-editor" contenteditable="true" class="h-32 outline-none overflow-y-auto p-2 bg-white" placeholder="Type answer...">${sub.textAnswer || ''}</div>
            </div>` : ''}

            ${opts.file ? `<div><label class="text-xs font-bold text-gray-500">Attach File</label><input type="file" id="sub-file" class="w-full text-sm border p-1 rounded"></div>` : ''}
            
            ${sub.fileUrl?`<div class="text-xs text-green-600 font-bold"><i class="fas fa-check"></i> File previously uploaded</div>`:''}

            <button onclick="submitWork('${aid}')" class="btn-theme w-full text-white py-2 rounded font-bold">Submit Assignment</button>
            ${sub.score!==undefined ? `<div class="text-center font-bold text-xl text-green-600 mt-2 border-t pt-2">Grade: ${sub.score}/${act.maxScore}</div>` : ''}
        </div>
    `);
}
window.submitWork = (aid) => {
    const textEl = $('sub-editor');
    const text = textEl ? textEl.innerHTML : '';
    const fileInput = $('sub-file');
    const file = fileInput && fileInput.files[0];

    const save = (f) => {
        if(!db.activitySubmissions[aid]) db.activitySubmissions[aid] = {};
        const prev = db.activitySubmissions[aid][currentUser.id] || {};
        const prevData = (typeof prev === 'object') ? prev : { score: prev };
        
        db.activitySubmissions[aid][currentUser.id] = { 
            ...prevData, 
            textAnswer: text, 
            fileUrl: f ? f.data : (prevData.fileUrl || null), 
            fileName: f ? f.name : (prevData.fileName || null), 
            submittedAt: new Date().toISOString() 
        };
        saveDB(); closeModal('act-sub'); showToast('Submitted!');
    };

    if(file) { const r=new FileReader(); r.onload=e=>save({name:file.name, data:e.target.result}); r.readAsDataURL(file); } 
    else save(null);
}
window.viewStudentSubmission = (aid, uid) => {
    const act = db.activities[currentCourseId].find(a => a.id === aid);
    const stu = db.users.find(u => u.id === uid);
    const sub = db.activitySubmissions[aid]?.[uid];
    
    let subObj = { textAnswer: '', score: '' };
    if (sub && typeof sub === 'object') subObj = sub;
    else if (sub !== undefined) subObj = { score: sub };

    let html = `<div class="space-y-4">
        <div class="bg-gray-50 p-4 rounded border">
            <p class="text-xs font-bold text-gray-400 uppercase mb-2">Student Answer</p>
            <div class="text-gray-800 whitespace-pre-wrap">${subObj.textAnswer || '<span class="italic text-gray-400">No text answer.</span>'}</div>
            ${subObj.fileUrl ? `<div class="mt-4 border-t pt-2"><a href="${subObj.fileUrl}" download="${subObj.fileName||'file'}" class="text-theme underline font-bold"><i class="fas fa-download"></i> Download ${subObj.fileName}</a></div>` : ''}
        </div>
        <div class="bg-white p-4 rounded border border-blue-200 shadow-sm">
            <div class="flex gap-4 mb-3">
                <div class="flex-1"><label class="block text-xs font-bold text-gray-500">Score</label><input id="grade-score" type="number" class="w-full border p-2 rounded text-center" value="${subObj.score !== undefined ? subObj.score : ''}" max="${act.maxScore}"></div>
                <div class="flex-[3]"><label class="block text-xs font-bold text-gray-500">Feedback</label><input id="grade-comment" class="w-full border p-2 rounded" value="${subObj.teacherComment || ''}"></div>
            </div>
            <button onclick="saveGrade('${aid}', '${uid}')" class="w-full bg-green-600 text-white py-2 rounded font-bold">Save Grade</button>
        </div>
    </div>`;
    renderModal('grade-view', `Grading: ${stu.name}`, html);
}
window.saveGrade = (aid, uid) => {
    const s = $('grade-score').value, c = $('grade-comment').value;
    if(!db.activitySubmissions[aid]) db.activitySubmissions[aid] = {};
    const prev = db.activitySubmissions[aid][uid];
    const prevData = (typeof prev === 'object') ? prev : {};
    
    db.activitySubmissions[aid][uid] = { 
        ...prevData, 
        score: s===''?undefined:parseInt(s), 
        teacherComment: c 
    };
    saveDB(); closeModal('grade-view'); openActivityDetail(aid); showToast('Grade Saved');
}
window.deleteActivity = (aid) => { showConfirm('Delete?', () => { db.activities[currentCourseId] = db.activities[currentCourseId].filter(a => a.id !== aid); delete db.activitySubmissions[aid]; saveDB(); render(); }); }

// --- QUIZZES (DETAILED) ---
window.openCreateModal = (eid=null) => { 
    let ex = { title:'', openDate:'', dueDate:'', timeLimit:30, attempts:1, category:'ww' }, content='', title='New Assessment', btn='Create';
    if(eid) { ex=db.exams[currentCourseId].find(e=>e.id===eid); content=questionsToText(ex.questions); title='Edit Assessment'; btn='Save'; }
    
    renderModal('quiz', title, `
        <div class="space-y-3">
            <input id="q-title" class="w-full border p-2 rounded" placeholder="Title" value="${ex.title}">
            
            <!-- Category Selection -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assessment Type</label>
                <select id="q-cat" class="w-full border p-2 rounded bg-white">
                    <option value="ww" ${ex.category==='ww'?'selected':''}>Written Work (Quiz)</option>
                    <option value="qa" ${ex.category==='qa'?'selected':''}>Quarterly Assessment (Exam)</option>
                </select>
                <p class="text-xs text-gray-400 mt-1">"Written Work" counts towards WW grade. "Quarterly Assessment" counts towards QA grade.</p>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs font-bold text-gray-500">Open Date</label><input id="q-open" type="datetime-local" class="border p-2 w-full rounded" value="${ex.openDate}"></div>
                <div><label class="text-xs font-bold text-gray-500">Due Date</label><input id="q-due" type="datetime-local" class="border p-2 w-full rounded" value="${ex.dueDate}"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs font-bold text-gray-500">Time Limit (Mins)</label><input id="q-time" type="number" class="border p-2 w-full rounded" value="${ex.timeLimit}" placeholder="30"></div>
                <div><label class="text-xs font-bold text-gray-500">Allowed Attempts</label><input id="q-att" type="number" class="border p-2 w-full rounded" value="${ex.attempts}" placeholder="1"></div>
            </div>
            
            <div>
                <label class="text-xs font-bold text-gray-500">Questions (Text Format)</label>
                <textarea id="q-content" class="w-full border p-2 h-40 font-mono text-sm rounded" placeholder="1. What is 2+2?\nA. 3\nB. 4\nAnswer: B">${content}</textarea>
            </div>
            
            <button onclick="saveQuiz('${eid||''}')" class="btn-theme w-full text-white py-2 font-bold rounded shadow">${btn}</button>
        </div>
    `);
}

window.saveQuiz = async (eid) => {
    const t=$('q-title').value, cat=$('q-cat').value, o=$('q-open').value, d=$('q-due').value, time=$('q-time').value, att=$('q-att').value, content=$('q-content').value;
    
    if(t && o && d){
        const qs = parseQuizText(content);
        if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[];
        
        const data = { 
            id: eid || 'e'+Date.now(), 
            title: t, 
            category: cat,
            openDate: o, 
            dueDate: d, 
            timeLimit: parseInt(time) || 30, 
            attempts: parseInt(att) || 1, 
            questions: qs 
        };
        
        if(eid) { 
            const idx = db.exams[currentCourseId].findIndex(e => e.id === eid); 
            if(idx !== -1) db.exams[currentCourseId][idx] = data; 
        } else { 
            db.exams[currentCourseId].push(data); 
        }
        
        // Optimistic UI
        closeModal('quiz'); 
        render(); 
        showToast('Assessment Saved');
        
        // Background Save
        saveDB();
    } else {
        showToast('Please fill in required fields', 'error');
    }
}

window.openImportModal = () => { 
    renderModal('modal-import', 'Import Assessment (DOCX)', `
        <div class="space-y-4">
            <input type="file" id="docx-upload" accept=".docx" class="w-full border p-2 rounded">
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assessment Type</label>
                <select id="imp-cat" class="w-full border p-2 rounded bg-white">
                    <option value="ww">Written Work (Quiz)</option>
                    <option value="qa">Quarterly Assessment (Exam)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs font-bold text-gray-500">Open Date</label><input id="imp-open" type="datetime-local" class="border p-2 w-full rounded"></div>
                <div><label class="text-xs font-bold text-gray-500">Due Date</label><input id="imp-due" type="datetime-local" class="border p-2 w-full rounded"></div>
            </div>
            
            <button onclick="processDocxImport()" class="btn-theme w-full text-white py-2 font-bold rounded shadow">Import</button>
        </div>
    `); 
}

window.processDocxImport = () => { 
    const o=$('imp-open').value, d=$('imp-due').value, cat=$('imp-cat').value; 
    if(importedText && o && d) { 
        const q=parseQuizText(importedText); 
        if(q.length>0) { 
            if(!db.exams[currentCourseId]) db.exams[currentCourseId]=[]; 
            db.exams[currentCourseId].push({
                id: 'e'+Date.now(), 
                title: 'Imported ' + (cat==='qa'?'Exam':'Quiz'), 
                category: cat, // Save category
                openDate: o, 
                dueDate: d, 
                timeLimit: 30, 
                attempts: 1, 
                questions: q
            }); 
            saveDB(); 
            closeModal('modal-import'); 
            render(); 
            showToast('Imported Successfully'); 
        } else {
            showToast('No questions found in file', 'error');
        }
    } else {
        showToast('Please upload a file and set dates', 'error');
    }
}

document.addEventListener('change', async (e) => { if(e.target && e.target.id === 'docx-upload') { const reader = new FileReader(); reader.onload = function(evt) { mammoth.extractRawText({arrayBuffer: evt.target.result}).then(r => { importedText = r.value; showToast('File Parsed - Ready to Import'); }); }; reader.readAsArrayBuffer(e.target.files[0]); } });

window.startExam = (eid) => { activeExamId=eid; currentView='exam-take'; render(); }
window.reviewExam = (eid) => { activeExamId=eid; currentView='exam-review'; render(); }
window.deleteExam = (eid) => { showConfirm('Delete?', ()=>{ db.exams[currentCourseId]=db.exams[currentCourseId].filter(e=>e.id!==eid); delete db.examSubmissions[eid]; saveDB(); render(); }); }
window.renderExamTake = (c) => { 
    const ex=db.exams[currentCourseId].find(e=>e.id===activeExamId); 
    if(!ex) return goCourse(currentCourseId);
    let time=ex.timeLimit*60;
    c.innerHTML = `<div class="max-w-3xl mx-auto bg-white p-8 min-h-screen"><div class="flex justify-between border-b pb-4 mb-6 sticky top-0 bg-white shadow-sm z-10"><h2 class="text-2xl font-bold text-gray-800">${ex.title}</h2><div id="timer" class="text-xl font-mono text-red-600 font-bold bg-red-50 px-3 rounded border border-red-100"></div></div><div class="space-y-8">${ex.questions.map((q,i)=>`<div class="p-4 border rounded hover:shadow-sm transition"><p class="font-bold mb-3 text-lg text-gray-800">${i+1}. ${q.q}</p><div class="space-y-2">${q.options.map((o,oi)=>`<label class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded cursor-pointer border border-transparent hover:border-gray-200 transition"><input type="radio" name="q${i}" value="${oi}" class="w-4 h-4 text-blue-600"> <span class="text-gray-700">${o}</span></label>`).join('')}</div></div>`).join('')}</div><button onclick="submitExam()" class="mt-8 w-full btn-theme text-white py-4 rounded-lg font-bold text-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">Submit Assessment</button></div>`;
    
    // Clear any existing timer
    if(window.examTimer) clearInterval(window.examTimer);
    
    window.examTimer = setInterval(()=>{ 
        time--; 
        const m=Math.floor(time/60),s=time%60; 
        const timerEl = $('timer');
        if(timerEl) timerEl.innerText=`${m}:${s<10?'0':''}${s}`; 
        if(time<=0){ clearInterval(window.examTimer); submitExam(); } 
    }, 1000);
}

window.submitExam = () => {
    if(window.examTimer) clearInterval(window.examTimer);
    const ex=db.exams[currentCourseId].find(e=>e.id===activeExamId), ans=[]; let score=0;
    ex.questions.forEach((q,i)=>{ const s=document.querySelector(`input[name="q${i}"]:checked`); const v=s?parseInt(s.value):-1; ans.push(v); if(v===q.ans)score++; });
    const p=Math.round((score/ex.questions.length)*100);
    if(!db.examSubmissions[activeExamId]) db.examSubmissions[activeExamId]={};
    db.examSubmissions[activeExamId][currentUser.id] = { score:p, answers:ans, attemptsTaken:1, submittedAt: new Date().toISOString() }; 
    saveDB(); 
    showToast(`Submitted! Score: ${p}%`); 
    reviewExam(activeExamId);
}

window.renderExamReview = (c) => {
    const eid = activeExamId;
    const ex=db.exams[currentCourseId].find(e=>e.id===eid), sub=db.examSubmissions[eid][currentUser.id];
    
    // --- UPDATED EXIT BUTTON LOGIC ---
    // Instead of goCourse(id), we manually switch back to the quizzes tab
    c.innerHTML = `
        <div class="max-w-3xl mx-auto bg-white p-8 min-h-screen">
            <div class="border-b pb-4 mb-6 flex justify-between items-center sticky top-0 bg-white z-10">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">${ex.title} Results</h2>
                    <p class="text-xl font-bold text-theme mt-1">Score: ${sub.score}%</p>
                </div>
                <button onclick="currentView='course'; currentTab='quizzes'; render();" class="text-gray-500 font-bold hover:text-gray-800 px-4 py-2 hover:bg-gray-100 rounded transition">
                    <i class="fas fa-arrow-left mr-2"></i> Exit Review
                </button>
            </div>
            <div class="space-y-6">
                ${ex.questions.map((q,i)=>{ 
                    const user=sub.answers[i], correct=q.ans; 
                    const isCorrect = user===correct;
                    return `
                    <div class="p-4 border rounded-lg ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex gap-3">
                            <div class="flex-shrink-0 mt-1">
                                ${isCorrect ? '<i class="fas fa-check-circle text-green-600 text-xl"></i>' : '<i class="fas fa-times-circle text-red-500 text-xl"></i>'}
                            </div>
                            <div class="flex-1">
                                <p class="font-bold mb-3 text-gray-800">${i+1}. ${q.q}</p>
                                <div class="space-y-2">
                                    ${q.options.map((o,oi)=>`
                                        <div class="p-2 rounded ${oi===correct ? 'bg-green-100 text-green-800 font-bold border border-green-200' : (oi===user ? 'bg-red-100 text-red-800 font-bold border border-red-200' : 'text-gray-600')}">
                                            ${String.fromCharCode(65+oi)}. ${o} 
                                            ${oi===correct ? '<span class="ml-2 text-xs uppercase tracking-wider bg-green-200 px-1 rounded">Correct</span>' : ''}
                                            ${oi===user && oi!==correct ? '<span class="ml-2 text-xs uppercase tracking-wider bg-red-200 px-1 rounded">Your Answer</span>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>` 
                }).join('')}
            </div>
        </div>`;
}
window.reviewExamContent = (eid) => { const ex=db.exams[currentCourseId].find(e=>e.id===eid); renderModal('rev', ex.title, `<div class="space-y-4 max-h-[60vh] overflow-y-auto">${ex.questions.map((q,i)=>`<div class="p-3 border rounded"><p class="font-bold">${i+1}. ${q.q}</p><div class="ml-4 text-sm text-gray-600">${q.options.map((o,oi)=>`<div>${oi===q.ans?'*':''} ${o}</div>`).join('')}</div></div>`).join('')}</div>`); }

// --- UPDATED ANALYTICS WITH CHOICES & STUDENT NAMES ---
window.showItemAnalysis = (eid) => { 
    const ex = db.exams[currentCourseId].find(e => e.id === eid);
    const subs = db.examSubmissions[eid] || {};
    const total = Object.keys(subs).length;
    
    let html = `<div class="mb-4 font-bold text-gray-700 flex justify-between items-center">
        <span>Total Submissions: ${total}</span>
        <button onclick="closeModal('modal-analytics')" class="text-xs text-blue-500 hover:underline">Close</button>
    </div>
    <div class="space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">`;
    
    ex.questions.forEach((q, i) => {
        let correctList = [];
        let incorrectList = [];
        let optionCounts = new Array(q.options.length).fill(0); // Track counts per option
        
        // Sort students into lists based on their answer for this specific question
        Object.entries(subs).forEach(([uid, sub]) => {
            const student = db.users.find(u => u.id === uid);
            if (!student) return;
            
            const userAnswer = sub.answers ? sub.answers[i] : -1;
            
            // Count option usage
            if (userAnswer >= 0 && userAnswer < q.options.length) {
                optionCounts[userAnswer]++;
            }

            if (userAnswer === q.ans) {
                correctList.push(student.name);
            } else {
                incorrectList.push(student.name);
            }
        });
        
        const percent = total > 0 ? Math.round((correctList.length / total) * 100) : 0;
        const barColor = percent >= 75 ? 'bg-green-500' : (percent >= 50 ? 'bg-yellow-500' : 'bg-red-500');
        
        html += `
            <div class="border rounded-lg p-4 bg-white shadow-sm">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-800 text-sm mb-1 w-3/4">Q${i+1}. ${q.q}</h4>
                        <span class="text-xs font-bold px-2 py-1 rounded bg-gray-100">${percent}% Correct</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1 mb-3">
                        <div class="${barColor} h-1.5 rounded-full" style="width: ${percent}%"></div>
                    </div>

                    <!-- Choices Breakdown -->
                    <div class="space-y-1 mb-4">
                        ${q.options.map((opt, idx) => {
                            const isCorrect = idx === q.ans;
                            const count = optionCounts[idx];
                            const optPercent = total > 0 ? Math.round((count / total) * 100) : 0;
                            const bgClass = isCorrect ? 'bg-green-100 border-green-200' : 'bg-gray-50 border-gray-100';
                            const textClass = isCorrect ? 'text-green-800 font-bold' : 'text-gray-600';
                            
                            return `
                                <div class="flex items-center text-xs p-2 rounded border ${bgClass}">
                                    <div class="w-6 font-bold ${textClass}">${String.fromCharCode(65+idx)}</div>
                                    <div class="flex-1 ${textClass}">${opt} ${isCorrect ? '<i class="fas fa-check ml-1"></i>' : ''}</div>
                                    <div class="w-24 text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <span class="text-[10px] text-gray-500">${count} students</span>
                                            <span class="font-bold">${optPercent}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-blue-400 h-1 rounded-full" style="width: ${optPercent}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <!-- Correct Column -->
                    <div class="bg-green-50 rounded border border-green-100 p-2">
                        <div class="font-bold text-green-700 border-b border-green-200 pb-1 mb-2 flex justify-between">
                            <span>Correct Students</span>
                            <span class="bg-green-200 text-green-800 px-1.5 rounded-full">${correctList.length}</span>
                        </div>
                        <ul class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                            ${correctList.length > 0 
                                ? correctList.map(name => `<li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500 text-[10px]"></i> ${name}</li>`).join('') 
                                : '<li class="text-gray-400 italic pl-1">None</li>'}
                        </ul>
                    </div>
                    
                    <!-- Incorrect Column -->
                    <div class="bg-red-50 rounded border border-red-100 p-2">
                        <div class="font-bold text-red-700 border-b border-red-200 pb-1 mb-2 flex justify-between">
                            <span>Incorrect Students</span>
                            <span class="bg-red-200 text-red-800 px-1.5 rounded-full">${incorrectList.length}</span>
                        </div>
                        <ul class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                            ${incorrectList.length > 0 
                                ? incorrectList.map(name => `<li class="flex items-center gap-2"><i class="fas fa-times-circle text-red-500 text-[10px]"></i> ${name}</li>`).join('') 
                                : '<li class="text-gray-400 italic pl-1">None</li>'}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    renderModal('modal-analytics', 'Item Analysis: ' + ex.title, html);
}

window.openWeightsModal = () => { const s=db.subjects.find(x=>x.id===currentCourseId), w=s.gradingWeights; renderModal('w', 'Weights', `<div class="grid grid-cols-3 gap-2 mb-2"><input id="ww" value="${w.ww}" placeholder="WW"><input id="pt" value="${w.pt}" placeholder="PT"><input id="qa" value="${w.qa}" placeholder="QA"></div><button onclick="saveWeights()" class="btn-theme w-full text-white py-2 rounded">Save</button>`); }
window.saveWeights = () => { const ww=parseInt($('ww').value), pt=parseInt($('pt').value), qa=parseInt($('qa').value); if(ww+pt+qa!==100) return showToast('Total must be 100%','error'); const s=db.subjects.find(x=>x.id===currentCourseId); s.gradingWeights={ww,pt,qa}; saveDB(); closeModal('w'); render(); }
window.resetGrades = () => { showConfirm('Reset ALL grades?', () => { (db.activities[currentCourseId]||[]).forEach(a=>delete db.activitySubmissions[a.id]); (db.exams[currentCourseId]||[]).forEach(e=>delete db.examSubmissions[e.id]); saveDB(); render(); }); }
window.deleteGradeItem = (id, isExam) => {
    showConfirm('Delete this item? This action cannot be undone.', () => {
        if(isExam) {
            db.exams[currentCourseId] = db.exams[currentCourseId].filter(e => e.id !== id);
            delete db.examSubmissions[id];
        } else {
            db.activities[currentCourseId] = db.activities[currentCourseId].filter(a => a.id !== id);
            delete db.activitySubmissions[id];
        }
        saveDB();
        render();
        showToast('Item deleted');
    });
}

window.toggleModal = (id) => { if($(id)){ $(id).remove(); return; } }
window.closeModal = (id) => { const el = document.getElementById(id); if (el) el.remove(); } 
window.renderModal = (id,t,h) => { if($(id)) $(id).remove(); $('modal-portal').innerHTML=`<div id="${id}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-6 rounded w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">${t}</h3><button onclick="closeModal('${id}')"><i class="fas fa-times"></i></button></div>${h}</div></div>`; }

render();
</script>
</body>
</html>
